(self.webpackChunkcommerce_tester=self.webpackChunkcommerce_tester||[]).push([[3985],{3985:(ee,B,h)=>{h.r(B),h.d(B,{CommerceModule:()=>F,PriceCompareComponent:()=>M,PriceComponent:()=>L,ShopHandlerComponent:()=>Y,ShopTypeHandlerComponent:()=>H});var b=h(57863),C=h(17401),g=h(27022),x=h(67138),G=h(16602),R=h(92256);class S{constructor(){this.productName=null,this.outOfStock=!1}}class f{static toMoneyAmount(e){const n=new x.MoneyAmount;return n.amount=e.productPrice,n.currencyCode=e.currencyCode,n}constructor(e){this.http=e,this.onlineShopName="Unknown"}getOnlineShopName(){return this.onlineShopName}getShopTypeName(){return this.onlineShopName}requestWithProxy(e,n,o,r){return(0,R.firstValueFrom)(this.http.request(e,this.encodeUrlForCors(n,o),this.updateOptionsForCors(e,n,o,r)))}encodeUrlForCors(e,n){let o=e;switch(n){case m.CORSPROXY_IO:o=f.CORS_PROXY_URL+encodeURIComponent(e);break;case m.CHROME_ENGINE:case m.DONT_CODE:o=f.CORS_DONTCODE_PROXY_URL;break;case m.WEBSCRAPING_IA:o=f.WEBSCRAPING_PROXY_URL}return o}updateOptionsForCors(e,n,o,r){switch(o){case m.CORSPROXY_IO:r.withCredentials=!1;break;case m.CHROME_ENGINE:case m.DONT_CODE:this.addToHttpParams(r,{url:n}),o===m.CHROME_ENGINE&&this.addToHttpParams(r,{engine:"chrome"});break;case m.WEBSCRAPING_IA:this.addToHttpParams(r,{proxy:"datacenter",js:!1,api_key:f.WEBSCRAPING_PROXY_API_KEY,url:n})}return r}updatePrice(e,n){let o=e.productId;return null==n&&(n=!1),(n||null==o)&&(o=e.productName??void 0,n=!0),null==o?Promise.reject("You must define a product with a name or id "):this.searchProductsForNameOrId(o,!n).then(r=>{for(const s of r)if(s.productId==e.productId)return s;return null}).then(r=>null!=r||n||null==e.productName?r??Promise.reject("Product "+o+" not found in shoptype "+this.onlineShopName):this.searchProductsForNameOrId(e.productName,!1).then(s=>{for(const i of s)if(i.productId==e.productId)return i;return Promise.reject("Product "+o+" not found in shoptype "+this.onlineShopName)}))}standardHeaders(){return new G.HttpHeaders({})}checkScrappedProduct(e,n){if(null==n.productId||0==n.productId.length)throw new Error("Incorrect productId scrapped by shop "+this.getOnlineShopName()+" for product search"+e);if(null==n.productName||0==n.productName.length)throw new Error("Incorrect productName scrapped by shop "+this.getOnlineShopName()+" for product search"+e);if((null==n.productPrice||isNaN(n.productPrice))&&1!=n.outOfStock)throw new Error("Incorrect productPrice scrapped by shop "+this.getOnlineShopName()+" for product search"+e)}checkStringPosition(e,n){if(-1==e||-1!=n&&e>n)throw new Error("Error decoding product for Scrapper "+this.getOnlineShopName())}indexOf(e,n,o,r,s=!0){const i=e.indexOf(n,o);return-1==i?i:null!=r&&-1!=r&&i>r?-1:s?i+n.length:i}safeIndexOf(e,n,o,r,s=!0){const i=e.indexOf(n,o);if(-1==i)throw new Error("Cannot find "+n+" for "+this.getOnlineShopName());if(null!=r&&-1!=r&&i>r)throw new Error("The product content does not contains "+n+" for "+this.getOnlineShopName());return s?i+n.length:i}addToHttpParams(e,n){e.params=null==e.params?n:null!=e.params.appendAll?e.params.appendAll(n):{...e.params,...n}}}f.CORS_PROXY_URL="https://corsproxy.io/?",f.WEBSCRAPING_PROXY_URL="https://api.webscraping.ai/html",f.WEBSCRAPING_PROXY_API_KEY="f4fe0d0b-bfa9-49bd-a3f7-404be7bcad85",f.CORS_DONTCODE_PROXY_URL="https://shared.collin.best/proxy/debug";var m=(()=>{return(c=m||(m={})).CORSPROXY_IO="CORSPROXY.IO",c.WEBSCRAPING_IA="WEBSCRAPING.IA",c.DONT_CODE="DONT-CODE.PROXY",c.CHROME_ENGINE="DONT-CODE.CHROME",m;var c})(),t=h(30549),y=h(15861);class U extends f{constructor(e){super(e),this.onlineShopName="EasyParapharmacie"}searchProductsForNameOrId(e,n){let o=JSON.stringify(U.JSON_QUERY);return o=o.replace("QUERY_STRING",encodeURIComponent(e)),o=JSON.parse(o),this.requestWithProxy("POST",U.SEARCH_ONLINE_URL,m.DONT_CODE,{body:o,responseType:"json",observe:"body"}).then(r=>{"string"==typeof r&&(r=JSON.parse(r));const s=new Array,i=r.results;if(i.length>0){const d=i[0].hits;if(null!=d)for(const a of d){const l=new S;l.productPrice=a.price.EUR.default,l.currencyCode="EUR",l.productName=a.name,l.productDescription=a.short_description??a.description,l.productId=a.ean_code?.toString(),null==l.productId&&(console.warn("Product "+l.productName+" searched by "+e+" for Shop "+this.getOnlineShopName()+" has no ean_code, getting objectId instead"),l.productId=a.objectID),l.productUrl=a.url,l.productImageUrl=a.image_url,this.checkScrappedProduct(e,l),s.push(l)}}return s})}}U.SEARCH_ONLINE_URL="https://jhu6zvksfy-dsn.algolia.net/1/indexes/*/queries?x-algolia-agent=Algolia+for+JavaScript+%283.35.1%29%3B+Browser%3B+Magento2+integration+%283.6.0%29%3B+autocomplete.js+0.38.0&x-algolia-application-id=JHU6ZVKSFY&x-algolia-api-key=YTYyYzkyNzgyZDliZTZlMDk1OGE1MDQwNjRkYWY1ZmY4ZTE5OWZhYmU4ZGUyNTM2NDFjNmU4YjllNWMwNmJmNXRhZ0ZpbHRlcnM9\n",U.JSON_QUERY={requests:[{indexName:"prod_magento2_fr_products",params:"query=QUERY_STRING&hitsPerPage=6&analyticsTags=autocomplete&clickAnalytics=true&facets=%5B%22categories.level0%22%5D&numericFilters=visibility_search%3D1&ruleContexts=%5B%22magento_filters%22%2C%22%22%5D"},{indexName:"prod_magento2_fr_section_manufacturer",params:"query=chardon%20marie&hitsPerPage=6&analyticsTags=autocomplete&clickAnalytics=true"},{indexName:"prod_magento2_fr_categories",params:"query=chardon%20marie&hitsPerPage=4&analyticsTags=autocomplete&clickAnalytics=true&numericFilters=include_in_menu%3D1"}]};class v extends f{constructor(e){super(e),this.onlineShopName="GreenWeez"}searchProductsForNameOrId(e,n){let o=JSON.stringify(v.JSON_QUERY);return o=o.replace("QUERY_STRING",encodeURIComponent(e)),o=o.replace("QUERY_STRING",encodeURIComponent(e)),o=o.replace("QUERY_STRING",encodeURIComponent(e)),o=JSON.parse(o),this.requestWithProxy("POST",v.SEARCH_ONLINE_URL,m.DONT_CODE,{body:o,responseType:"json",observe:"body"}).then(r=>{"string"==typeof r&&(r=JSON.parse(r));const s=new Array,i=r.results;if(i.length>0){const d=i[0].hits;if(null!=d)for(const a of d){const l=new S;l.productPrice=a.shop_data.pricing.priceIncludedVat/100,l.currencyCode="EUR",l.productName=a.name,l.productDescription=void 0,l.productId=a.shop_data.variant.code,l.productUrl=this.calculateProductUrl(a.shop_data),l.productImageUrl=this.findImageUrl(a.shop_data.variant.images),l.marketPlace=!0===a.flags.marketPlace,this.checkScrappedProduct(e,l),s.push(l)}}return s})}calculateProductUrl(e){return v.BASE_URL+"/produit/"+e.variant.product.slug+"/"+e.variant.code+"/"+e.id}findImageUrl(e){for(const n of e)if("variant"==n.type)return v.BASE_URL+"/_next/image?url=https%3A%2F%2Fcdn.greenweez.com%2Fproducts%2F"+n.path+"&w=640&q=75"}}v.SEARCH_ONLINE_URL="https://54m7x8foua-dsn.algolia.net/1/indexes/*/queries?x-algolia-agent=Algolia for JavaScript (4.14.2); Browser (lite); instantsearch.js (4.48.0); react (17.0.2); react-instantsearch (6.36.0); react-instantsearch-hooks (6.36.0); JS Helper (3.11.1)&x-algolia-api-key=52441d0a775f924291679b7c224d6782&x-algolia-application-id=54M7X8FOUA",v.BASE_URL="https://greenweez.com",v.JSON_QUERY={requests:[{indexName:"france_prod_offers_genepi_fr_FR",params:"attributesToRetrieve=%5B%22main_category%22%2C%22attributes%22%2C%22capacity%22%2C%22discount.percent%22%2C%22flags%22%2C%22ObjectID%22%2C%22name%22%2C%22options.color.available_colors%22%2C%22seller%22%2C%22shop_data.id%22%2C%22shop_data.variant.images%22%2C%22shop_data.variant.product.id%22%2C%22shop_data.variant.product.legacyId%22%2C%22shop_data.variant.product.slug%22%2C%22shop_data.variant.product.brand.name%22%2C%22shop_data.variant.code%22%2C%22shop_data.sellerCatalog.seller%22%2C%22shop_data.pricing%22%2C%22shop_data.offerData%22%2C%22shop_data.onHand%22%2C%22stats%22%5D&clickAnalytics=true&facets=%5B%5D&filters=has_parent_objectID%3D0&highlightPostTag=__%2Fais-highlight__&highlightPreTag=__ais-highlight__&hitsPerPage=20&query=QUERY_STRING&tagFilters="},{indexName:"france_prod_brands_genepi_fr_FR",params:"attributesToRetrieve=%5B%22name%22%2C%22slug%22%5D&clickAnalytics=true&facets=%5B%5D&filters=&highlightPostTag=__%2Fais-highlight__&highlightPreTag=__ais-highlight__&hitsPerPage=6&query=QUERY_STRING&tagFilters="},{indexName:"france_prod_categories_genepi_fr_FR",params:"attributesToRetrieve=%5B%22parent%22%2C%22name%22%2C%22slug%22%2C%22level%22%5D&clickAnalytics=true&facets=%5B%5D&filters=&highlightPostTag=__%2Fais-highlight__&highlightPreTag=__ais-highlight__&hitsPerPage=6&query=QUERY_STRING&tagFilters="}]};class Q{getConfiguration(){return{plugin:{id:"CommercePlugin","display-name":"Commerce Plugin for anything related to products, prices, shops.",version:"1.0.0"},"schema-updates":[{id:"price-field",description:"A price of a product in a shop",changes:[{location:{parent:"#/$defs/field",id:"type"},update:{enum:[{Commerce:{enum:["Price","Shop","Shop type"]}}]},replace:!1}]}],"preview-handlers":[{location:{parent:x.DontCodeModel.APP_FIELDS,id:"type",values:[{Commerce:{enum:["Price"]}}]},class:{name:"PriceComponent",source:"commerce"}},{location:{parent:x.DontCodeModel.APP_FIELDS,id:"type",values:[{Commerce:{enum:["Shop"]}}]},class:{name:"ShopHandlerComponent",source:"commerce"}},{location:{parent:x.DontCodeModel.APP_FIELDS,id:"type",values:[{Commerce:{enum:["Shop type"]}}]},class:{name:"ShopTypeHandlerComponent",source:"commerce"}}]}}pluginInit(e){}}Q.SHOP_ENTITY_NAME="Online Shop";class D extends f{constructor(e){super(e),this.onlineShopName="NewPharma"}searchProductsForNameOrId(e,n){const o=D.SEARCH_ONLINE_URL.replace("QUERY_STRING",encodeURIComponent(e)),r=this.standardHeaders();return this.requestWithProxy("GET",o,m.CHROME_ENGINE,{headers:r,withCredentials:!1,responseType:"text",observe:"body"}).then(s=>{const i=new Array;let d=s.indexOf(D.PRODUCT_START_STRING);for(;d>=0;){const a=new S;let l=s.indexOf('data-productid="',d)+16;a.productId=s.substring(l,s.indexOf('"',l+1)),l=s.indexOf('<a class="details__title',d)+24,l=s.indexOf('title="',l+1)+7,a.productName=s.substring(l,s.indexOf('"',l+1)),a.productDescription=void 0,l=s.indexOf('href="',d)+6,a.productUrl=s.substring(l,s.indexOf('"',l+1)),l=s.indexOf('<img src="',d+1)+10,a.productImageUrl=s.substring(l,s.indexOf('"',l+1)),this.extractPrice(s,d,a),this.checkScrappedProduct(e,a),i.push(a),d=s.indexOf(D.PRODUCT_START_STRING,d+1)}return i})}extractPrice(e,n,o){let r=e.indexOf('data-content_ids="['+o.productId+']"',n+1);if(-1==r&&(r=e.indexOf('data-content_ids="'+o.productId+'"',n+1)),-1!=r){let s=e.indexOf('data-currency="',r)+15;o.currencyCode=e.substring(s,e.indexOf('"',s+1)),s=e.indexOf('data-value="',r)+12,o.productPrice=parseFloat(e.substring(s,e.indexOf('"',s+1)))}}updatePrice(e,n){return null==e.productUrl?super.updatePrice(e,!0):this.requestWithProxy("GET",e.productUrl,m.CHROME_ENGINE,{headers:{Accept:"text/html"},withCredentials:!1,responseType:"text",observe:"body"}).then(o=>{const r={productId:e.productId,productName:e.productName};return this.extractPrice(o,0,r),this.checkScrappedProduct(e.productName??"",r),e.productPrice=r.productPrice,e.currencyCode=r.currencyCode,e}).catch(o=>(console.error("Error trying to access page for product "+e.productName,o),super.updatePrice(e,!0)))}}D.SEARCH_ONLINE_URL="https://www.newpharma.fr/search-results/search.html?q=QUERY_STRING",D.PRODUCT_START_STRING='<div class="product js-product-row product--desktop';class A extends f{constructor(e){super(e),this.onlineShopName="WebEcologie"}searchProductsForNameOrId(e,n){const o=A.SEARCH_ONLINE_URL.replace("QUERY_STRING",encodeURIComponent(e));return this.requestWithProxy("GET",o,m.DONT_CODE,{headers:{Accept:"text/html"},responseType:"text",observe:"body"}).then(r=>{const s=new Array;let i=r.indexOf(A.PRODUCT_START_STRING);for(;i>=0;){const d=new S;let a=r.indexOf('href="',i)+6;d.productUrl=r.substring(a,r.indexOf('"',a+1)),a=r.indexOf('title="',i)+7,d.productName=r.substring(a,r.indexOf('"',a+1)),d.productDescription=void 0,a=r.indexOf('src="',i+1)+5,d.productImageUrl=r.substring(a,r.indexOf('"',a+1));const l=r.indexOf('<a class="addToWishlist',i)+23;a=r.indexOf('rel="',l)+5,d.productId=r.substring(a,r.indexOf('"',a+1)),this.extractPrice(r,i,d),this.checkScrappedProduct(e,d),s.push(d),i=r.indexOf(A.PRODUCT_START_STRING,i+1)}return s})}extractPrice(e,n,o){let r=e.indexOf('class="price-first-part">',n)+25,s=Number.parseInt(e.substring(r,e.indexOf("<",r+1)));r=e.indexOf('class="price-last-part">',n)+24,s+=Number.parseInt(e.substring(r,e.indexOf("<",r+1)))/100,o.productPrice=s,r=e.indexOf('itemprop="priceCurrency"',n)+24,r=e.indexOf('content="',r)+9,o.currencyCode=e.substring(r,e.indexOf('"',r+1))}updatePrice(e,n){return null==e.productUrl?super.updatePrice(e,!0):this.requestWithProxy("GET",e.productUrl,m.DONT_CODE,{headers:{Accept:"text/html"},responseType:"text",observe:"body"}).then(o=>{const r={productId:e.productId,productName:e.productName};return this.extractPrice(o,0,r),this.checkScrappedProduct(e.productName??"Unknown",r),e.productPrice=r.productPrice,e.currencyCode=r.currencyCode,e}).catch(o=>(console.error("Error trying to access page for product "+e.productName,o),super.updatePrice(e,!0)))}}A.SEARCH_ONLINE_URL="https://www.webecologie.com/rechercher?search_query=QUERY_STRING",A.PRODUCT_START_STRING='<a class="product_img_link"';class w extends f{constructor(e){super(e),this.onlineShopName="Boulanger"}searchProductsForNameOrId(e,n){e=e.normalize("NFD").replace(/\p{Diacritic}/gu,"");const o=w.SEARCH_ONLINE_URL.replace("QUERY_STRING",e);return this.requestWithProxy("GET",o,m.DONT_CODE,{observe:"body",responseType:"text"}).then(r=>this.analysePageResult(e,r)).catch(r=>null==r.code||"Unknown Error"===r.statusText?this.requestWithProxy("GET",o,m.WEBSCRAPING_IA,{observe:"body",responseType:"text"}).then(s=>this.analysePageResult(e,s)):r)}analysePageResult(e,n){const o=new Array;let r=n.indexOf(w.PRODUCT_START_STRING);for(;r>=0;){const s=new S;let i=n.indexOf('href="',r)+6;s.productUrl=w.BASE_URL+n.substring(i,n.indexOf('"',i+1)),i=n.indexOf('data-product-label="',r)+20,s.productName=n.substring(i,n.indexOf('"',i+1)),s.productDescription=void 0,i=n.indexOf('<img src="',r+1)+10,s.productImageUrl=n.substring(i,n.indexOf('"',i+1)),i=n.indexOf('data-product-id="',r)+17,s.productId=n.substring(i,n.indexOf('"',i+1)),this.extractPrice(n,r,s),this.checkScrappedProduct(e,s),o.push(s),r=n.indexOf(w.PRODUCT_START_STRING,r+1)}return o}extractPrice(e,n,o){const r=e.indexOf('data-analytics_product_unitprice_ati="',n)+38,s=Number.parseFloat(e.substring(r,e.indexOf('"',r+1)));o.productPrice=s,o.currencyCode="EUR"}}w.SEARCH_ONLINE_URL="https://www.boulanger.com/resultats?tr=QUERY_STRING",w.PRODUCT_START_STRING="<article",w.BASE_URL="https://www.boulanger.com";class T extends f{constructor(e){super(e),this.onlineShopName="Darty",this.httpHeaders={"x-algolia-api-key":"740b60dee22b6ca679462288f6cd9c7b","x-algolia-application-id":"Z0YPI1PLPQ"}}searchProductsForNameOrId(e,n){let o=JSON.stringify(T.JSON_QUERY);return o=o.replace("QUERY_STRING",e),o=o.replace("QUERY_STRING",e),o=JSON.parse(o),this.requestWithProxy("POST",T.SEARCH_ONLINE_URL,m.DONT_CODE,{body:o,headers:this.httpHeaders,responseType:"json",observe:"body"}).then(r=>{"string"==typeof r&&(r=JSON.parse(r));const s=new Array,i=r.results;if(i.length>0){const d=i[0].hits;if(null!=d)for(const a of d){const l=new S;l.productPrice=this.extractPrice(a),l.currencyCode="EUR",l.productName=a.reference,l.productDescription=void 0,l.productId=a.codic,l.productUrl=T.BASE_URL+"/nav/codic/"+a.codic,a.pictures?.length>0&&(l.productImageUrl=T.BASE_IMAGE_URL.replace("IMAGE_URL",a.pictures[0].algoliaPict)),this.checkScrappedProduct(e,l),s.push(l)}}return s})}updatePrice(e,n){return super.updatePrice(e,!0)}extractPrice(e){if(null!=e.priceSort)return e.priceSort/100;if(null!=e.dartyExclusivePriceSort)return e.dartyExclusivePriceSort/100;let n=0;for(const o in e.prices.stores)("000000"===o||"dartyExclusive"===o&&0===n||0===n)&&(n=e.prices.stores[o]/100);return n}}T.SEARCH_ONLINE_URL="https://z0ypi1plpq-dsn.algolia.net/1/indexes/*/queries?x-algolia-agent=Algolia+for+JavaScript+%284.17.0%29%3B+Browser",T.JSON_QUERY={requests:[{indexName:"darty_prod_es6",query:"QUERY_STRING",params:"hitsPerPage=4&tagFilters=%5B%22dcom%22%5D"},{indexName:"darty_prod_es6_query_suggestions",query:"QUERY_STRING",params:"hitsPerPage=5"}]},T.BASE_URL="https://www.darty.com",T.BASE_IMAGE_URL="https://image.darty.com/darty?type=image&source=IMAGE_URL&width=120&heigth=180&quality=80";class I extends f{constructor(e){super(e),this.onlineShopName="CDiscount"}searchProductsForNameOrId(e,n){const o=e.split(" ");let r="";for(const i of o)r+=encodeURIComponent(i)+"+";o.length>=1&&(r=r.substring(0,r.length-1));const s=I.SEARCH_ONLINE_URL.replace("QUERY_STRING",r);return this.requestWithProxy("GET",s,m.CORSPROXY_IO,{headers:{Accept:"text/html"},responseType:"text",observe:"body"}).then(i=>{const d=new Array;let a=i.indexOf(I.PRODUCT_START_STRING);for(a=i.indexOf(I.PRODUCT_START_STRING,a+1);a>=0;){const l=i.indexOf(I.PRODUCT_START_STRING,a+1),u=new S;let p=this.safeIndexOf(i,'href="',a,l);u.productUrl=i.substring(p,this.safeIndexOf(i,'"',p+1,l,!1)),p=this.indexOf(i,'<h2 class="prdtTit">',a,l),-1==p&&(p=this.indexOf(i,'<h2 class="prdtBILTit">',a,l)),u.productName=i.substring(p,this.safeIndexOf(i,"</h2>",p+1,l,!1)),u.productDescription=void 0,p=this.safeIndexOf(i,'src="',a+1,l),u.productImageUrl=i.substring(p,this.safeIndexOf(i,'"',p+1,l,!1)),p=this.safeIndexOf(i,'data-productid="',a,l),u.productId=i.substring(p,this.safeIndexOf(i,'"',p+1,l,!1)),this.extractPrice(i,a,l,u),this.checkScrappedProduct(e,u),d.push(u),a=i.indexOf(I.PRODUCT_START_STRING,a+1)}return d})}extractPrice(e,n,o,r){let s=this.indexOf(e,'<span class="price priceColor hideFromPro">',n,o);if(-1!=s){const i=this.safeIndexOf(e,",",s+1,o,!1),d=Number.parseInt(e.substring(s,i)),a=Number.parseInt(e.substring(i+1,this.safeIndexOf(e,"&euro;",i+1,o,!1)));r.productPrice=d+a/100}else{s=this.safeIndexOf(e,'<span class="hideFromPro priceColor price">',n,o);const i=Number.parseInt(e.substring(s,this.safeIndexOf(e,"<sup>",s+1,o,!1))),d=Number.parseInt(e.substring(this.safeIndexOf(e,"</sup>",s+1,o,!1)-2,this.safeIndexOf(e,"</sup>",s+1,o,!1)));r.productPrice=i+d/100}r.currencyCode="EUR"}}I.SEARCH_ONLINE_URL="https://www.cdiscount.com/search/10/QUERY_STRING.html",I.PRODUCT_START_STRING='<li data-sku="',I.BASE_URL="https://www.cdiscount.com";class P extends f{constructor(e){super(e),this.onlineShopName="Amazon"}searchProductsForNameOrId(e,n){const o=P.SEARCH_ONLINE_URL.replace("QUERY_STRING",encodeURIComponent(e));return this.requestWithProxy("GET",o,m.DONT_CODE,{headers:{Accept:"text/html"},responseType:"text",observe:"body"}).catch(r=>(console.error("Error getting amazon price with DontCode Proxy",r),null!=r.status&&r.status>=500?this.requestWithProxy("GET",o,m.CORSPROXY_IO,{headers:{Accept:"text/html"},responseType:"text",observe:"body"}):Promise.reject(r))).catch(r=>(console.error("Error getting amazon price with CorsProxyIO",r),null!=r.status&&r.status>=500?this.requestWithProxy("GET",o,m.WEBSCRAPING_IA,{headers:{Accept:"text/html"},responseType:"text",observe:"body"}):Promise.reject(r))).then(r=>{const s=new Array;let i=r.indexOf(P.PRODUCT_START_STRING);for(;i>=0;){const d=r.indexOf(P.PRODUCT_START_STRING,i+1),a=r.substring(i,d),l=new S,u=a.indexOf('data-component-type="s-product-image"');let p=a.indexOf('data-asin="')+11;if('"'==a.charAt(p)||-1==u){i=r.indexOf(P.PRODUCT_START_STRING,i+1);continue}l.productId=a.substring(p,a.indexOf('"',p+1)),p=a.indexOf('href="',u)+6;let _=a.substring(p,a.indexOf('"',p+1));if(_.startsWith("/sspa/click")){const He=_.indexOf("url=")+4;_=_.substring(He),_=_.replace(/%2F/g,"/")}l.productUrl=P.BASE_URL+_,p=a.indexOf('src="',u+1)+5,l.productImageUrl=a.substring(p,a.indexOf('"',p+1)),p=a.indexOf('a-text-normal">',u)+15,l.productDescription=a.substring(p,a.indexOf("<",p+1)),l.productName=null!=l.productDescription&&l.productDescription?.length>60?l.productDescription.substring(0,60):l.productDescription||null,p=a.indexOf('data-asin="')+11,l.productId=a.substring(p,a.indexOf('"',p+1)),this.extractPrice(a,u,l),this.checkScrappedProduct(e,l),s.push(l),i=a.indexOf(P.PRODUCT_START_STRING,i+1)}return s})}extractPrice(e,n,o){const r=e.indexOf('<span class="a-price-whole">',n)+28;let s=e.substring(r,e.indexOf("</span>",r+1));s=s.replace(",","."),o.productPrice=Number.parseFloat(s),o.currencyCode="EUR"}}P.SEARCH_ONLINE_URL="https://www.amazon.fr/s?k=QUERY_STRING",P.PRODUCT_START_STRING='<div data-asin="',P.BASE_URL="https://www.amazon.fr";class N extends f{constructor(){super(...arguments),this.onlineShopName="Fnac"}searchProductsForNameOrId(e,n){const o=e.split(" ");let r="";for(const i of o)r+=encodeURIComponent(i)+"+";o.length>=1&&(r=r.substring(0,r.length-1));const s=N.SEARCH_ONLINE_URL.replace("QUERY_STRING",r);return this.requestWithProxy("GET",s,m.DONT_CODE,{headers:{Accept:"text/html"},responseType:"text",observe:"body",withCredentials:!0}).then(i=>{const d=new Array;let a=i.indexOf(N.PRODUCT_START_STRING),l=i.indexOf(N.PRODUCT_START_STRING,a+1);for(;a>=0;){const u=new S;let p=this.safeIndexOf(i,'id="',a,l);u.productId=i.substring(p,i.indexOf('"',p+1));let _=this.safeIndexOf(i,'<img class="Article-itemVisualImg',a,l);p=this.indexOf(i,'data-lazyimage="',_),-1==p&&(p=this.safeIndexOf(i,'src="',_,l)),u.productImageUrl=i.substring(p,i.indexOf('"',p+1)),p=this.safeIndexOf(i,'alt="',_,l),u.productName=i.substring(p,i.indexOf('"',p+1)),u.productDescription=void 0,_=this.safeIndexOf(i,'<p class="Article-desc',a,l),p=this.safeIndexOf(i,'href="',_,l),u.productUrl=i.substring(p,i.indexOf('"',p+1)),p=i.indexOf("vendeur partenaire",a),u.marketPlace=-1!=p&&(-1==l||p<l),p=i.indexOf("En stock",a),u.outOfStock=-1==p||!(-1==l||p<l),this.extractPrice(i,a,u,l),null==u.productPrice&&(u.outOfStock=!0),this.checkScrappedProduct(e,u),d.push(u),a=i.indexOf(N.PRODUCT_START_STRING,a+1),l=i.indexOf(N.PRODUCT_START_STRING,a+1)}return d})}extractPrice(e,n,o,r){const s=this.indexOf(e,'class="userPrice">',n,r);if(-1==s)return void(o.productPrice=void 0);const i=this.indexOf(e,"<sup>",s+1,r,!1);let d=0;if(-1==i)d=Number.parseInt(e.substring(s,this.safeIndexOf(e,"&euro;",s+1,r,!1))),o.productPrice=d;else{d=Number.parseInt(e.substring(s,i));const a=Number.parseInt(e.substring(this.safeIndexOf(e,"</sup>",s+1,r,!1)-2,this.safeIndexOf(e,"</sup>",s+1,r)));o.productPrice=d+a/100}o.currencyCode="EUR"}updatePrice(e,n){return null==e.productUrl?super.updatePrice(e,!0):this.requestWithProxy("GET",e.productUrl,m.DONT_CODE,{headers:{Accept:"text/html"},responseType:"text",observe:"body"}).then(o=>{const r={productId:e.productId,productName:e.productName},s=this.safeIndexOf(o,"userPrice",0),i=this.safeIndexOf(o,'data-price="',s);return r.productPrice=Number.parseFloat(o.substring(i,this.safeIndexOf(o,'"',i+1)).replace(",",".")),r.currencyCode="EUR",this.checkScrappedProduct(e.productName??"",r),e.productPrice=r.productPrice,e.currencyCode=r.currencyCode,e}).catch(o=>(console.error("Error trying to access page for product "+e.productName,o),super.updatePrice(e,!0)))}}N.SEARCH_ONLINE_URL="https://www.fnac.com/SearchResult/ResultList.aspx?SCat=0&Search=QUERY_STRING&sft=1&sa=0",N.PRODUCT_START_STRING='<div class="clearfix Article-item',N.BASE_URL="https://www.fnac.com";class O extends f{constructor(e){super(e),this.onlineShopName="Onatera"}searchProductsForNameOrId(e,n){let o=JSON.stringify(O.JSON_QUERY);return o=o.replace(/QUERY_STRING/g,encodeURIComponent(e)),o=JSON.parse(o),this.requestWithProxy("POST",O.SEARCH_ONLINE_URL,m.DONT_CODE,{body:o,responseType:"json",observe:"body"}).then(r=>{"string"==typeof r&&(r=JSON.parse(r));const s=new Array,i=r.results;if(i.length>0)for(const d of i){const a=d.hits;if(null!=a)for(const l of a)if(1==l.is_active){const u=l.name+" "+l.brand_name+" ";if(null!=l.variants)for(const p of l.variants){const _=new S;_.productPrice=p.price/100,_.outOfStock=!p.hasStock,_.currencyCode="EUR",_.productName=u+p.name,_.productDescription=p.shortDescription??p.description,_.productId=p.productVariantId.toString(),_.productUrl=O.BASE_URL+p.url,_.productImageUrl=O.IMAGE_BASE_URL+p.picture_path,this.checkScrappedProduct(e,_),s.push(_)}}}return s})}}O.SEARCH_ONLINE_URL="https://f75bb6q2sy-dsn.algolia.net/1/indexes/*/queries?x-algolia-agent=Algolia+for+JavaScript+%284.11.0%29%3B+Browser+%28lite%29%3B+instantsearch.js+%284.41.0%29%3B+Vue+%282.6.14%29%3B+Vue+InstantSearch+%284.3.3%29%3B+JS+Helper+%283.8.2%29&x-algolia-api-key=f319f4e4b15d239ba0509b3c6c4a0ecd&x-algolia-application-id=F75BB6Q2SY",O.BASE_URL="https://onatera.com",O.IMAGE_BASE_URL="https://media.onatera.com/cache/product_image_listing_DM/",O.JSON_QUERY={requests:[{indexName:"intl.product.fr.fr",params:"clickAnalytics=true&facets=%5B%5D&hitsPerPage=0&query=QUERY_STRING&tagFilters=&userToken=anonymous_09f81bae3a73d5bcb1582423816110b7"},{indexName:"intl.product.fr.fr",params:"clickAnalytics=true&facets=%5B%5D&highlightPostTag=__%2Fais-highlight__&highlightPreTag=__ais-highlight__&hitsPerPage=6&query=QUERY_STRING&tagFilters=&userToken=anonymous_09f81bae3a73d5bcb1582423816110b7"},{indexName:"intl.category.fr.fr",params:"clickAnalytics=true&facets=%5B%5D&highlightPostTag=__%2Fais-highlight__&highlightPreTag=__ais-highlight__&hitsPerPage=3&numericFilters=ref_count%20%3E%200&query=QUERY_STRING&tagFilters=&userToken=anonymous_09f81bae3a73d5bcb1582423816110b7"},{indexName:"intl.brand.fr.fr",params:"clickAnalytics=true&facets=%5B%5D&highlightPostTag=__%2Fais-highlight__&highlightPreTag=__ais-highlight__&hitsPerPage=3&numericFilters=product_count%20%3E%200&query=QUERY_STRING&tagFilters=&userToken=anonymous_09f81bae3a73d5bcb1582423816110b7"},{indexName:"intl.active.fr.fr",params:"clickAnalytics=true&facets=%5B%5D&highlightPostTag=__%2Fais-highlight__&highlightPreTag=__ais-highlight__&hitsPerPage=3&numericFilters=product_count%20%3E%200&query=QUERY_STRING&tagFilters=&userToken=anonymous_09f81bae3a73d5bcb1582423816110b7"},{indexName:"intl.content.for_recipes.fr.fr",params:"clickAnalytics=true&facetFilters=%5B%22type%3Adiy%22%5D&facets=%5B%5D&highlightPostTag=__%2Fais-highlight__&highlightPreTag=__ais-highlight__&hitsPerPage=3&query=QUERY_STRING&tagFilters=&userToken=anonymous_09f81bae3a73d5bcb1582423816110b7"}]};class k extends f{constructor(e){super(e),this.onlineShopName="Maxicoffee"}searchProductsForNameOrId(e,n){let o=JSON.stringify(k.JSON_QUERY);return o=o.replace("QUERY_STRING",e),o=JSON.parse(o),this.requestWithProxy("POST",k.SEARCH_ONLINE_URL,m.DONT_CODE,{body:o,responseType:"json",observe:"body"}).then(r=>{"string"==typeof r&&(r=JSON.parse(r));const s=new Array,i=r.data.items.p;if(i.length>0)for(const d of i){const a=new S;a.productPrice=d.prcn,a.currencyCode="EUR",a.productName=d.ttl,a.productDescription=void 0,a.productId=d.id,a.productUrl=d.lnk,a.productImageUrl=d.img,a.outOfStock="in stock"===d.avl,this.checkScrappedProduct(e,a),s.push(a)}return s})}}k.SEARCH_ONLINE_URL="https://na.search.sensefuel.live/searchf/4147d2a1-7a21-4697-8a4c-0e25183f3ce9",k.JSON_QUERY={acp:{},suggest:{},key:"1678529428523-0-AskResult",parentKey:null,terms:{expression:"QUERY_STRING",inputSource:"keyboard",intentDetection:{}},trackFingerPrint:{tracks:[],environmentId:"333"},items:{from:0,size:30,bypassSpellcheck:!1},prefixQuery:{},filters:{},scopes:[],spotlights:[],sort:null,needShortcuts:!0,userIds:{id:null,previousId:null,custId:null,isAuthenticated:!1},sellerId:"France m\xe9tropolitaine",kickerContents:{size:6},contents:{from:0,size:30,playOnIntent:["nlu|content"]},references:{size:32}};class E{constructor(e,n,o){this.httpClient=e,this.modelMgr=n,this.storeMgr=o,this.listOfScrappers=new Map,this.shopTypeNames=new Array,null==this.modelMgr&&(this.modelMgr=x.dtcde.getModelManager()),null==this.storeMgr&&(this.storeMgr=x.dtcde.getStoreManager()),this.addScrapper(new U(e)),this.addScrapper(new v(e)),this.addScrapper(new D(e)),this.addScrapper(new A(e)),this.addScrapper(new O(e)),this.addScrapper(new w(e)),this.addScrapper(new T(e)),this.addScrapper(new I(e)),this.addScrapper(new N(e)),this.addScrapper(new P(e)),this.addScrapper(new k(e))}addScrapper(e){this.listOfScrappers.set(e.getOnlineShopName(),e),this.shopTypeNames.push(e.getOnlineShopName())}getListOfShopTypes(){return this.shopTypeNames}searchProducts(e,n){var o=this;return(0,y.Z)(function*(){const r=o.listOfScrappers.get(yield o.getShopTypeNameOf(n));if(null==r)throw new Error("Shop type "+n+" not found");return r.searchProductsForNameOrId(e,!1)})()}findPrice(e,n,o,r){var s=this;return(0,y.Z)(function*(){if(null==e)throw new Error("No product to get price for");const i=s.listOfScrappers.get(yield s.getShopTypeNameOf(n));if(null==i)throw new Error("Shop type "+n+" not found");null==r&&(r=s.modelMgr.findAtPosition(o,!1));let d=null,a=null;if(null!=r?.fields)for(const u of Object.values(r.fields))if("Price"===u.type){d=u,a=e[d.name];break}null==d&&(d=r,a=e);const l=s.findProductId(a);return null==l||null==a?Promise.reject("Product Id not found in "+e):null!=a?(a.lastCheckDate=new Date,i.updatePrice({productId:l,productName:a.nameInShop??null,productUrl:a.urlInShop}).then(u=>null!=u&&null!=a?(a.cost=f.toMoneyAmount(u),a.outOfStock=u.outOfStock,a.inError=!1,a):null).catch(u=>{throw console.error("Cannot update price for "+a?.nameInShop+" because of "+u.toString()),u})):Promise.reject("Impossible to be there...")})()}findProductId(e){return null!=e?.idInShop?e?.idInShop:null!=e?.productId?e?.productId:null!=e?.id?e?.id:null}findProductName(e){return null!=e?.nameInShop?e?.nameInShop:null!=e?.productName?e?.productName:null!=e?.name?e?.name:null}updatePriceIfPossible(e,n){var o=this;return(0,y.Z)(function*(){if(null!=e.idInShop&&null!=e.shop&&("string"==typeof e.lastCheckDate&&(e.lastCheckDate=new Date(e.lastCheckDate)),null==e.lastCheckDate||e.lastCheckDate.getTime()+E.DONT_UPDATE_UNTIL_DELAY_MS<(new Date).getTime())){const r=yield o.findPrice(e,e.shop,n);return null!=r&&(r.priceDate=new Date),r}return null})()}getShopTypeNameOf(e){const o=this.modelMgr.queryModelToSingle("$.creation.entities[?(@.name=='"+Q.SHOP_ENTITY_NAME+"')]").pointer;return null==o?Promise.resolve(e):(0,R.firstValueFrom)(this.storeMgr.searchEntities(o,{name:"Shop",value:e,operator:x.DontCodeStoreCriteriaOperator.EQUALS})).then(r=>1!=r?.length?e:null!=r[0].Type?r[0].Type:e)}}E.DONT_UPDATE_UNTIL_DELAY_MS=36e5,E.\u0275fac=function(e){return new(e||E)(t.\u0275\u0275inject(G.HttpClient),t.\u0275\u0275inject(x.DontCodeModelManager,8),t.\u0275\u0275inject(x.DontCodeStoreManager,8))},E.\u0275prov=t.\u0275\u0275defineInjectable({token:E,factory:E.\u0275fac,providedIn:"root"});var J=h(49162),j=h(3134),z=h(84017),q=h(24504),X=h(51411),Z=h(4209),$=h(60666),K=h(82046);function te(c,e){if(1&c){const n=t.\u0275\u0275getCurrentView();t.\u0275\u0275text(0,"Select product, or "),t.\u0275\u0275elementStart(1,"button",3),t.\u0275\u0275listener("click",function(){t.\u0275\u0275restoreView(n);const r=t.\u0275\u0275nextContext();return t.\u0275\u0275resetView(r.notFound())}),t.\u0275\u0275elementEnd()}}function ne(c,e){if(1&c&&t.\u0275\u0275element(0,"img",8),2&c){const n=t.\u0275\u0275nextContext(2).$implicit;t.\u0275\u0275property("src",n.productImageUrl,t.\u0275\u0275sanitizeUrl)}}function re(c,e){if(1&c&&(t.\u0275\u0275template(0,ne,1,1,"img",7),t.\u0275\u0275text(1,"\xa0 ")),2&c){const n=t.\u0275\u0275nextContext().$implicit;t.\u0275\u0275property("ngIf",null!==n.productImageUrl)}}function oe(c,e){if(1&c){const n=t.\u0275\u0275getCurrentView();t.\u0275\u0275elementStart(0,"button",9),t.\u0275\u0275listener("click",function(){t.\u0275\u0275restoreView(n);const r=t.\u0275\u0275nextContext().$implicit,s=t.\u0275\u0275nextContext();return t.\u0275\u0275resetView(s.selectionOf(r))}),t.\u0275\u0275elementEnd()}}function ie(c,e){if(1&c&&(t.\u0275\u0275elementStart(0,"div",4)(1,"p-card",5),t.\u0275\u0275template(2,re,2,1,"ng-template",1),t.\u0275\u0275elementStart(3,"p")(4,"small"),t.\u0275\u0275text(5),t.\u0275\u0275elementEnd()(),t.\u0275\u0275element(6,"p"),t.\u0275\u0275elementStart(7,"h2"),t.\u0275\u0275text(8),t.\u0275\u0275elementEnd(),t.\u0275\u0275template(9,oe,1,0,"ng-template",6),t.\u0275\u0275elementEnd()()),2&c){const n=e.$implicit,o=t.\u0275\u0275nextContext();t.\u0275\u0275advance(1),t.\u0275\u0275property("header",n.productName),t.\u0275\u0275advance(4),t.\u0275\u0275textInterpolate(n.productDescription),t.\u0275\u0275advance(3),t.\u0275\u0275textInterpolate(o.localizedAmount(n))}}class V{constructor(e){this.ref=e,this.listOfProducts=new Array,this.selected=new t.EventEmitter}selectionOf(e){this.selected.next(e)}localizedAmount(e){return null==e.productPrice||null==e.currencyCode?e.currencyCode??"":Intl.NumberFormat(globalThis?.window?.navigator.language??"en-US",{style:"currency",currency:e.currencyCode}).format(e.productPrice)}notFound(){this.selected.next(null)}}V.\u0275fac=function(e){return new(e||V)(t.\u0275\u0275directiveInject(t.ChangeDetectorRef))},V.\u0275cmp=t.\u0275\u0275defineComponent({type:V,selectors:[["dontcode-commerce-product-selection"]],inputs:{listOfProducts:"listOfProducts"},outputs:{selected:"selected"},decls:3,vars:3,consts:[["layout","grid",3,"value","rows","paginator"],["pTemplate","header"],["pTemplate","gridItem"],["label","Not found","icon","pi pi-delete-left","pButton","",3,"click"],[1,"col-6","md:col-3","flex","align-items-stretch"],[3,"header"],["pTemplate","footer"],[3,"src",4,"ngIf"],[3,"src"],["label","Select","icon","pi pi-check","pButton","",3,"click"]],template:function(e,n){1&e&&(t.\u0275\u0275elementStart(0,"p-dataView",0),t.\u0275\u0275template(1,te,2,0,"ng-template",1),t.\u0275\u0275template(2,ie,10,3,"ng-template",2),t.\u0275\u0275elementEnd()),2&e&&t.\u0275\u0275property("value",n.listOfProducts)("rows",4)("paginator",!0)},dependencies:[b.NgIf,j.PrimeTemplate,q.ButtonDirective,$.DataView,K.Card]});const ae=["inlineView"],se=["fullEditView"];function ce(c,e){1&c&&t.\u0275\u0275elementContainer(0)}function le(c,e){if(1&c&&(t.\u0275\u0275elementContainerStart(0),t.\u0275\u0275elementStart(1,"a",5),t.\u0275\u0275template(2,ce,1,0,"ng-container",6),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementContainerEnd()),2&c){const n=t.\u0275\u0275nextContext(2),o=t.\u0275\u0275reference(4);t.\u0275\u0275advance(1),t.\u0275\u0275propertyInterpolate("href",n.value.urlInShop,t.\u0275\u0275sanitizeUrl),t.\u0275\u0275advance(1),t.\u0275\u0275property("ngTemplateOutlet",o)}}function pe(c,e){1&c&&t.\u0275\u0275elementContainer(0)}function de(c,e){if(1&c&&(t.\u0275\u0275elementContainerStart(0),t.\u0275\u0275template(1,pe,1,0,"ng-container",6),t.\u0275\u0275elementContainerEnd()),2&c){t.\u0275\u0275nextContext(2);const n=t.\u0275\u0275reference(4);t.\u0275\u0275advance(1),t.\u0275\u0275property("ngTemplateOutlet",n)}}function ue(c,e){if(1&c&&(t.\u0275\u0275elementStart(0,"span",3),t.\u0275\u0275template(1,le,3,2,"ng-container",4),t.\u0275\u0275template(2,de,2,1,"ng-container",4),t.\u0275\u0275elementEnd()),2&c){const n=t.\u0275\u0275nextContext();let o;t.\u0275\u0275propertyInterpolate2("pTooltip","Price Date: ",null!==(o=null==n.value?null:n.value.priceDate)&&void 0!==o?o:"Unknown","<br/>Shop:",null!==(o=null==n.value?null:n.value.shop)&&void 0!==o?o:"Unknown",""),t.\u0275\u0275property("escape",!1),t.\u0275\u0275advance(1),t.\u0275\u0275property("ngIf",null==n.value?null:n.value.urlInShop),t.\u0275\u0275advance(1),t.\u0275\u0275property("ngIf",!(null!=n.value&&n.value.urlInShop))}}function me(c,e){1&c&&t.\u0275\u0275element(0,"button",8)}function fe(c,e){1&c&&t.\u0275\u0275elementContainer(0)}function he(c,e){if(1&c&&(t.\u0275\u0275template(0,me,1,0,"button",7),t.\u0275\u0275template(1,fe,1,0,"ng-container",6),t.\u0275\u0275text(2,"\xa0\n")),2&c){const n=t.\u0275\u0275nextContext();t.\u0275\u0275property("ngIf",null==n.value?null:n.value.inError),t.\u0275\u0275advance(1),t.\u0275\u0275property("ngTemplateOutlet",n.subFieldInlineViewTemplate("cost"))}}function _e(c,e){1&c&&t.\u0275\u0275elementContainer(0)}function ge(c,e){1&c&&t.\u0275\u0275element(0,"button",8)}function Ce(c,e){1&c&&t.\u0275\u0275elementContainer(0)}function xe(c,e){1&c&&t.\u0275\u0275elementContainer(0)}function Se(c,e){1&c&&t.\u0275\u0275elementContainer(0)}function Pe(c,e){if(1&c&&(t.\u0275\u0275elementStart(0,"a",5),t.\u0275\u0275text(1,"Try in the browser"),t.\u0275\u0275elementEnd()),2&c){const n=t.\u0275\u0275nextContext(5);t.\u0275\u0275property("href",n.parsingError.url,t.\u0275\u0275sanitizeUrl)}}function ye(c,e){if(1&c&&(t.\u0275\u0275text(0),t.\u0275\u0275template(1,Pe,2,1,"a",22)),2&c){const n=t.\u0275\u0275nextContext(4);let o;t.\u0275\u0275textInterpolate1("Error : ",null!==(o=n.parsingError.status)&&void 0!==o?o:":"+n.parsingError.message,"\xa0 "),t.\u0275\u0275advance(1),t.\u0275\u0275property("ngIf",n.parsingError.url)}}function Te(c,e){1&c&&(t.\u0275\u0275elementContainerStart(0),t.\u0275\u0275elementStart(1,"p-messages",20),t.\u0275\u0275template(2,ye,2,2,"ng-template",21),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementContainerEnd())}function Ie(c,e){if(1&c){const n=t.\u0275\u0275getCurrentView();t.\u0275\u0275elementContainerStart(0),t.\u0275\u0275elementStart(1,"div",23)(2,"dontcode-commerce-product-selection",24),t.\u0275\u0275listener("selected",function(r){t.\u0275\u0275restoreView(n);const s=t.\u0275\u0275nextContext(3);return t.\u0275\u0275resetView(s.selectedProduct(r))}),t.\u0275\u0275elementEnd()(),t.\u0275\u0275elementContainerEnd()}if(2&c){const n=t.\u0275\u0275nextContext(3);t.\u0275\u0275advance(1),t.\u0275\u0275property("id",n.name+"-select"),t.\u0275\u0275advance(1),t.\u0275\u0275property("listOfProducts",n.listOfSelectableProducts)}}function Ne(c,e){if(1&c){const n=t.\u0275\u0275getCurrentView();t.\u0275\u0275elementContainerStart(0,10),t.\u0275\u0275elementStart(1,"div",11)(2,"div",12)(3,"span",13)(4,"input",14),t.\u0275\u0275listener("input",function(r){t.\u0275\u0275restoreView(n);const s=t.\u0275\u0275nextContext(2);return t.\u0275\u0275resetView(s.productNameChanged(r))}),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementStart(5,"label",15),t.\u0275\u0275text(6,"Product Name"),t.\u0275\u0275elementEnd()()(),t.\u0275\u0275elementStart(7,"div",12),t.\u0275\u0275template(8,_e,1,0,"ng-container",6),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementStart(9,"div",12)(10,"div",16),t.\u0275\u0275template(11,ge,1,0,"button",7),t.\u0275\u0275elementStart(12,"button",17),t.\u0275\u0275listener("click",function(){t.\u0275\u0275restoreView(n);const r=t.\u0275\u0275nextContext(2);return t.\u0275\u0275resetView(r.updatePrice())}),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementStart(13,"div",18),t.\u0275\u0275text(14,"Price:\xa0 "),t.\u0275\u0275template(15,Ce,1,0,"ng-container",6),t.\u0275\u0275elementEnd()()(),t.\u0275\u0275elementStart(16,"div",12),t.\u0275\u0275text(17,"Date of Price:\xa0 "),t.\u0275\u0275template(18,xe,1,0,"ng-container",6),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementStart(19,"div",12),t.\u0275\u0275text(20,"Product Id: "),t.\u0275\u0275element(21,"input",19),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementStart(22,"div",12),t.\u0275\u0275text(23,"Product url: "),t.\u0275\u0275template(24,Se,1,0,"ng-container",6),t.\u0275\u0275elementEnd(),t.\u0275\u0275template(25,Te,3,0,"ng-container",4),t.\u0275\u0275template(26,Ie,3,2,"ng-container",4),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementContainerEnd()}if(2&c){const n=t.\u0275\u0275nextContext(2);t.\u0275\u0275property("formGroup",n.form),t.\u0275\u0275advance(4),t.\u0275\u0275property("id",n.name+"-name"),t.\u0275\u0275advance(1),t.\u0275\u0275property("for",n.name+"-name"),t.\u0275\u0275advance(3),t.\u0275\u0275property("ngTemplateOutlet",n.subFieldFullEditTemplate("shop")),t.\u0275\u0275advance(3),t.\u0275\u0275property("ngIf",null==n.value?null:n.value.inError),t.\u0275\u0275advance(1),t.\u0275\u0275property("disabled",n.cannotUpdatePrice()),t.\u0275\u0275advance(3),t.\u0275\u0275property("ngTemplateOutlet",n.subFieldFullEditTemplate("cost")),t.\u0275\u0275advance(3),t.\u0275\u0275property("ngTemplateOutlet",n.subFieldFullEditTemplate("priceDate")),t.\u0275\u0275advance(6),t.\u0275\u0275property("ngTemplateOutlet",n.subFieldFullEditTemplate("urlInShop")),t.\u0275\u0275advance(1),t.\u0275\u0275property("ngIf",n.parsingError),t.\u0275\u0275advance(1),t.\u0275\u0275property("ngIf",n.productSelectionMode)}}function Oe(c,e){if(1&c&&t.\u0275\u0275template(0,Ne,27,11,"ng-container",9),2&c){const n=t.\u0275\u0275nextContext();t.\u0275\u0275property("ngIf",n.form)}}class L extends C.AbstractDynamicLoaderComponent{constructor(e,n,o,r){super(e,o,r),this.priceFinder=n,this.parsingError=null,this.productSelectionMode=!1,this.productNameLinked=!1,this.listOfSelectableProducts=new Array,this.defineSubField("cost","Other currency"),this.defineSubField("priceDate","Date & Time"),this.defineSubField("shop","Shop"),this.defineSubField("urlInShop","Website (url)"),this.value={}}providesTemplates(e){return new C.TemplateList(this.inlineView,null,this.fullEditView)}canProvide(e){return new C.PossibleTemplateList(!0,!1,!0)}setValue(e){super.setValue(e),null!=e&&this.priceFinder.updatePriceIfPossible(e,this.parentPosition??"").then(()=>{this.parsingError=null}).catch(()=>{e.inError=!0}),this.enableProductNameLookup()}createAndRegisterFormControls(){let e=new g.FormControl(null,{updateOn:"blur"});this.form.registerControl("nameInShop",e),e=new g.FormControl({value:null,disabled:!0},{updateOn:"blur"}),this.form.registerControl("idInShop",e)}cannotUpdatePrice(){return!(null!=this.value&&null!=this.value.shop&&null!=this.value.nameInShop)}updatePrice(){this.parsingError=null,null!=this.value&&(null==this.value.idInShop?null!=this.value.nameInShop&&null!=this.value.shop&&this.priceFinder.searchProducts(this.value.nameInShop,this.value.shop).then(e=>{null!=e&&(this.listOfSelectableProducts=e,this.productSelectionMode=!0,this.ref.markForCheck(),this.ref.detectChanges())}).catch(e=>{this.parsingError=this.translateToError(e),this.ref.markForCheck(),this.ref.detectChanges()}):null!=this.value.shop&&this.priceFinder.findPrice(this.value,this.value.shop,this.parentPosition??"").then(e=>{null!=e&&(this.value.inError=!1,this.setSubFieldValue("cost",e.cost),this.setSubFieldValue("priceDate",new Date))}).catch(e=>{this.value.inError=!0,this.parsingError=this.translateToError(e),this.ref.markForCheck(),this.ref.detectChanges()}))}selectedProduct(e){this.productSelectionMode=!1,null!=e?(this.value.idInShop=e.productId,this.hydrateValueToForm(),this.setSubFieldValue("cost",f.toMoneyAmount(e)),this.setSubFieldValue("priceDate",new Date),this.setSubFieldValue("urlInShop",e.productUrl),this.value.cost=this.getSubFieldValue("cost"),this.value.priceDate=this.getSubFieldValue("priceDate"),this.value.urlInShop=this.getSubFieldValue("urlInShop")):this.clearProduct()}applyComponentToSubField(e,n,o){const r=super.applyComponentToSubField(e,n,o);if("shop"==o){const s=e.selectEventSourceFor(C.DynamicEventType.VALUE_CHANGE);null!=s&&this.subscriptions.add(s.eventSource.subscribe({next:i=>{this.clearProduct()}}))}return r}clearProduct(){this.productSelectionMode=!1,this.parsingError=null,this.value&&delete this.value.cost,this.setSubFieldValue("cost",void 0),this.value&&delete this.value.priceDate,this.setSubFieldValue("priceDate",void 0),this.value&&delete this.value.urlInShop,this.setSubFieldValue("urlInShop",void 0),this.value&&delete this.value.idInShop,this.form.get("idInShop")?.setValue(null,{emitEvent:!1})}productNameChanged(e){this.clearProduct()}enableProductNameLookup(){if(null==this.value?.nameInShop&&null!=this.parentForm&&!this.productNameLinked){const e=this.guessProductParentComponent();null!=e&&(this.productNameLinked=!0,this.subscriptions.add(e.valueChanges.subscribe(n=>{const o=this.form.get("nameInShop");(null==o.value||""==o.value||n.startsWith(o.value))&&(null==this.value&&(this.value={}),this.value.nameInShop=n,o.setValue(n,{emitEvent:!1,emitModelToViewChange:!0}))})))}}guessProductParentComponent(){if(null!=this.parentForm){const e=x.DontCodeModelManager.guessNamePropertyOfObject(this.parentForm.controls);if(null!=e)return this.parentForm.controls[e]}return null}translateToError(e){const n={};return"string"==typeof e?(n.message=e,n):(null!=e.status&&(n.status=e.status),null!=e.statusText?n.message=e.statusText:null!=e.message&&(n.message=e.message),null!=e.url&&(n.url=e.url),null!=e.error&&(n.content=e.error),null==n.message&&(n.message=e.toString()),n)}}L.\u0275fac=function(e){return new(e||L)(t.\u0275\u0275directiveInject(C.ComponentLoaderService),t.\u0275\u0275directiveInject(E),t.\u0275\u0275directiveInject(t.Injector),t.\u0275\u0275directiveInject(t.ChangeDetectorRef))},L.\u0275cmp=t.\u0275\u0275defineComponent({type:L,selectors:[["dontcode-commerce-price"]],viewQuery:function(e,n){if(1&e&&(t.\u0275\u0275viewQuery(ae,7),t.\u0275\u0275viewQuery(se,7)),2&e){let o;t.\u0275\u0275queryRefresh(o=t.\u0275\u0275loadQuery())&&(n.inlineView=o.first),t.\u0275\u0275queryRefresh(o=t.\u0275\u0275loadQuery())&&(n.fullEditView=o.first)}},features:[t.\u0275\u0275InheritDefinitionFeature],decls:7,vars:0,consts:[["inlineView",""],["priceView",""],["fullEditView",""],[3,"pTooltip","escape"],[4,"ngIf"],["target","_blank",3,"href"],[4,"ngTemplateOutlet"],["pButton","","type","button","class","p-button-rounded p-button-outlined p-button-danger","icon","pi pi-exclamation-triangle","pTooltip","Error reading this product price",4,"ngIf"],["pButton","","type","button","icon","pi pi-exclamation-triangle","pTooltip","Error reading this product price",1,"p-button-rounded","p-button-outlined","p-button-danger"],[3,"formGroup",4,"ngIf"],[3,"formGroup"],[1,"formgrid","grid"],[1,"field","col-12","md:col-6"],[1,"p-float-label"],["type","text","pInputText","","formControlName","nameInShop",1,"w-full",3,"id","input"],[3,"for"],[1,"flex","align-items-center"],["name","FetchPrice","pButton","","pRipple","","type","button","icon","pi pi-sync",1,"flex","flex-initial","align-items-center","p-button-rounded","p-button-text",3,"disabled","click"],[1,"flex","align-items-center","flex-1",2,"margin-top","0.5rem"],["type","text","pInputText","","formControlName","idInShop",1,"w-full"],["severity","error"],["pTemplate",""],["target","_blank",3,"href",4,"ngIf"],[1,"field","col-12",3,"id"],[3,"listOfProducts","selected"]],template:function(e,n){1&e&&(t.\u0275\u0275element(0,"dtcde-dynamic"),t.\u0275\u0275template(1,ue,3,5,"ng-template",null,0,t.\u0275\u0275templateRefExtractor),t.\u0275\u0275template(3,he,3,2,"ng-template",null,1,t.\u0275\u0275templateRefExtractor),t.\u0275\u0275template(5,Oe,1,1,"ng-template",null,2,t.\u0275\u0275templateRefExtractor))},dependencies:[b.NgIf,b.NgTemplateOutlet,C.DynamicInsertPoint,g.DefaultValueAccessor,g.NgControlStatus,g.NgControlStatusGroup,g.FormGroupDirective,g.FormControlName,J.InputText,j.PrimeTemplate,z.Ripple,q.ButtonDirective,X.Tooltip,Z.Messages,V]});class M extends C.PluginBaseComponent{constructor(e,n,o){super(e,n,o)}providesTemplates(e){throw new Error("Method not implemented.")}canProvide(e){throw new Error("Method not implemented.")}handleChange(e){}}M.\u0275fac=function(e){return new(e||M)(t.\u0275\u0275directiveInject(C.ComponentLoaderService),t.\u0275\u0275directiveInject(t.Injector),t.\u0275\u0275directiveInject(t.ChangeDetectorRef))},M.\u0275cmp=t.\u0275\u0275defineComponent({type:M,selectors:[["dontcode-commerce-price-compare"]],features:[t.\u0275\u0275InheritDefinitionFeature],decls:2,vars:0,template:function(e,n){1&e&&(t.\u0275\u0275elementStart(0,"h1"),t.\u0275\u0275text(1,"Hello from PriceCompareComponent !"),t.\u0275\u0275elementEnd())}});var Ee=h(36520),W=h(46674);function be(c,e){if(1&c&&t.\u0275\u0275text(0),2&c){const n=t.\u0275\u0275nextContext();t.\u0275\u0275textInterpolate(n.value)}}function ve(c,e){if(1&c&&(t.\u0275\u0275elementStart(0,"div"),t.\u0275\u0275text(1),t.\u0275\u0275elementEnd()),2&c){const n=t.\u0275\u0275nextContext(4);t.\u0275\u0275advance(1),t.\u0275\u0275textInterpolate1(" ",n.value," ")}}function we(c,e){if(1&c&&t.\u0275\u0275template(0,ve,2,1,"div",7),2&c){const n=t.\u0275\u0275nextContext(3);t.\u0275\u0275property("ngIf",n.value)}}function Ue(c,e){1&c&&t.\u0275\u0275text(0),2&c&&t.\u0275\u0275textInterpolate1(" ",e.$implicit," ")}function Re(c,e){if(1&c){const n=t.\u0275\u0275getCurrentView();t.\u0275\u0275elementContainerStart(0,3),t.\u0275\u0275elementStart(1,"p-dropdown",4),t.\u0275\u0275listener("onChange",function(r){t.\u0275\u0275restoreView(n);const s=t.\u0275\u0275nextContext(2);return t.\u0275\u0275resetView(s.valueChanged(r))}),t.\u0275\u0275template(2,we,1,1,"ng-template",5),t.\u0275\u0275template(3,Ue,1,1,"ng-template",6),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementContainerEnd()}if(2&c){const n=t.\u0275\u0275nextContext(2);t.\u0275\u0275property("formGroup",n.form),t.\u0275\u0275advance(1),t.\u0275\u0275property("options",n.options)("formControlName",n.name)("filter",!0)("showClear",!0)("lazy",!0)}}function De(c,e){if(1&c&&t.\u0275\u0275template(0,Re,4,6,"ng-container",2),2&c){const n=t.\u0275\u0275nextContext();t.\u0275\u0275property("ngIf",n.form)}}class Y extends C.AbstractReferenceComponent{constructor(e,n){super(e,n)}ngOnInit(){this.setTargetEntitiesWithName(Q.SHOP_ENTITY_NAME,"Shop")}setValue(e){if(null==e){const n=this.getForm(),o=n?.parent;if(null!=o&&!Array.isArray(o.controls))for(const r in o.controls)if(o.controls[r]===n){e=r;break}}super.setValue(e)}}Y.\u0275fac=function(e){return new(e||Y)(t.\u0275\u0275directiveInject(x.DontCodeModelManager,8),t.\u0275\u0275directiveInject(x.DontCodeStoreManager,8))},Y.\u0275cmp=t.\u0275\u0275defineComponent({type:Y,selectors:[["dontcode-commerce-shop"]],features:[t.\u0275\u0275InheritDefinitionFeature],decls:4,vars:0,consts:[["inlineView",""],["fullEditView",""],[3,"formGroup",4,"ngIf"],[3,"formGroup"],["placeholder","Select a shop",3,"options","formControlName","filter","showClear","lazy","onChange"],["pTemplate","selectedItem"],["pTemplate","item"],[4,"ngIf"]],template:function(e,n){1&e&&(t.\u0275\u0275template(0,be,1,1,"ng-template",null,0,t.\u0275\u0275templateRefExtractor),t.\u0275\u0275template(2,De,1,1,"ng-template",null,1,t.\u0275\u0275templateRefExtractor))},dependencies:[b.NgIf,g.NgControlStatus,g.NgControlStatusGroup,g.FormGroupDirective,g.FormControlName,W.Dropdown,j.PrimeTemplate]});var Ae=h(91682);const Fe=["inlineView"],Ge=["fullEditView"];function ke(c,e){if(1&c&&t.\u0275\u0275text(0),2&c){const n=t.\u0275\u0275nextContext();t.\u0275\u0275textInterpolate(n.displayableValue())}}function Le(c,e){if(1&c){const n=t.\u0275\u0275getCurrentView();t.\u0275\u0275elementContainerStart(0,3),t.\u0275\u0275elementStart(1,"span",4)(2,"p-dropdown",5),t.\u0275\u0275listener("onChange",function(r){t.\u0275\u0275restoreView(n);const s=t.\u0275\u0275nextContext(2);return t.\u0275\u0275resetView(s.valueChanged(r))}),t.\u0275\u0275elementEnd()(),t.\u0275\u0275elementContainerEnd()}if(2&c){const n=t.\u0275\u0275nextContext(2);t.\u0275\u0275property("formGroup",n.form),t.\u0275\u0275advance(2),t.\u0275\u0275property("options",n.shopTypes)("formControlName",n.name)}}function Me(c,e){if(1&c&&t.\u0275\u0275template(0,Le,3,3,"ng-container",2),2&c){const n=t.\u0275\u0275nextContext();t.\u0275\u0275property("ngIf",n.form)}}class H extends C.AbstractDynamicComponent{constructor(e){super(),this.priceFinder=e,this.shopTypes=new Array,this.valueChange=new t.EventEmitter,this.shopTypes=this.priceFinder.getListOfShopTypes()}createAndRegisterFormControls(){this.form.registerControl(this.name,new g.FormControl(null,{updateOn:"change"}))}providesTemplates(e){return new C.TemplateList(this.inlineView,null,this.fullEditView)}canProvide(e){return new C.PossibleTemplateList(!0,!1,!0)}displayableValue(){return C.AbstractDynamicComponent.toBeautifyString(this.value)??""}listEventSources(){const e=super.listEventSources();return e.push(new C.BaseDynamicEventSource("Value",C.DynamicEventType.VALUE_CHANGE,this.valueChange.asObservable())),e}valueChanged(e){this.valueChange.emit(new C.BaseDynamicEvent("Value",C.DynamicEventType.VALUE_CHANGE,e.value))}}H.\u0275fac=function(e){return new(e||H)(t.\u0275\u0275directiveInject(E))},H.\u0275cmp=t.\u0275\u0275defineComponent({type:H,selectors:[["dontcode-commerce-shop-type"]],viewQuery:function(e,n){if(1&e&&(t.\u0275\u0275viewQuery(Fe,7),t.\u0275\u0275viewQuery(Ge,7)),2&e){let o;t.\u0275\u0275queryRefresh(o=t.\u0275\u0275loadQuery())&&(n.inlineView=o.first),t.\u0275\u0275queryRefresh(o=t.\u0275\u0275loadQuery())&&(n.fullEditView=o.first)}},outputs:{valueChange:"valueChange"},features:[t.\u0275\u0275InheritDefinitionFeature],decls:4,vars:0,consts:[["inlineView",""],["fullEditView",""],[3,"formGroup",4,"ngIf"],[3,"formGroup"],[1,"p-float-label"],["name","shop","placeholder","Please select a Shop",1,"w-full",3,"options","formControlName","onChange"]],template:function(e,n){1&e&&(t.\u0275\u0275template(0,ke,1,1,"ng-template",null,0,t.\u0275\u0275templateRefExtractor),t.\u0275\u0275template(2,Me,1,1,"ng-template",null,1,t.\u0275\u0275templateRefExtractor))},dependencies:[b.NgIf,g.NgControlStatus,g.NgControlStatusGroup,g.FormGroupDirective,g.FormControlName,W.Dropdown]});var Ye=h(7297);class F{constructor(){console.log("Commerce Plugin registering"),x.dtcde.registerPlugin(new Q)}exposedPreviewHandlers(){return new Map([["PriceComponent",L],["PriceCompareComponent",M],["ShopHandlerComponent",Y],["ShopTypeHandlerComponent",H]])}}F.\u0275fac=function(e){return new(e||F)},F.\u0275mod=t.\u0275\u0275defineNgModule({type:F,id:"dontcode-plugin/commerce"}),F.\u0275inj=t.\u0275\u0275defineInjector({imports:[b.CommonModule,C.PluginCommonModule.forRoot(),Ae.BasicModule,Ee.FieldsModule,g.ReactiveFormsModule,J.InputTextModule,g.FormsModule,W.DropdownModule,z.RippleModule,q.ButtonModule,$.DataViewModule,K.CardModule,X.TooltipModule,Ye.MessageModule,Z.MessagesModule]}),t.\u0275\u0275registerNgModuleType(F,"dontcode-plugin/commerce")},15861:(ee,B,h)=>{function b(g,x,G,R,S,f,m){try{var t=g[f](m),y=t.value}catch(U){return void G(U)}t.done?x(y):Promise.resolve(y).then(R,S)}function C(g){return function(){var x=this,G=arguments;return new Promise(function(R,S){var f=g.apply(x,G);function m(y){b(f,R,S,m,t,"next",y)}function t(y){b(f,R,S,m,t,"throw",y)}m(void 0)})}}h.d(B,{Z:()=>C})}}]);