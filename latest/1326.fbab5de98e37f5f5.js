(self.webpackChunkcommerce_tester=self.webpackChunkcommerce_tester||[]).push([[1326],{51326:(Be,v,_)=>{_.r(v),_.d(v,{AbstractOnlineShopScrapper:()=>S,CommerceModule:()=>B,DynamicProxyScrapper:()=>Ve,PriceCompareComponent:()=>M,PriceComponent:()=>L,PriceFinderService:()=>O,ProxyEngine:()=>f,ScrappedProduct:()=>x,ShopHandlerComponent:()=>V,ShopTypeHandlerComponent:()=>H});var y=_(61395),I=_(85582),g=_(8584),C=_(77527),P=_(39732),R=_(22123),w=_(56241);class x{constructor(){this.productName=null,this.outOfStock=!1}}let S=(()=>{class r{static#e=this.CORS_PROXY_URL="https://corsproxy.io/?";static#t=this.CORS_PROXY_ORG_URL="https://corsproxy.org/?";static#r=this.WEBSCRAPING_PROXY_URL="https://api.webscraping.ai/html";static#n=this.WEBSCRAPING_PROXY_API_KEY="f4fe0d0b-bfa9-49bd-a3f7-404be7bcad85";static#i=this.CORS_DONTCODE_PROXY_URL="https://shared.collin.best/proxy/debug";static toMoneyAmount(e){const i=new P.MoneyAmount;return i.amount=e.productPrice,i.currencyCode=e.currencyCode,i}constructor(e){this.http=e,this.onlineShopName="Unknown"}getOnlineShopName(){return this.onlineShopName}getShopTypeName(){return this.onlineShopName}requestWithProxy(e,i,o,n){return(0,w.firstValueFrom)(this.http.request(e,this.encodeUrlForCors(i,o),this.updateOptionsForCors(e,i,o,n))).catch(c=>Promise.reject({url:i,engine:o,error:c}))}encodeUrlForCors(e,i){let o=e;switch(i){case f.CORSPROXY_IO:o=r.CORS_PROXY_URL+encodeURIComponent(e);break;case f.CORSPROXY_ORG:o=r.CORS_PROXY_ORG_URL+encodeURIComponent(e);break;case f.CHROME_ENGINE:case f.DONT_CODE:o=r.CORS_DONTCODE_PROXY_URL;break;case f.WEBSCRAPING_IA:o=r.WEBSCRAPING_PROXY_URL}return o}updateOptionsForCors(e,i,o,n){switch(o){case f.CORSPROXY_IO:case f.CORSPROXY_ORG:n.withCredentials=!1;break;case f.CHROME_ENGINE:case f.DONT_CODE:this.addToHttpParams(n,{url:encodeURIComponent(i)}),o===f.CHROME_ENGINE&&this.addToHttpParams(n,{engine:"chrome"});break;case f.WEBSCRAPING_IA:this.addToHttpParams(n,{proxy:"datacenter",js:!1,api_key:r.WEBSCRAPING_PROXY_API_KEY,url:i})}return n}updatePrice(e,i){let o=e.productId;return null==i&&(i=!1),(i||null==o)&&(o=e.productName??void 0,i=!0),null==o?Promise.reject("You must define a product with a name or id "):this.searchProductsForNameOrId(o,!i).then(n=>{for(const c of n)if(c.productId==e.productId)return c;return null}).then(n=>null!=n||i||null==e.productName?n??Promise.reject("Product "+o+" not found in shoptype "+this.onlineShopName):this.searchProductsForNameOrId(e.productName,!1).then(c=>{for(const s of c)if(s.productId==e.productId)return s;return Promise.reject("Product "+o+" not found in shoptype "+this.onlineShopName)}))}standardHeaders(){return new R.HttpHeaders({})}checkScrappedProduct(e,i){if(null==i.productId||0==i.productId.length)throw new Error("No Product Id scrapped by shop "+this.getOnlineShopName()+" for product search "+e);if(null==i.productName||0==i.productName.length)throw new Error("No Product Name scrapped by shop "+this.getOnlineShopName()+" for product search "+e);if((null==i.productPrice||isNaN(i.productPrice))&&1!=i.outOfStock)throw new Error("Incorrect Product Price "+i.productPrice+" scrapped by shop "+this.getOnlineShopName()+" for product search "+e)}checkStringPosition(e,i){if(-1==e||-1!=i&&e>i)throw new Error("Error decoding product for Scrapper "+this.getOnlineShopName())}indexOf(e,i,o,n,c=!0){const s=e.indexOf(i,o);return-1==s?s:null!=n&&-1!=n&&s>n?-1:c?s+i.length:s}safeIndexOf(e,i,o,n,c=!0){const s=e.indexOf(i,o);if(-1==s)throw new Error("Cannot find "+i+" for "+this.getOnlineShopName());if(null!=n&&-1!=n&&s>n)throw new Error("The product content does not contains "+i+" for "+this.getOnlineShopName());return c?s+i.length:s}addToHttpParams(e,i){e.params=null==e.params?i:null!=e.params.appendAll?e.params.appendAll(i):{...e.params,...i}}}return r})();var f=(()=>{return(r=f||(f={})).CORSPROXY_IO="CORSPROXY.IO",r.CORSPROXY_ORG="CORSPROXY.ORG",r.WEBSCRAPING_IA="WEBSCRAPING.IA",r.DONT_CODE="DONT-CODE.PROXY",r.CHROME_ENGINE="DONT-CODE.CHROME",f;var r})(),t=_(41855);let Q=(()=>{class r extends S{static#e=this.SEARCH_ONLINE_URL="https://jhu6zvksfy-dsn.algolia.net/1/indexes/*/queries?x-algolia-agent=Algolia+for+JavaScript+%283.35.1%29%3B+Browser%3B+Magento2+integration+%283.6.0%29%3B+autocomplete.js+0.38.0&x-algolia-application-id=JHU6ZVKSFY&x-algolia-api-key=YTYyYzkyNzgyZDliZTZlMDk1OGE1MDQwNjRkYWY1ZmY4ZTE5OWZhYmU4ZGUyNTM2NDFjNmU4YjllNWMwNmJmNXRhZ0ZpbHRlcnM9\n";static#t=this.JSON_QUERY={requests:[{indexName:"prod_magento2_fr_products",params:"query=QUERY_STRING&hitsPerPage=6&analyticsTags=autocomplete&clickAnalytics=true&facets=%5B%22categories.level0%22%5D&numericFilters=visibility_search%3D1&ruleContexts=%5B%22magento_filters%22%2C%22%22%5D"},{indexName:"prod_magento2_fr_section_manufacturer",params:"query=chardon%20marie&hitsPerPage=6&analyticsTags=autocomplete&clickAnalytics=true"},{indexName:"prod_magento2_fr_categories",params:"query=chardon%20marie&hitsPerPage=4&analyticsTags=autocomplete&clickAnalytics=true&numericFilters=include_in_menu%3D1"}]};constructor(e){super(e),this.onlineShopName="EasyParapharmacie"}searchProductsForNameOrId(e,i){let o=JSON.stringify(r.JSON_QUERY);return o=o.replace("QUERY_STRING",encodeURIComponent(e)),o=JSON.parse(o),this.requestWithProxy("POST",r.SEARCH_ONLINE_URL,f.CORSPROXY_IO,{body:o,responseType:"json",observe:"body"}).then(n=>{"string"==typeof n&&(n=JSON.parse(n));const c=new Array,s=n.results;if(s.length>0){const p=s[0].hits;if(null!=p)for(const a of p){const l=new x;l.productPrice=a.price.EUR.default,l.currencyCode="EUR",l.productName=a.name,l.productDescription=a.short_description??a.description,l.productId=a.ean_code?.toString(),null==l.productId&&(console.warn("Product "+l.productName+" searched by "+e+" for Shop "+this.getOnlineShopName()+" has no ean_code, getting objectId instead"),l.productId=a.objectID),l.productUrl=a.url,l.productImageUrl=a.image_url,this.checkScrappedProduct(e,l),c.push(l)}}return c})}}return r})(),j=(()=>{class r extends S{static#e=this.SEARCH_ONLINE_URL="https://54m7x8foua-dsn.algolia.net/1/indexes/*/queries?x-algolia-agent=Algolia for JavaScript (4.14.2); Browser (lite); instantsearch.js (4.48.0); react (17.0.2); react-instantsearch (6.36.0); react-instantsearch-hooks (6.36.0); JS Helper (3.11.1)&x-algolia-api-key=52441d0a775f924291679b7c224d6782&x-algolia-application-id=54M7X8FOUA";static#t=this.BASE_URL="https://greenweez.com";static#r=this.JSON_QUERY={requests:[{indexName:"france_prod_offers_genepi_fr_FR",params:"attributesToRetrieve=%5B%22main_category%22%2C%22attributes%22%2C%22capacity%22%2C%22discount.percent%22%2C%22flags%22%2C%22ObjectID%22%2C%22name%22%2C%22options.color.available_colors%22%2C%22seller%22%2C%22shop_data.id%22%2C%22shop_data.variant.images%22%2C%22shop_data.variant.product.id%22%2C%22shop_data.variant.product.legacyId%22%2C%22shop_data.variant.product.slug%22%2C%22shop_data.variant.product.brand.name%22%2C%22shop_data.variant.code%22%2C%22shop_data.sellerCatalog.seller%22%2C%22shop_data.pricing%22%2C%22shop_data.offerData%22%2C%22shop_data.onHand%22%2C%22stats%22%5D&clickAnalytics=true&facets=%5B%5D&filters=has_parent_objectID%3D0&highlightPostTag=__%2Fais-highlight__&highlightPreTag=__ais-highlight__&hitsPerPage=20&query=QUERY_STRING&tagFilters="},{indexName:"france_prod_brands_genepi_fr_FR",params:"attributesToRetrieve=%5B%22name%22%2C%22slug%22%5D&clickAnalytics=true&facets=%5B%5D&filters=&highlightPostTag=__%2Fais-highlight__&highlightPreTag=__ais-highlight__&hitsPerPage=6&query=QUERY_STRING&tagFilters="},{indexName:"france_prod_categories_genepi_fr_FR",params:"attributesToRetrieve=%5B%22parent%22%2C%22name%22%2C%22slug%22%2C%22level%22%5D&clickAnalytics=true&facets=%5B%5D&filters=&highlightPostTag=__%2Fais-highlight__&highlightPreTag=__ais-highlight__&hitsPerPage=6&query=QUERY_STRING&tagFilters="}]};constructor(e){super(e),this.onlineShopName="GreenWeez"}searchProductsForNameOrId(e,i){let o=JSON.stringify(r.JSON_QUERY);return o=o.replace("QUERY_STRING",encodeURIComponent(e)),o=o.replace("QUERY_STRING",encodeURIComponent(e)),o=o.replace("QUERY_STRING",encodeURIComponent(e)),o=JSON.parse(o),this.requestWithProxy("POST",r.SEARCH_ONLINE_URL,f.DONT_CODE,{body:o,responseType:"json",observe:"body"}).then(n=>{"string"==typeof n&&(n=JSON.parse(n));const c=new Array,s=n.results;if(s.length>0){const p=s[0].hits;if(null!=p)for(const a of p){const l=new x;l.productPrice=a.shop_data.pricing.priceIncludedVat/100,l.currencyCode="EUR",l.productName=a.name,l.productDescription=void 0,l.productId=a.shop_data.variant.code,l.productUrl=this.calculateProductUrl(a.shop_data),l.productImageUrl=this.findImageUrl(a.shop_data.variant.images),l.marketPlace=!0===a.flags.marketPlace,this.checkScrappedProduct(e,l),c.push(l)}}return c})}calculateProductUrl(e){return r.BASE_URL+"/produit/"+e.variant.product.slug+"/"+e.variant.code+"/"+e.id}findImageUrl(e){for(const i of e)if("variant"==i.type)return r.BASE_URL+"/_next/image?url=https%3A%2F%2Fcdn.greenweez.com%2Fproducts%2F"+i.path+"&w=640&q=75"}}return r})(),T=(()=>{class r{static#e=this.SHOP_ENTITY_NAME="Online Shop";getConfiguration(){return{plugin:{id:"CommercePlugin","display-name":"Commerce Plugin for anything related to products, prices, shops.",version:"1.0.0"},"schema-updates":[{id:"price-field",description:"A price of a product in a shop",changes:[{location:{parent:"#/$defs/field",id:"type"},update:{enum:[{Commerce:{enum:["Price","Shop","Shop type"]}}]},replace:!1}]}],"preview-handlers":[{location:{parent:P.DontCodeModel.APP_FIELDS,id:"type",values:[{Commerce:{enum:["Price"]}}]},class:{name:"PriceComponent",source:"commerce"}},{location:{parent:P.DontCodeModel.APP_FIELDS,id:"type",values:[{Commerce:{enum:["Shop"]}}]},class:{name:"ShopHandlerComponent",source:"commerce"}},{location:{parent:P.DontCodeModel.APP_FIELDS,id:"type",values:[{Commerce:{enum:["Shop type"]}}]},class:{name:"ShopTypeHandlerComponent",source:"commerce"}}]}}pluginInit(e){}}return r})(),q=(()=>{class r extends S{static#e=this.SEARCH_ONLINE_URL="https://www.newpharma.fr/search-results/search.html?q=QUERY_STRING";static#t=this.PRODUCT_START_STRING='<div class="product js-product-row product--desktop';constructor(e){super(e),this.onlineShopName="NewPharma"}searchProductsForNameOrId(e,i){const o=r.SEARCH_ONLINE_URL.replace("QUERY_STRING",encodeURIComponent(e)),n=this.standardHeaders();return this.requestWithProxy("GET",o,f.CHROME_ENGINE,{headers:n,withCredentials:!1,responseType:"text",observe:"body"}).then(c=>{const s=new Array;let p=c.indexOf(r.PRODUCT_START_STRING);for(;p>=0;){const a=new x;let l=c.indexOf('data-productid="',p)+16;a.productId=c.substring(l,c.indexOf('"',l+1)),l=c.indexOf('<a class="details__title',p)+24,l=c.indexOf('title="',l+1)+7,a.productName=c.substring(l,c.indexOf('"',l+1)),a.productDescription=void 0,l=c.indexOf('href="',p)+6,a.productUrl=c.substring(l,c.indexOf('"',l+1)),l=c.indexOf('<img src="',p+1)+10,a.productImageUrl=c.substring(l,c.indexOf('"',l+1)),this.extractPrice(c,p,a),this.checkScrappedProduct(e,a),s.push(a),p=c.indexOf(r.PRODUCT_START_STRING,p+1)}return s})}extractPrice(e,i,o){let n=e.indexOf('data-content_ids="['+o.productId+']"',i+1);if(-1==n&&(n=e.indexOf('data-content_ids="'+o.productId+'"',i+1)),-1!=n){let c=e.indexOf('data-currency="',n)+15;o.currencyCode=e.substring(c,e.indexOf('"',c+1)),c=e.indexOf('data-value="',n)+12,o.productPrice=parseFloat(e.substring(c,e.indexOf('"',c+1)))}}updatePrice(e,i){return null==e.productUrl?super.updatePrice(e,!0):this.requestWithProxy("GET",e.productUrl,f.CHROME_ENGINE,{headers:{Accept:"text/html"},withCredentials:!1,responseType:"text",observe:"body"}).then(o=>{const n={productId:e.productId,productName:e.productName};return this.extractPrice(o,0,n),this.checkScrappedProduct(e.productName??"",n),e.productPrice=n.productPrice,e.currencyCode=n.currencyCode,e}).catch(o=>(console.error("Error trying to access page for product "+e.productName,o),super.updatePrice(e,!0)))}}return r})(),W=(()=>{class r extends S{static#e=this.SEARCH_ONLINE_URL="https://www.webecologie.com/rechercher?search_query=QUERY_STRING";static#t=this.PRODUCT_START_STRING='<a class="product_img_link"';constructor(e){super(e),this.onlineShopName="WebEcologie"}searchProductsForNameOrId(e,i){const o=r.SEARCH_ONLINE_URL.replace("QUERY_STRING",encodeURIComponent(e));return this.requestWithProxy("GET",o,f.DONT_CODE,{headers:{Accept:"text/html"},responseType:"text",observe:"body"}).then(n=>{const c=new Array;let s=n.indexOf(r.PRODUCT_START_STRING);for(;s>=0;){const p=new x;let a=n.indexOf('href="',s)+6;p.productUrl=n.substring(a,n.indexOf('"',a+1)),a=n.indexOf('title="',s)+7,p.productName=n.substring(a,n.indexOf('"',a+1)),p.productDescription=void 0,a=n.indexOf('src="',s+1)+5,p.productImageUrl=n.substring(a,n.indexOf('"',a+1));const l=n.indexOf('<a class="addToWishlist',s)+23;a=n.indexOf('rel="',l)+5,p.productId=n.substring(a,n.indexOf('"',a+1)),this.extractPrice(n,s,p),this.checkScrappedProduct(e,p),c.push(p),s=n.indexOf(r.PRODUCT_START_STRING,s+1)}return c})}extractPrice(e,i,o){let n=e.indexOf('class="price-first-part">',i)+25,c=Number.parseInt(e.substring(n,e.indexOf("<",n+1)));n=e.indexOf('class="price-last-part">',i)+24,c+=Number.parseInt(e.substring(n,e.indexOf("<",n+1)))/100,o.productPrice=c,n=e.indexOf('itemprop="priceCurrency"',i)+24,n=e.indexOf('content="',n)+9,o.currencyCode=e.substring(n,e.indexOf('"',n+1))}updatePrice(e,i){return null==e.productUrl?super.updatePrice(e,!0):this.requestWithProxy("GET",e.productUrl,f.DONT_CODE,{headers:{Accept:"text/html"},responseType:"text",observe:"body"}).then(o=>{const n={productId:e.productId,productName:e.productName};return this.extractPrice(o,0,n),this.checkScrappedProduct(e.productName??"Unknown",n),e.productPrice=n.productPrice,e.currencyCode=n.currencyCode,e}).catch(o=>(console.error("Error trying to access page for product "+e.productName,o),super.updatePrice(e,!0)))}}return r})(),J=(()=>{class r extends S{static#e=this.SEARCH_ONLINE_URL="https://www.boulanger.com/resultats?tr=QUERY_STRING";static#t=this.PRODUCT_START_STRING="<article";static#r=this.BASE_URL="https://www.boulanger.com";constructor(e){super(e),this.onlineShopName="Boulanger"}searchProductsForNameOrId(e,i){e=e.normalize("NFD").replace(/\p{Diacritic}/gu,"");const o=r.SEARCH_ONLINE_URL.replace("QUERY_STRING",e);return this.requestWithProxy("GET",o,f.CORSPROXY_IO,{observe:"body",responseType:"text"}).then(n=>this.analysePageResult(e,n)).catch(n=>null==n.code||"Unknown Error"===n.statusText?this.requestWithProxy("GET",o,f.WEBSCRAPING_IA,{observe:"body",responseType:"text"}).then(c=>this.analysePageResult(e,c)):n)}analysePageResult(e,i){const o=new Array;let n=i.indexOf(r.PRODUCT_START_STRING);for(;n>=0;){const c=new x;let s=i.indexOf('href="',n)+6;c.productUrl=r.BASE_URL+i.substring(s,i.indexOf('"',s+1)),s=i.indexOf('data-product-label="',n)+20,c.productName=i.substring(s,i.indexOf('"',s+1)),c.productDescription=void 0,s=i.indexOf('<img src="',n+1)+10,c.productImageUrl=i.substring(s,i.indexOf('"',s+1)),s=i.indexOf('data-product-id="',n)+17,c.productId=i.substring(s,i.indexOf('"',s+1)),this.extractPrice(i,n,c),this.checkScrappedProduct(e,c),o.push(c),n=i.indexOf(r.PRODUCT_START_STRING,n+1)}return o}extractPrice(e,i,o){const n=e.indexOf('data-analytics_product_unitprice_ati="',i)+38,c=Number.parseFloat(e.substring(n,e.indexOf('"',n+1)));o.productPrice=c,o.currencyCode="EUR"}}return r})(),X=(()=>{class r extends S{static#e=this.SEARCH_ONLINE_URL="https://z0ypi1plpq-dsn.algolia.net/1/indexes/*/queries?x-algolia-agent=Algolia+for+JavaScript+%284.17.0%29%3B+Browser";static#t=this.JSON_QUERY={requests:[{indexName:"darty_prod_es6",query:"QUERY_STRING",params:"hitsPerPage=4&tagFilters=%5B%22dcom%22%5D"},{indexName:"darty_prod_es6_query_suggestions",query:"QUERY_STRING",params:"hitsPerPage=5"}]};static#r=this.BASE_URL="https://www.darty.com";static#n=this.BASE_IMAGE_URL="https://image.darty.com/darty?type=image&source=IMAGE_URL&width=120&heigth=180&quality=80";constructor(e){super(e),this.onlineShopName="Darty",this.httpHeaders={"x-algolia-api-key":"740b60dee22b6ca679462288f6cd9c7b","x-algolia-application-id":"Z0YPI1PLPQ"}}searchProductsForNameOrId(e,i){let o=JSON.stringify(r.JSON_QUERY);return o=o.replace("QUERY_STRING",e),o=o.replace("QUERY_STRING",e),o=JSON.parse(o),this.requestWithProxy("POST",r.SEARCH_ONLINE_URL,f.CORSPROXY_IO,{body:o,headers:this.httpHeaders,responseType:"json",observe:"body"}).then(n=>{"string"==typeof n&&(n=JSON.parse(n));const c=new Array,s=n.results;if(s.length>0){const p=s[0].hits;if(null!=p)for(const a of p){const l=new x;l.productPrice=this.extractPrice(a),l.currencyCode="EUR",l.productName=a.reference,l.productDescription=void 0,l.productId=a.codic,l.productUrl=r.BASE_URL+"/nav/codic/"+a.codic,a.pictures?.length>0&&(l.productImageUrl=r.BASE_IMAGE_URL.replace("IMAGE_URL",a.pictures[0].algoliaPict)),this.checkScrappedProduct(e,l),c.push(l)}}return c})}updatePrice(e,i){return super.updatePrice(e,!0)}extractPrice(e){if(null!=e.priceSort)return e.priceSort/100;if(null!=e.dartyExclusivePriceSort)return e.dartyExclusivePriceSort/100;let i=0;for(const o in e.prices.stores)("000000"===o||"dartyExclusive"===o&&0===i||0===i)&&(i=e.prices.stores[o]/100);return i}}return r})(),z=(()=>{class r extends S{static#e=this.SEARCH_ONLINE_URL="https://www.cdiscount.com/search/10/QUERY_STRING.html";static#t=this.PRODUCT_START_STRING='<li data-sku="';static#r=this.BASE_URL="https://www.cdiscount.com";constructor(e){super(e),this.onlineShopName="CDiscount"}searchProductsForNameOrId(e,i){const o=r.SEARCH_ONLINE_URL.replace("QUERY_STRING",encodeURIComponent(e));return this.requestWithProxy("GET",o,f.CORSPROXY_ORG,{headers:{Accept:"text/html"},responseType:"text",observe:"body"}).then(n=>{const c=new Array;let s=n.indexOf(r.PRODUCT_START_STRING);for(s=n.indexOf(r.PRODUCT_START_STRING,s+1);s>=0;){const p=n.indexOf(r.PRODUCT_START_STRING,s+1),a=new x;let l=this.safeIndexOf(n,'href="',s,p);a.productUrl=n.substring(l,this.safeIndexOf(n,'"',l+1,p,!1)),l=this.indexOf(n,'<h2 class="prdtTit">',s,p),-1==l&&(l=this.indexOf(n,'<h2 class="prdtBILTit">',s,p)),a.productName=n.substring(l,this.safeIndexOf(n,"</h2>",l+1,p,!1)),a.productDescription=void 0,l=this.safeIndexOf(n,'src="',s+1,p),a.productImageUrl=n.substring(l,this.safeIndexOf(n,'"',l+1,p,!1)),l=this.safeIndexOf(n,'data-productid="',s,p),a.productId=n.substring(l,this.safeIndexOf(n,'"',l+1,p,!1)),this.extractPrice(n,s,p,a),this.checkScrappedProduct(e,a),c.push(a),s=n.indexOf(r.PRODUCT_START_STRING,s+1)}return c})}extractPrice(e,i,o,n){let c=this.indexOf(e,'<span class="price priceColor hideFromPro">',i,o);if(-1!=c){const s=this.safeIndexOf(e,",",c+1,o,!1),p=Number.parseInt(e.substring(c,s)),a=Number.parseInt(e.substring(s+1,this.safeIndexOf(e,"&euro;",s+1,o,!1)));n.productPrice=p+a/100}else{c=this.safeIndexOf(e,'<span class="hideFromPro priceColor price">',i,o);const s=Number.parseInt(e.substring(c,this.safeIndexOf(e,"<sup>",c+1,o,!1))),p=Number.parseInt(e.substring(this.safeIndexOf(e,"</sup>",c+1,o,!1)-2,this.safeIndexOf(e,"</sup>",c+1,o,!1)));n.productPrice=s+p/100}n.currencyCode="EUR"}}return r})(),Z=(()=>{class r extends S{static#e=this.SEARCH_ONLINE_URL="https://www.amazon.fr/s?k=QUERY_STRING";static#t=this.PRODUCT_START_STRING='<div data-asin="';static#r=this.BASE_URL="https://www.amazon.fr";constructor(e){super(e),this.onlineShopName="Amazon"}searchProductsForNameOrId(e,i){const o=r.SEARCH_ONLINE_URL.replace("QUERY_STRING",encodeURIComponent(e));return this.requestWithProxy("GET",o,f.DONT_CODE,{headers:{Accept:"text/html"},responseType:"text",observe:"body"}).catch(n=>(console.error("Error getting amazon price with DontCode Proxy",n),null!=n.status&&n.status>=500?this.requestWithProxy("GET",o,f.CORSPROXY_IO,{headers:{Accept:"text/html"},responseType:"text",observe:"body"}):Promise.reject(n))).catch(n=>(console.error("Error getting amazon price with CorsProxyIO",n),null!=n.status&&n.status>=500?this.requestWithProxy("GET",o,f.WEBSCRAPING_IA,{headers:{Accept:"text/html"},responseType:"text",observe:"body"}):Promise.reject(n))).then(n=>{const c=new Array;let s=n.indexOf(r.PRODUCT_START_STRING);for(;s>=0;){const p=n.indexOf(r.PRODUCT_START_STRING,s+1),a=n.substring(s,p),l=new x,m=a.indexOf('data-component-type="s-product-image"');let u=a.indexOf('data-asin="')+11;if('"'==a.charAt(u)||-1==m){s=n.indexOf(r.PRODUCT_START_STRING,s+1);continue}l.productId=a.substring(u,a.indexOf('"',u+1)),u=a.indexOf('href="',m)+6;let h=a.substring(u,a.indexOf('"',u+1));if(h.startsWith("/sspa/click")){const He=h.indexOf("url=")+4;h=h.substring(He),h=h.replace(/%2F/g,"/")}l.productUrl=r.BASE_URL+h,u=a.indexOf('src="',m+1)+5,l.productImageUrl=a.substring(u,a.indexOf('"',u+1)),u=a.indexOf('a-text-normal">',m)+15,l.productDescription=a.substring(u,a.indexOf("<",u+1)),l.productName=null!=l.productDescription&&l.productDescription?.length>60?l.productDescription.substring(0,60):l.productDescription||null,u=a.indexOf('data-asin="')+11,l.productId=a.substring(u,a.indexOf('"',u+1)),this.extractPrice(a,m,l),this.checkScrappedProduct(e,l),c.push(l),s=a.indexOf(r.PRODUCT_START_STRING,s+1)}return c})}extractPrice(e,i,o){const n=e.indexOf('<span class="a-price-whole">',i)+28;let c=e.substring(n,e.indexOf("</span>",n+1));c=c.replace(",","."),o.productPrice=Number.parseFloat(c),o.currencyCode="EUR"}}return r})(),$=(()=>{class r extends S{constructor(){super(...arguments),this.onlineShopName="Fnac"}static#e=this.SEARCH_ONLINE_URL="https://www.fnac.com/SearchResult/ResultList.aspx?SCat=0&Search=QUERY_STRING&sft=1&sa=0";static#t=this.PRODUCT_START_STRING='<div class="clearfix Article-item';static#r=this.BASE_URL="https://www.fnac.com";searchProductsForNameOrId(e,i){const o=e.split(" ");let n="";for(const s of o)n+=encodeURIComponent(s)+"+";o.length>=1&&(n=n.substring(0,n.length-1));const c=r.SEARCH_ONLINE_URL.replace("QUERY_STRING",n);return this.requestWithProxy("GET",c,f.DONT_CODE,{headers:{Accept:"text/html"},responseType:"text",observe:"body",withCredentials:!0}).then(s=>{const p=new Array;let a=s.indexOf(r.PRODUCT_START_STRING),l=s.indexOf(r.PRODUCT_START_STRING,a+1);for(;a>=0;){const m=new x;let u=this.safeIndexOf(s,'id="',a,l);m.productId=s.substring(u,s.indexOf('"',u+1));let h=this.safeIndexOf(s,'<img class="Article-itemVisualImg',a,l);u=this.indexOf(s,'data-lazyimage="',h),-1==u&&(u=this.safeIndexOf(s,'src="',h,l)),m.productImageUrl=s.substring(u,s.indexOf('"',u+1)),u=this.safeIndexOf(s,'alt="',h,l),m.productName=s.substring(u,s.indexOf('"',u+1)),m.productDescription=void 0,h=this.safeIndexOf(s,'<p class="Article-desc',a,l),u=this.safeIndexOf(s,'href="',h,l),m.productUrl=s.substring(u,s.indexOf('"',u+1)),u=s.indexOf("vendeur partenaire",a),m.marketPlace=-1!=u&&(-1==l||u<l),u=s.indexOf("En stock",a),m.outOfStock=-1==u||!(-1==l||u<l),this.extractPrice(s,a,m,l),null==m.productPrice&&(m.outOfStock=!0),this.checkScrappedProduct(e,m),p.push(m),a=s.indexOf(r.PRODUCT_START_STRING,a+1),l=s.indexOf(r.PRODUCT_START_STRING,a+1)}return p})}extractPrice(e,i,o,n){const c=this.indexOf(e,'class="userPrice">',i,n);if(-1==c)return void(o.productPrice=void 0);const s=this.indexOf(e,"<sup>",c+1,n,!1);let p=0;if(-1==s)p=Number.parseInt(e.substring(c,this.safeIndexOf(e,"&euro;",c+1,n,!1))),o.productPrice=p;else{p=Number.parseInt(e.substring(c,s));const a=Number.parseInt(e.substring(this.safeIndexOf(e,"</sup>",c+1,n,!1)-2,this.safeIndexOf(e,"</sup>",c+1,n)));o.productPrice=p+a/100}o.currencyCode="EUR"}updatePrice(e,i){return null==e.productUrl?super.updatePrice(e,!0):this.requestWithProxy("GET",e.productUrl,f.DONT_CODE,{headers:{Accept:"text/html"},responseType:"text",observe:"body"}).then(o=>{const n={productId:e.productId,productName:e.productName},c=this.safeIndexOf(o,"userPrice",0),s=this.safeIndexOf(o,'data-price="',c);return n.productPrice=Number.parseFloat(o.substring(s,this.safeIndexOf(o,'"',s+1)).replace(",",".")),n.currencyCode="EUR",this.checkScrappedProduct(e.productName??"",n),e.productPrice=n.productPrice,e.currencyCode=n.currencyCode,e}).catch(o=>(console.error("Error trying to access page for product "+e.productName,o),super.updatePrice(e,!0)))}}return r})(),K=(()=>{class r extends S{static#e=this.SEARCH_ONLINE_URL="https://f75bb6q2sy-dsn.algolia.net/1/indexes/*/queries?x-algolia-agent=Algolia+for+JavaScript+%284.11.0%29%3B+Browser+%28lite%29%3B+instantsearch.js+%284.41.0%29%3B+Vue+%282.6.14%29%3B+Vue+InstantSearch+%284.3.3%29%3B+JS+Helper+%283.8.2%29&x-algolia-api-key=f319f4e4b15d239ba0509b3c6c4a0ecd&x-algolia-application-id=F75BB6Q2SY";static#t=this.BASE_URL="https://onatera.com";static#r=this.IMAGE_BASE_URL="https://media.onatera.com/cache/product_image_listing_DM/";static#n=this.JSON_QUERY={requests:[{indexName:"intl.product.fr.fr",params:"clickAnalytics=true&facets=%5B%5D&hitsPerPage=0&query=QUERY_STRING&tagFilters=&userToken=anonymous_09f81bae3a73d5bcb1582423816110b7"},{indexName:"intl.product.fr.fr",params:"clickAnalytics=true&facets=%5B%5D&highlightPostTag=__%2Fais-highlight__&highlightPreTag=__ais-highlight__&hitsPerPage=6&query=QUERY_STRING&tagFilters=&userToken=anonymous_09f81bae3a73d5bcb1582423816110b7"},{indexName:"intl.category.fr.fr",params:"clickAnalytics=true&facets=%5B%5D&highlightPostTag=__%2Fais-highlight__&highlightPreTag=__ais-highlight__&hitsPerPage=3&numericFilters=ref_count%20%3E%200&query=QUERY_STRING&tagFilters=&userToken=anonymous_09f81bae3a73d5bcb1582423816110b7"},{indexName:"intl.brand.fr.fr",params:"clickAnalytics=true&facets=%5B%5D&highlightPostTag=__%2Fais-highlight__&highlightPreTag=__ais-highlight__&hitsPerPage=3&numericFilters=product_count%20%3E%200&query=QUERY_STRING&tagFilters=&userToken=anonymous_09f81bae3a73d5bcb1582423816110b7"},{indexName:"intl.active.fr.fr",params:"clickAnalytics=true&facets=%5B%5D&highlightPostTag=__%2Fais-highlight__&highlightPreTag=__ais-highlight__&hitsPerPage=3&numericFilters=product_count%20%3E%200&query=QUERY_STRING&tagFilters=&userToken=anonymous_09f81bae3a73d5bcb1582423816110b7"},{indexName:"intl.content.for_recipes.fr.fr",params:"clickAnalytics=true&facetFilters=%5B%22type%3Adiy%22%5D&facets=%5B%5D&highlightPostTag=__%2Fais-highlight__&highlightPreTag=__ais-highlight__&hitsPerPage=3&query=QUERY_STRING&tagFilters=&userToken=anonymous_09f81bae3a73d5bcb1582423816110b7"}]};constructor(e){super(e),this.onlineShopName="Onatera"}searchProductsForNameOrId(e,i){let o=JSON.stringify(r.JSON_QUERY);return o=o.replace(/QUERY_STRING/g,encodeURIComponent(e)),o=JSON.parse(o),this.requestWithProxy("POST",r.SEARCH_ONLINE_URL,f.CORSPROXY_IO,{body:o,responseType:"json",observe:"body"}).then(n=>{"string"==typeof n&&(n=JSON.parse(n));const c=new Array,s=n.results;if(s.length>0)for(const p of s){const a=p.hits;if(null!=a)for(const l of a)if(1==l.is_active){const m=l.name+" "+l.brand_name+" ";if(null!=l.variants)for(const u of l.variants){const h=new x;h.productPrice=u.price/100,h.outOfStock=!u.hasStock,h.currencyCode="EUR",h.productName=m+u.name,h.productDescription=u.shortDescription??u.description,h.productId=u.productVariantId.toString(),h.productUrl=r.BASE_URL+u.url,h.productImageUrl=r.IMAGE_BASE_URL+u.picture_path,this.checkScrappedProduct(e,h),c.push(h)}}}return c})}}return r})(),ee=(()=>{class r extends S{static#e=this.SEARCH_ONLINE_URL="https://na.search.sensefuel.live/searchf/4147d2a1-7a21-4697-8a4c-0e25183f3ce9";static#t=this.JSON_QUERY={acp:{},suggest:{},key:"1678529428523-0-AskResult",parentKey:null,terms:{expression:"QUERY_STRING",inputSource:"keyboard",intentDetection:{}},trackFingerPrint:{tracks:[],environmentId:"333"},items:{from:0,size:30,bypassSpellcheck:!1},prefixQuery:{},filters:{},scopes:[],spotlights:[],sort:null,needShortcuts:!0,userIds:{id:null,previousId:null,custId:null,isAuthenticated:!1},sellerId:"France m\xe9tropolitaine",kickerContents:{size:6},contents:{from:0,size:30,playOnIntent:["nlu|content"]},references:{size:32}};constructor(e){super(e),this.onlineShopName="Maxicoffee"}searchProductsForNameOrId(e,i){let o=JSON.stringify(r.JSON_QUERY);return o=o.replace("QUERY_STRING",e),o=JSON.parse(o),this.requestWithProxy("POST",r.SEARCH_ONLINE_URL,f.CORSPROXY_IO,{body:o,responseType:"json",observe:"body"}).then(n=>{"string"==typeof n&&(n=JSON.parse(n));const c=new Array,s=n.data.items.p;if(s.length>0)for(const p of s){const a=new x;a.productPrice=p.prcn,a.currencyCode="EUR",a.productName=p.ttl,a.productDescription=void 0,a.productId=p.id,a.productUrl=p.lnk,a.productImageUrl=p.img,a.outOfStock="in stock"===p.avl,this.checkScrappedProduct(e,a),c.push(a)}return c})}}return r})(),O=(()=>{class r{static#e=this.DONT_UPDATE_UNTIL_DELAY_MS=6e5;constructor(e,i,o){this.httpClient=e,this.modelMgr=i,this.storeMgr=o,this.listOfScrappers=new Map,this.shopTypeNames=new Array,null==this.modelMgr&&(this.modelMgr=P.dtcde.getModelManager()),null==this.storeMgr&&(this.storeMgr=P.dtcde.getStoreManager()),this.addScrapper(new Q(e)),this.addScrapper(new j(e)),this.addScrapper(new q(e)),this.addScrapper(new W(e)),this.addScrapper(new K(e)),this.addScrapper(new J(e)),this.addScrapper(new X(e)),this.addScrapper(new z(e)),this.addScrapper(new $(e)),this.addScrapper(new Z(e)),this.addScrapper(new ee(e))}addScrapper(e){this.listOfScrappers.set(e.getOnlineShopName(),e),this.shopTypeNames.push(e.getOnlineShopName())}getListOfShopTypes(){return this.shopTypeNames}searchProducts(e,i){var o=this;return(0,I.Z)(function*(){const n=o.listOfScrappers.get(yield o.getShopTypeNameOf(i));if(null==n)throw new Error("Shop type "+i+" not found");return n.searchProductsForNameOrId(e,!1)})()}findPrice(e,i,o,n){var c=this;return(0,I.Z)(function*(){if(null==e)throw new Error("No product to get price for");const s=c.listOfScrappers.get(yield c.getShopTypeNameOf(i));if(null==s)throw new Error("Shop type "+i+" not found");null==n&&(n=c.modelMgr.findAtPosition(o,!1));let p=null,a=null;if(null!=n?.fields)for(const m of Object.values(n.fields))if("Price"===m.type){p=m,a=e[p.name];break}null==p&&(p=n,a=e);const l=c.findProductId(a);return null==l||null==a?Promise.reject("Product Id not found in "+e):null!=a?(a.lastCheckDate=new Date,s.updatePrice({productId:l,productName:a.nameInShop??null,productUrl:a.urlInShop}).then(m=>null!=m&&null!=a?(a.cost=S.toMoneyAmount(m),a.outOfStock=m.outOfStock,a.priceDate=new Date,a.inError=!1,a):null).catch(m=>{throw console.error("Cannot update price for "+a?.nameInShop+" because of ",m),null!=a&&(a.inError=!0),m})):Promise.reject("Impossible to be there...")})()}findProductId(e){return null!=e?.idInShop?e?.idInShop:null!=e?.productId?e?.productId:null!=e?.id?e?.id:null}findProductName(e){return null!=e?.nameInShop?e?.nameInShop:null!=e?.productName?e?.productName:null!=e?.name?e?.name:null}updatePriceIfPossible(e,i){var o=this;return(0,I.Z)(function*(){if(null!=e.idInShop&&null!=e.shop&&("string"==typeof e.lastCheckDate&&(e.lastCheckDate=new Date(e.lastCheckDate)),null==e.lastCheckDate||e.lastCheckDate.getTime()+r.DONT_UPDATE_UNTIL_DELAY_MS<(new Date).getTime())){const n=yield o.findPrice(e,e.shop,i);return null!=n&&(n.priceDate=new Date),n}return null})()}getShopTypeNameOf(e){const o=this.modelMgr.queryModelToSingle("$.creation.entities[?(@.name=='"+T.SHOP_ENTITY_NAME+"')]")?.pointer;return null==o?Promise.resolve(e):(0,w.firstValueFrom)(this.storeMgr.searchEntities(o,{name:"Shop",value:e,operator:P.DontCodeStoreCriteriaOperator.EQUALS})).then(n=>1!=n?.length?e:null!=n[0].Type?n[0].Type:e)}static#t=this.\u0275fac=function(i){return new(i||r)(t.\u0275\u0275inject(R.HttpClient),t.\u0275\u0275inject(P.DontCodeModelManager,8),t.\u0275\u0275inject(P.DontCodeStoreManager,8))};static#r=this.\u0275prov=t.\u0275\u0275defineInjectable({token:r,factory:r.\u0275fac,providedIn:"root"})}return r})();var U=_(15627),N=_(51295),A=_(62200),E=_(2715),D=_(77744),F=_(62354),G=_(13731),k=_(90178);function te(r,d){if(1&r){const e=t.\u0275\u0275getCurrentView();t.\u0275\u0275text(0,"Select product, or "),t.\u0275\u0275elementStart(1,"button",3),t.\u0275\u0275listener("click",function(){t.\u0275\u0275restoreView(e);const o=t.\u0275\u0275nextContext();return t.\u0275\u0275resetView(o.notFound())}),t.\u0275\u0275elementEnd()}}function re(r,d){if(1&r&&t.\u0275\u0275element(0,"img",8),2&r){const e=t.\u0275\u0275nextContext(2).$implicit;t.\u0275\u0275property("src",e.productImageUrl,t.\u0275\u0275sanitizeUrl)}}function ne(r,d){if(1&r&&(t.\u0275\u0275template(0,re,1,1,"img",7),t.\u0275\u0275text(1,"\xa0 ")),2&r){const e=t.\u0275\u0275nextContext().$implicit;t.\u0275\u0275property("ngIf",null!==e.productImageUrl)}}function ie(r,d){if(1&r){const e=t.\u0275\u0275getCurrentView();t.\u0275\u0275elementStart(0,"button",9),t.\u0275\u0275listener("click",function(){t.\u0275\u0275restoreView(e);const o=t.\u0275\u0275nextContext().$implicit,n=t.\u0275\u0275nextContext();return t.\u0275\u0275resetView(n.selectionOf(o))}),t.\u0275\u0275elementEnd()}}function oe(r,d){if(1&r&&(t.\u0275\u0275elementStart(0,"div",4)(1,"p-card",5),t.\u0275\u0275template(2,ne,2,1,"ng-template",1),t.\u0275\u0275elementStart(3,"p")(4,"small"),t.\u0275\u0275text(5),t.\u0275\u0275elementEnd()(),t.\u0275\u0275element(6,"p"),t.\u0275\u0275elementStart(7,"h2"),t.\u0275\u0275text(8),t.\u0275\u0275elementEnd(),t.\u0275\u0275template(9,ie,1,0,"ng-template",6),t.\u0275\u0275elementEnd()()),2&r){const e=d.$implicit,i=t.\u0275\u0275nextContext();t.\u0275\u0275advance(1),t.\u0275\u0275property("header",e.productName),t.\u0275\u0275advance(4),t.\u0275\u0275textInterpolate(e.productDescription),t.\u0275\u0275advance(3),t.\u0275\u0275textInterpolate(i.localizedAmount(e))}}let ae=(()=>{class r{constructor(e){this.ref=e,this.listOfProducts=new Array,this.selected=new t.EventEmitter}selectionOf(e){this.selected.next(e)}localizedAmount(e){return null==e.productPrice||null==e.currencyCode?e.currencyCode??"":Intl.NumberFormat(globalThis?.window?.navigator.language??"en-US",{style:"currency",currency:e.currencyCode}).format(e.productPrice)}notFound(){this.selected.next(null)}static#e=this.\u0275fac=function(i){return new(i||r)(t.\u0275\u0275directiveInject(t.ChangeDetectorRef))};static#t=this.\u0275cmp=t.\u0275\u0275defineComponent({type:r,selectors:[["dontcode-commerce-product-selection"]],inputs:{listOfProducts:"listOfProducts"},outputs:{selected:"selected"},decls:3,vars:3,consts:[["layout","grid",3,"value","rows","paginator"],["pTemplate","header"],["pTemplate","gridItem"],["label","Not found","icon","pi pi-delete-left","pButton","",3,"click"],[1,"col-6","md:col-3","flex","align-items-stretch"],[3,"header"],["pTemplate","footer"],[3,"src",4,"ngIf"],[3,"src"],["label","Select","icon","pi pi-check","pButton","",3,"click"]],template:function(i,o){1&i&&(t.\u0275\u0275elementStart(0,"p-dataView",0),t.\u0275\u0275template(1,te,2,0,"ng-template",1),t.\u0275\u0275template(2,oe,10,3,"ng-template",2),t.\u0275\u0275elementEnd()),2&i&&t.\u0275\u0275property("value",o.listOfProducts)("rows",4)("paginator",!0)},dependencies:[y.NgIf,N.PrimeTemplate,E.ButtonDirective,G.DataView,k.Card]})}return r})();const se=["inlineView"],ce=["fullEditView"];function le(r,d){1&r&&t.\u0275\u0275elementContainer(0)}function pe(r,d){if(1&r&&(t.\u0275\u0275elementContainerStart(0),t.\u0275\u0275elementStart(1,"a",5),t.\u0275\u0275template(2,le,1,0,"ng-container",6),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementContainerEnd()),2&r){const e=t.\u0275\u0275nextContext(3),i=t.\u0275\u0275reference(4);t.\u0275\u0275advance(1),t.\u0275\u0275propertyInterpolate("href",e.value.urlInShop,t.\u0275\u0275sanitizeUrl),t.\u0275\u0275advance(1),t.\u0275\u0275property("ngTemplateOutlet",i)}}function ue(r,d){1&r&&t.\u0275\u0275elementContainer(0)}function de(r,d){if(1&r&&(t.\u0275\u0275elementContainerStart(0),t.\u0275\u0275template(1,ue,1,0,"ng-container",6),t.\u0275\u0275elementContainerEnd()),2&r){t.\u0275\u0275nextContext(3);const e=t.\u0275\u0275reference(4);t.\u0275\u0275advance(1),t.\u0275\u0275property("ngTemplateOutlet",e)}}function fe(r,d){if(1&r&&(t.\u0275\u0275elementContainerStart(0),t.\u0275\u0275elementStart(1,"span",4),t.\u0275\u0275template(2,pe,3,2,"ng-container",3),t.\u0275\u0275template(3,de,2,1,"ng-container",3),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementContainerEnd()),2&r){const e=t.\u0275\u0275nextContext(2);let i;t.\u0275\u0275advance(1),t.\u0275\u0275propertyInterpolate2("pTooltip","Price Date: ",null!==(i=e.value.priceDate)&&void 0!==i?i:"Unknown","<br/>Shop:",null!==(i=e.value.shop)&&void 0!==i?i:"Unknown",""),t.\u0275\u0275property("escape",!1),t.\u0275\u0275advance(1),t.\u0275\u0275property("ngIf",null==e.value?null:e.value.urlInShop),t.\u0275\u0275advance(1),t.\u0275\u0275property("ngIf",!(null!=e.value&&e.value.urlInShop))}}function me(r,d){if(1&r&&t.\u0275\u0275template(0,fe,4,5,"ng-container",3),2&r){const e=t.\u0275\u0275nextContext();t.\u0275\u0275property("ngIf",e.value)}}function he(r,d){1&r&&t.\u0275\u0275element(0,"button",8)}function _e(r,d){1&r&&t.\u0275\u0275elementContainer(0)}function ge(r,d){if(1&r&&(t.\u0275\u0275template(0,he,1,0,"button",7),t.\u0275\u0275template(1,_e,1,0,"ng-container",6),t.\u0275\u0275text(2,"\xa0\n")),2&r){const e=t.\u0275\u0275nextContext();t.\u0275\u0275property("ngIf",null==e.value?null:e.value.inError),t.\u0275\u0275advance(1),t.\u0275\u0275property("ngTemplateOutlet",e.subFieldInlineViewTemplate("cost"))}}function Ce(r,d){1&r&&t.\u0275\u0275elementContainer(0)}function Se(r,d){1&r&&t.\u0275\u0275element(0,"button",8)}function Pe(r,d){1&r&&t.\u0275\u0275elementContainer(0)}function xe(r,d){1&r&&t.\u0275\u0275elementContainer(0)}function ye(r,d){1&r&&t.\u0275\u0275elementContainer(0)}function Ie(r,d){if(1&r&&(t.\u0275\u0275elementStart(0,"a",5),t.\u0275\u0275text(1,"Try in the browser"),t.\u0275\u0275elementEnd()),2&r){const e=t.\u0275\u0275nextContext(5);t.\u0275\u0275property("href",null==e.parsingError?null:e.parsingError.url,t.\u0275\u0275sanitizeUrl)}}function Te(r,d){if(1&r&&(t.\u0275\u0275text(0),t.\u0275\u0275template(1,Ie,2,1,"a",22)),2&r){const e=t.\u0275\u0275nextContext(4);t.\u0275\u0275textInterpolate1("Error : ",e.errorMessage()," "),t.\u0275\u0275advance(1),t.\u0275\u0275property("ngIf",null==e.parsingError?null:e.parsingError.url)}}function Oe(r,d){1&r&&(t.\u0275\u0275elementContainerStart(0),t.\u0275\u0275elementStart(1,"p-messages",20),t.\u0275\u0275template(2,Te,2,2,"ng-template",21),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementContainerEnd())}function Ne(r,d){if(1&r){const e=t.\u0275\u0275getCurrentView();t.\u0275\u0275elementContainerStart(0),t.\u0275\u0275elementStart(1,"div",23)(2,"dontcode-commerce-product-selection",24),t.\u0275\u0275listener("selected",function(o){t.\u0275\u0275restoreView(e);const n=t.\u0275\u0275nextContext(3);return t.\u0275\u0275resetView(n.selectedProduct(o))}),t.\u0275\u0275elementEnd()(),t.\u0275\u0275elementContainerEnd()}if(2&r){const e=t.\u0275\u0275nextContext(3);t.\u0275\u0275advance(1),t.\u0275\u0275property("id",e.name+"-select"),t.\u0275\u0275advance(1),t.\u0275\u0275property("listOfProducts",e.listOfSelectableProducts)}}function Ee(r,d){if(1&r){const e=t.\u0275\u0275getCurrentView();t.\u0275\u0275elementContainerStart(0,10),t.\u0275\u0275elementStart(1,"div",11)(2,"div",12)(3,"span",13)(4,"input",14),t.\u0275\u0275listener("input",function(o){t.\u0275\u0275restoreView(e);const n=t.\u0275\u0275nextContext(2);return t.\u0275\u0275resetView(n.productNameChanged(o))}),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementStart(5,"label",15),t.\u0275\u0275text(6,"Product Name"),t.\u0275\u0275elementEnd()()(),t.\u0275\u0275elementStart(7,"div",12),t.\u0275\u0275template(8,Ce,1,0,"ng-container",6),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementStart(9,"div",12)(10,"div",16),t.\u0275\u0275template(11,Se,1,0,"button",7),t.\u0275\u0275elementStart(12,"button",17),t.\u0275\u0275listener("click",function(){t.\u0275\u0275restoreView(e);const o=t.\u0275\u0275nextContext(2);return t.\u0275\u0275resetView(o.updatePrice())}),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementStart(13,"div",18),t.\u0275\u0275text(14,"Price:\xa0 "),t.\u0275\u0275template(15,Pe,1,0,"ng-container",6),t.\u0275\u0275elementEnd()()(),t.\u0275\u0275elementStart(16,"div",12),t.\u0275\u0275text(17,"Date of Price:\xa0 "),t.\u0275\u0275template(18,xe,1,0,"ng-container",6),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementStart(19,"div",12),t.\u0275\u0275text(20,"Product Id: "),t.\u0275\u0275element(21,"input",19),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementStart(22,"div",12),t.\u0275\u0275text(23,"Product url: "),t.\u0275\u0275template(24,ye,1,0,"ng-container",6),t.\u0275\u0275elementEnd(),t.\u0275\u0275template(25,Oe,3,0,"ng-container",3),t.\u0275\u0275template(26,Ne,3,2,"ng-container",3),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementContainerEnd()}if(2&r){const e=t.\u0275\u0275nextContext(2);t.\u0275\u0275property("formGroup",e.form),t.\u0275\u0275advance(4),t.\u0275\u0275property("id",e.name+"-name"),t.\u0275\u0275advance(1),t.\u0275\u0275property("for",e.name+"-name"),t.\u0275\u0275advance(3),t.\u0275\u0275property("ngTemplateOutlet",e.subFieldFullEditTemplate("shop")),t.\u0275\u0275advance(3),t.\u0275\u0275property("ngIf",null==e.value?null:e.value.inError),t.\u0275\u0275advance(1),t.\u0275\u0275property("icon",e.updatePriceIcon)("disabled",e.cannotUpdatePrice()),t.\u0275\u0275advance(3),t.\u0275\u0275property("ngTemplateOutlet",e.subFieldFullEditTemplate("cost")),t.\u0275\u0275advance(3),t.\u0275\u0275property("ngTemplateOutlet",e.subFieldFullEditTemplate("priceDate")),t.\u0275\u0275advance(6),t.\u0275\u0275property("ngTemplateOutlet",e.subFieldFullEditTemplate("urlInShop")),t.\u0275\u0275advance(1),t.\u0275\u0275property("ngIf",e.isInError()),t.\u0275\u0275advance(1),t.\u0275\u0275property("ngIf",e.productSelectionMode)}}function be(r,d){if(1&r&&t.\u0275\u0275template(0,Ee,27,12,"ng-container",9),2&r){const e=t.\u0275\u0275nextContext();t.\u0275\u0275property("ngIf",e.form)}}let L=(()=>{class r extends g.AbstractDynamicLoaderComponent{static#e=this.baseUpdatePriceIcons="pi pi-refresh";constructor(e,i,o,n){super(e,o,n),this.priceFinder=i,this.updatePriceIcon=r.baseUpdatePriceIcons,this.parsingError=null,this.productSelectionMode=!1,this.productNameLinked=!1,this.listOfSelectableProducts=new Array,this.defineSubField("cost","Other currency"),this.defineSubField("priceDate","Date & Time"),this.defineSubField("shop","Shop"),this.defineSubField("urlInShop","Website (url)"),this.value={}}providesTemplates(e){return new g.TemplateList(this.inlineView,null,this.fullEditView)}canProvide(e){return new g.PossibleTemplateList(!0,!1,!0)}setValue(e){super.setValue(e),this.enableProductNameLookup()}createAndRegisterFormControls(){let e=new C.FormControl(null,{updateOn:"blur"});this.form.registerControl("nameInShop",e),e=new C.FormControl({value:null,disabled:!0},{updateOn:"blur"}),this.form.registerControl("idInShop",e)}cannotUpdatePrice(){return!(null!=this.value&&null!=this.value.shop&&null!=this.value.nameInShop)}updatePrice(){var e=this;return(0,I.Z)(function*(){if(e.parsingError=null,null!=e.value)try{null==e.value.idInShop?(e.updatePriceIcon=r.baseUpdatePriceIcons+" pi-spin",null!=e.value.nameInShop&&null!=e.value.shop&&(yield e.priceFinder.searchProducts(e.value.nameInShop,e.value.shop).then(i=>{null!=i&&(e.listOfSelectableProducts=i,e.productSelectionMode=!0,e.ref.markForCheck(),e.ref.detectChanges())}).catch(i=>{e.parsingError=e.translateToError(i),e.ref.markForCheck(),e.ref.detectChanges()}))):null!=e.value.shop&&(yield e.priceFinder.findPrice(e.value,e.value.shop,e.parentPosition??"").then(i=>{null!=i&&(e.value.inError=!1,e.setSubFieldValue("cost",i.cost),e.setSubFieldValue("priceDate",new Date))}).catch(i=>{e.value.inError=!0,e.parsingError=e.translateToError(i),e.ref.markForCheck(),e.ref.detectChanges()}))}finally{e.updatePriceIcon=r.baseUpdatePriceIcons,e.ref.markForCheck(),e.ref.detectChanges()}})()}selectedProduct(e){this.productSelectionMode=!1,null!=e?(this.value.idInShop=e.productId,this.hydrateValueToForm(),this.setSubFieldValue("cost",S.toMoneyAmount(e)),this.setSubFieldValue("priceDate",new Date),this.setSubFieldValue("urlInShop",e.productUrl),this.value.cost=this.getSubFieldValue("cost"),this.value.priceDate=this.getSubFieldValue("priceDate"),this.value.urlInShop=this.getSubFieldValue("urlInShop")):this.clearProduct()}applyComponentToSubField(e,i,o){const n=super.applyComponentToSubField(e,i,o);if("shop"==o){const c=e.selectEventSourceFor(g.DynamicEventType.VALUE_CHANGE);null!=c&&this.subscriptions.add(c.eventSource.subscribe({next:s=>{this.clearProduct()}}))}return n}clearProduct(){this.productSelectionMode=!1,this.parsingError=null,this.value&&(delete this.value.inError,delete this.value.cost),this.setSubFieldValue("cost",void 0),this.value&&delete this.value.priceDate,this.setSubFieldValue("priceDate",void 0),this.value&&delete this.value.urlInShop,this.setSubFieldValue("urlInShop",void 0),this.value&&delete this.value.idInShop,this.form.get("idInShop")?.setValue(null,{emitEvent:!1})}productNameChanged(e){this.clearProduct()}enableProductNameLookup(){if(null==this.value?.nameInShop&&null!=this.parentForm&&!this.productNameLinked){const e=this.guessProductParentComponent();null!=e&&(this.productNameLinked=!0,this.subscriptions.add(e.valueChanges.subscribe(i=>{const o=this.form.get("nameInShop");(null==o.value||""==o.value||i.startsWith(o.value))&&(null==this.value&&(this.value={}),this.value.nameInShop=i,o.setValue(i,{emitEvent:!1,emitModelToViewChange:!0}))})))}}guessProductParentComponent(){if(null!=this.parentForm){const e=P.DontCodeModelManager.guessNamePropertyOfObject(this.parentForm.controls);if(null!=e)return this.parentForm.controls[e]}return null}translateToError(e){const i={};return"string"==typeof e?(i.message=e,i):(null!=e.status&&(i.status=e.status),null!=e.statusText?i.message=e.statusText:null!=e.message&&(i.message=e.message),null!=e.url&&(i.url=e.url),null!=e.error&&(i.content=e.error),null==i.message&&(i.message=e.toString()),i)}performAction(e){var i=this;return(0,I.Z)(function*(){e.actionType==P.ActionType.EXTRACT&&(yield i.priceFinder.updatePriceIfPossible(i.value,i.parentPosition??"").then(o=>{null!=o&&(i.value.inError=!1,i.setSubFieldValue("cost",o.cost),i.setSubFieldValue("priceDate",new Date))}).catch(o=>{i.value.inError=!0,i.parsingError=i.translateToError(o),i.ref.markForCheck(),i.ref.detectChanges()}))})()}isInError(){return null!=this.parsingError}errorMessage(){if(null==this.parsingError)return"";{let e=this.parsingError.status?this.parsingError.status+":":"";return e+=this.parsingError.message,e}}static#t=this.\u0275fac=function(i){return new(i||r)(t.\u0275\u0275directiveInject(g.ComponentLoaderService),t.\u0275\u0275directiveInject(O),t.\u0275\u0275directiveInject(t.Injector),t.\u0275\u0275directiveInject(t.ChangeDetectorRef))};static#r=this.\u0275cmp=t.\u0275\u0275defineComponent({type:r,selectors:[["dontcode-commerce-price"]],viewQuery:function(i,o){if(1&i&&(t.\u0275\u0275viewQuery(se,7),t.\u0275\u0275viewQuery(ce,7)),2&i){let n;t.\u0275\u0275queryRefresh(n=t.\u0275\u0275loadQuery())&&(o.inlineView=n.first),t.\u0275\u0275queryRefresh(n=t.\u0275\u0275loadQuery())&&(o.fullEditView=n.first)}},features:[t.\u0275\u0275InheritDefinitionFeature],decls:7,vars:0,consts:[["inlineView",""],["priceView",""],["fullEditView",""],[4,"ngIf"],[3,"pTooltip","escape"],["target","_blank",3,"href"],[4,"ngTemplateOutlet"],["pButton","","type","button","class","p-button-rounded p-button-outlined p-button-danger","icon","pi pi-exclamation-triangle","pTooltip","Error reading this product price",4,"ngIf"],["pButton","","type","button","icon","pi pi-exclamation-triangle","pTooltip","Error reading this product price",1,"p-button-rounded","p-button-outlined","p-button-danger"],[3,"formGroup",4,"ngIf"],[3,"formGroup"],[1,"formgrid","grid"],[1,"field","col-12","md:col-6"],[1,"p-float-label"],["type","text","pInputText","","formControlName","nameInShop",1,"w-full",3,"id","input"],[3,"for"],[1,"flex","align-items-center"],["name","FetchPrice","pButton","","pRipple","","type","button",1,"flex","flex-initial","align-items-center","p-button-rounded","p-button-text",3,"icon","disabled","click"],[1,"flex","align-items-center","flex-1",2,"margin-top","0.5rem"],["type","text","pInputText","","formControlName","idInShop",1,"w-full"],["severity","error"],["pTemplate",""],["target","_blank",3,"href",4,"ngIf"],[1,"field","col-12",3,"id"],[3,"listOfProducts","selected"]],template:function(i,o){1&i&&(t.\u0275\u0275element(0,"dtcde-dynamic"),t.\u0275\u0275template(1,me,1,1,"ng-template",null,0,t.\u0275\u0275templateRefExtractor),t.\u0275\u0275template(3,ge,3,2,"ng-template",null,1,t.\u0275\u0275templateRefExtractor),t.\u0275\u0275template(5,be,1,1,"ng-template",null,2,t.\u0275\u0275templateRefExtractor))},dependencies:[y.NgIf,y.NgTemplateOutlet,g.DynamicInsertPoint,C.DefaultValueAccessor,C.NgControlStatus,C.NgControlStatusGroup,C.FormGroupDirective,C.FormControlName,U.InputText,N.PrimeTemplate,A.Ripple,E.ButtonDirective,D.Tooltip,F.Messages,ae]})}return r})(),M=(()=>{class r extends g.PluginBaseComponent{constructor(e,i,o){super(e,i,o)}providesTemplates(e){throw new Error("Method not implemented.")}canProvide(e){throw new Error("Method not implemented.")}handleChange(e){}static#e=this.\u0275fac=function(i){return new(i||r)(t.\u0275\u0275directiveInject(g.ComponentLoaderService),t.\u0275\u0275directiveInject(t.Injector),t.\u0275\u0275directiveInject(t.ChangeDetectorRef))};static#t=this.\u0275cmp=t.\u0275\u0275defineComponent({type:r,selectors:[["dontcode-commerce-price-compare"]],features:[t.\u0275\u0275InheritDefinitionFeature],decls:2,vars:0,template:function(i,o){1&i&&(t.\u0275\u0275elementStart(0,"h1"),t.\u0275\u0275text(1,"Hello from PriceCompareComponent !"),t.\u0275\u0275elementEnd())}})}return r})();var Y=_(54036),b=_(78905);function ve(r,d){if(1&r&&t.\u0275\u0275text(0),2&r){const e=t.\u0275\u0275nextContext();t.\u0275\u0275textInterpolate(e.value)}}function Re(r,d){if(1&r&&(t.\u0275\u0275elementStart(0,"div"),t.\u0275\u0275text(1),t.\u0275\u0275elementEnd()),2&r){const e=t.\u0275\u0275nextContext(4);t.\u0275\u0275advance(1),t.\u0275\u0275textInterpolate1(" ",e.value," ")}}function we(r,d){if(1&r&&t.\u0275\u0275template(0,Re,2,1,"div",7),2&r){const e=t.\u0275\u0275nextContext(3);t.\u0275\u0275property("ngIf",e.value)}}function Ue(r,d){1&r&&t.\u0275\u0275text(0),2&r&&t.\u0275\u0275textInterpolate1(" ",d.$implicit," ")}function Ae(r,d){if(1&r){const e=t.\u0275\u0275getCurrentView();t.\u0275\u0275elementContainerStart(0,3),t.\u0275\u0275elementStart(1,"p-dropdown",4),t.\u0275\u0275listener("onChange",function(o){t.\u0275\u0275restoreView(e);const n=t.\u0275\u0275nextContext(2);return t.\u0275\u0275resetView(n.valueChanged(o))}),t.\u0275\u0275template(2,we,1,1,"ng-template",5),t.\u0275\u0275template(3,Ue,1,1,"ng-template",6),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementContainerEnd()}if(2&r){const e=t.\u0275\u0275nextContext(2);t.\u0275\u0275property("formGroup",e.form),t.\u0275\u0275advance(1),t.\u0275\u0275property("options",e.options)("formControlName",e.name)("filter",!0)("showClear",!0)("lazy",!0)}}function De(r,d){if(1&r&&t.\u0275\u0275template(0,Ae,4,6,"ng-container",2),2&r){const e=t.\u0275\u0275nextContext();t.\u0275\u0275property("ngIf",e.form)}}let V=(()=>{class r extends g.AbstractReferenceComponent{constructor(e,i,o){super(e,i),this.ref=o}ngOnInit(){this.setTargetEntitiesWithName(T.SHOP_ENTITY_NAME,"Shop").then(e=>{e&&(this.ref.markForCheck(),this.ref.detectChanges())}).catch(e=>{console.error("Cannot set list of shops",e)})}setValue(e){if(null==e){const i=this.getForm(),o=i?.parent;if(null!=o&&!Array.isArray(o.controls))for(const n in o.controls)if(o.controls[n]===i){e=n;break}}super.setValue(e)}static#e=this.\u0275fac=function(i){return new(i||r)(t.\u0275\u0275directiveInject(P.DontCodeModelManager,8),t.\u0275\u0275directiveInject(P.DontCodeStoreManager,8),t.\u0275\u0275directiveInject(t.ChangeDetectorRef))};static#t=this.\u0275cmp=t.\u0275\u0275defineComponent({type:r,selectors:[["dontcode-commerce-shop"]],features:[t.\u0275\u0275InheritDefinitionFeature],decls:4,vars:0,consts:[["inlineView",""],["fullEditView",""],[3,"formGroup",4,"ngIf"],[3,"formGroup"],["placeholder","Select a shop",3,"options","formControlName","filter","showClear","lazy","onChange"],["pTemplate","selectedItem"],["pTemplate","item"],[4,"ngIf"]],template:function(i,o){1&i&&(t.\u0275\u0275template(0,ve,1,1,"ng-template",null,0,t.\u0275\u0275templateRefExtractor),t.\u0275\u0275template(2,De,1,1,"ng-template",null,1,t.\u0275\u0275templateRefExtractor))},dependencies:[y.NgIf,C.NgControlStatus,C.NgControlStatusGroup,C.FormGroupDirective,C.FormControlName,b.Dropdown,N.PrimeTemplate]})}return r})();const Fe=["inlineView"],Ge=["fullEditView"];function ke(r,d){if(1&r&&t.\u0275\u0275text(0),2&r){const e=t.\u0275\u0275nextContext();t.\u0275\u0275textInterpolate(e.displayableValue())}}function Le(r,d){if(1&r){const e=t.\u0275\u0275getCurrentView();t.\u0275\u0275elementContainerStart(0,3),t.\u0275\u0275elementStart(1,"span",4)(2,"p-dropdown",5),t.\u0275\u0275listener("onChange",function(o){t.\u0275\u0275restoreView(e);const n=t.\u0275\u0275nextContext(2);return t.\u0275\u0275resetView(n.valueChanged(o))}),t.\u0275\u0275elementEnd()(),t.\u0275\u0275elementContainerEnd()}if(2&r){const e=t.\u0275\u0275nextContext(2);t.\u0275\u0275property("formGroup",e.form),t.\u0275\u0275advance(2),t.\u0275\u0275property("options",e.shopTypes)("formControlName",e.name)}}function Me(r,d){if(1&r&&t.\u0275\u0275template(0,Le,3,3,"ng-container",2),2&r){const e=t.\u0275\u0275nextContext();t.\u0275\u0275property("ngIf",e.form)}}let H=(()=>{class r extends g.AbstractDynamicComponent{constructor(e){super(),this.priceFinder=e,this.shopTypes=new Array,this.valueChange=new t.EventEmitter,this.shopTypes=this.priceFinder.getListOfShopTypes()}createAndRegisterFormControls(){this.form.registerControl(this.name,new C.FormControl(null,{updateOn:"change"}))}providesTemplates(e){return new g.TemplateList(this.inlineView,null,this.fullEditView)}canProvide(e){return new g.PossibleTemplateList(!0,!1,!0)}displayableValue(){return g.AbstractDynamicComponent.toBeautifyString(this.value)??""}listEventSources(){const e=super.listEventSources();return e.push(new g.BaseDynamicEventSource("Value",g.DynamicEventType.VALUE_CHANGE,this.valueChange.asObservable())),e}valueChanged(e){this.valueChange.emit(new g.BaseDynamicEvent("Value",g.DynamicEventType.VALUE_CHANGE,e.value))}static#e=this.\u0275fac=function(i){return new(i||r)(t.\u0275\u0275directiveInject(O))};static#t=this.\u0275cmp=t.\u0275\u0275defineComponent({type:r,selectors:[["dontcode-commerce-shop-type"]],viewQuery:function(i,o){if(1&i&&(t.\u0275\u0275viewQuery(Fe,7),t.\u0275\u0275viewQuery(Ge,7)),2&i){let n;t.\u0275\u0275queryRefresh(n=t.\u0275\u0275loadQuery())&&(o.inlineView=n.first),t.\u0275\u0275queryRefresh(n=t.\u0275\u0275loadQuery())&&(o.fullEditView=n.first)}},outputs:{valueChange:"valueChange"},features:[t.\u0275\u0275InheritDefinitionFeature],decls:4,vars:0,consts:[["inlineView",""],["fullEditView",""],[3,"formGroup",4,"ngIf"],[3,"formGroup"],[1,"p-float-label"],["name","shop","placeholder","Please select a Shop",1,"w-full",3,"options","formControlName","onChange"]],template:function(i,o){1&i&&(t.\u0275\u0275template(0,ke,1,1,"ng-template",null,0,t.\u0275\u0275templateRefExtractor),t.\u0275\u0275template(2,Me,1,1,"ng-template",null,1,t.\u0275\u0275templateRefExtractor))},dependencies:[y.NgIf,C.NgControlStatus,C.NgControlStatusGroup,C.FormGroupDirective,C.FormControlName,b.Dropdown]})}return r})();var Ye=_(38256);class Ve extends S{constructor(d){super(d)}searchProductsForNameOrId(d,e){return Promise.reject("Not implemented")}callUrlWithProxy(d,e){var i=this;return(0,I.Z)(function*(){const o=e;return yield i.requestWithProxy("GET",d,o,{observe:"response",responseType:"text"})})()}}let B=(()=>{class r{constructor(){console.log("Commerce Plugin registering"),P.dtcde.registerPlugin(new T)}exposedPreviewHandlers(){return new Map([["PriceComponent",L],["PriceCompareComponent",M],["ShopHandlerComponent",V],["ShopTypeHandlerComponent",H]])}static#e=this.\u0275fac=function(i){return new(i||r)};static#t=this.\u0275mod=t.\u0275\u0275defineNgModule({type:r,id:"dontcode-plugin/commerce"});static#r=this.\u0275inj=t.\u0275\u0275defineInjector({imports:[y.CommonModule,g.PluginCommonModule.forRoot(),Y.BasicModule,Y.FieldsModule,C.ReactiveFormsModule,U.InputTextModule,C.FormsModule,b.DropdownModule,A.RippleModule,E.ButtonModule,G.DataViewModule,k.CardModule,D.TooltipModule,Ye.MessageModule,F.MessagesModule]})}return r})();t.\u0275\u0275registerNgModuleType(B,"dontcode-plugin/commerce")}}]);