(self.webpackChunkcommerce_tester=self.webpackChunkcommerce_tester||[]).push([[4638],{44638:(He,j,_)=>{_.r(j),_.d(j,{AbstractOnlineShopScrapper:()=>m,CommerceModule:()=>U,DynamicProxyScrapper:()=>Ye,PriceCompareComponent:()=>k,PriceComponent:()=>I,PriceFinderService:()=>y,ProxyEngine:()=>u,ScrappedProduct:()=>S,ShopHandlerComponent:()=>L,ShopTypeHandlerComponent:()=>M});var A=_(57863),D=_(15861),g=_(17401),C=_(27022),P=_(67138),q=_(16602),W=_(92256);class S{constructor(){this.productName=null,this.outOfStock=!1}}class m{static toMoneyAmount(e){const r=new P.MoneyAmount;return r.amount=e.productPrice,r.currencyCode=e.currencyCode,r}constructor(e){this.http=e,this.onlineShopName="Unknown"}getOnlineShopName(){return this.onlineShopName}getShopTypeName(){return this.onlineShopName}requestWithProxy(e,r,o,n){return(0,W.firstValueFrom)(this.http.request(e,this.encodeUrlForCors(r,o),this.updateOptionsForCors(e,r,o,n))).catch(a=>Promise.reject({url:r,engine:o,error:a}))}encodeUrlForCors(e,r){let o=e;switch(r){case u.CORSPROXY_IO:o=m.CORS_PROXY_URL+encodeURIComponent(e);break;case u.CORSPROXY_ORG:o=m.CORS_PROXY_ORG_URL+encodeURIComponent(e);break;case u.CHROME_ENGINE:case u.DONT_CODE:o=m.CORS_DONTCODE_PROXY_URL;break;case u.WEBSCRAPING_IA:o=m.WEBSCRAPING_PROXY_URL}return o}updateOptionsForCors(e,r,o,n){switch(o){case u.CORSPROXY_IO:case u.CORSPROXY_ORG:n.withCredentials=!1;break;case u.CHROME_ENGINE:case u.DONT_CODE:this.addToHttpParams(n,{url:encodeURIComponent(r)}),o===u.CHROME_ENGINE&&this.addToHttpParams(n,{engine:"chrome"});break;case u.WEBSCRAPING_IA:this.addToHttpParams(n,{proxy:"datacenter",js:!1,api_key:m.WEBSCRAPING_PROXY_API_KEY,url:r})}return n}updatePrice(e,r){let o=e.productId;return null==r&&(r=!1),(r||null==o)&&(o=e.productName??void 0,r=!0),null==o?Promise.reject("You must define a product with a name or id "):this.searchProductsForNameOrId(o,!r).then(n=>{for(const a of n)if(a.productId==e.productId)return a;return null}).then(n=>null!=n||r||null==e.productName?n??Promise.reject("Product "+o+" not found in shoptype "+this.onlineShopName):this.searchProductsForNameOrId(e.productName,!1).then(a=>{for(const c of a)if(c.productId==e.productId)return c;return Promise.reject("Product "+o+" not found in shoptype "+this.onlineShopName)}))}standardHeaders(){return new q.HttpHeaders({})}checkScrappedProduct(e,r){if(null==r.productId||0==r.productId.length)throw new Error("No Product Id scrapped by shop "+this.getOnlineShopName()+" for product search "+e);if(null==r.productName||0==r.productName.length)throw new Error("No Product Name scrapped by shop "+this.getOnlineShopName()+" for product search "+e);if((null==r.productPrice||isNaN(r.productPrice))&&1!=r.outOfStock)throw new Error("Incorrect Product Price "+r.productPrice+" scrapped by shop "+this.getOnlineShopName()+" for product search "+e)}checkStringPosition(e,r){if(-1==e||-1!=r&&e>r)throw new Error("Error decoding product for Scrapper "+this.getOnlineShopName())}indexOf(e,r,o,n,a=!0){const c=e.indexOf(r,o);return-1==c?c:null!=n&&-1!=n&&c>n?-1:a?c+r.length:c}safeIndexOf(e,r,o,n,a=!0){const c=e.indexOf(r,o);if(-1==c)throw new Error("Cannot find "+r+" for "+this.getOnlineShopName());if(null!=n&&-1!=n&&c>n)throw new Error("The product content does not contains "+r+" for "+this.getOnlineShopName());return a?c+r.length:c}addToHttpParams(e,r){e.params=null==e.params?r:null!=e.params.appendAll?e.params.appendAll(r):{...e.params,...r}}}m.CORS_PROXY_URL="https://corsproxy.io/?",m.CORS_PROXY_ORG_URL="https://corsproxy.org/?",m.WEBSCRAPING_PROXY_URL="https://api.webscraping.ai/html",m.WEBSCRAPING_PROXY_API_KEY="f4fe0d0b-bfa9-49bd-a3f7-404be7bcad85",m.CORS_DONTCODE_PROXY_URL="https://shared.collin.best/proxy/debug";var u=(()=>{return(s=u||(u={})).CORSPROXY_IO="CORSPROXY.IO",s.CORSPROXY_ORG="CORSPROXY.ORG",s.WEBSCRAPING_IA="WEBSCRAPING.IA",s.DONT_CODE="DONT-CODE.PROXY",s.CHROME_ENGINE="DONT-CODE.CHROME",u;var s})(),t=_(30549);class F extends m{constructor(e){super(e),this.onlineShopName="EasyParapharmacie"}searchProductsForNameOrId(e,r){let o=JSON.stringify(F.JSON_QUERY);return o=o.replace("QUERY_STRING",encodeURIComponent(e)),o=JSON.parse(o),this.requestWithProxy("POST",F.SEARCH_ONLINE_URL,u.CORSPROXY_IO,{body:o,responseType:"json",observe:"body"}).then(n=>{"string"==typeof n&&(n=JSON.parse(n));const a=new Array,c=n.results;if(c.length>0){const p=c[0].hits;if(null!=p)for(const i of p){const l=new S;l.productPrice=i.price.EUR.default,l.currencyCode="EUR",l.productName=i.name,l.productDescription=i.short_description??i.description,l.productId=i.ean_code?.toString(),null==l.productId&&(console.warn("Product "+l.productName+" searched by "+e+" for Shop "+this.getOnlineShopName()+" has no ean_code, getting objectId instead"),l.productId=i.objectID),l.productUrl=i.url,l.productImageUrl=i.image_url,this.checkScrappedProduct(e,l),a.push(l)}}return a})}}F.SEARCH_ONLINE_URL="https://jhu6zvksfy-dsn.algolia.net/1/indexes/*/queries?x-algolia-agent=Algolia+for+JavaScript+%283.35.1%29%3B+Browser%3B+Magento2+integration+%283.6.0%29%3B+autocomplete.js+0.38.0&x-algolia-application-id=JHU6ZVKSFY&x-algolia-api-key=YTYyYzkyNzgyZDliZTZlMDk1OGE1MDQwNjRkYWY1ZmY4ZTE5OWZhYmU4ZGUyNTM2NDFjNmU4YjllNWMwNmJmNXRhZ0ZpbHRlcnM9\n",F.JSON_QUERY={requests:[{indexName:"prod_magento2_fr_products",params:"query=QUERY_STRING&hitsPerPage=6&analyticsTags=autocomplete&clickAnalytics=true&facets=%5B%22categories.level0%22%5D&numericFilters=visibility_search%3D1&ruleContexts=%5B%22magento_filters%22%2C%22%22%5D"},{indexName:"prod_magento2_fr_section_manufacturer",params:"query=chardon%20marie&hitsPerPage=6&analyticsTags=autocomplete&clickAnalytics=true"},{indexName:"prod_magento2_fr_categories",params:"query=chardon%20marie&hitsPerPage=4&analyticsTags=autocomplete&clickAnalytics=true&numericFilters=include_in_menu%3D1"}]};class v extends m{constructor(e){super(e),this.onlineShopName="GreenWeez"}searchProductsForNameOrId(e,r){let o=JSON.stringify(v.JSON_QUERY);return o=o.replace("QUERY_STRING",encodeURIComponent(e)),o=o.replace("QUERY_STRING",encodeURIComponent(e)),o=o.replace("QUERY_STRING",encodeURIComponent(e)),o=JSON.parse(o),this.requestWithProxy("POST",v.SEARCH_ONLINE_URL,u.DONT_CODE,{body:o,responseType:"json",observe:"body"}).then(n=>{"string"==typeof n&&(n=JSON.parse(n));const a=new Array,c=n.results;if(c.length>0){const p=c[0].hits;if(null!=p)for(const i of p){const l=new S;l.productPrice=i.shop_data.pricing.priceIncludedVat/100,l.currencyCode="EUR",l.productName=i.name,l.productDescription=void 0,l.productId=i.shop_data.variant.code,l.productUrl=this.calculateProductUrl(i.shop_data),l.productImageUrl=this.findImageUrl(i.shop_data.variant.images),l.marketPlace=!0===i.flags.marketPlace,this.checkScrappedProduct(e,l),a.push(l)}}return a})}calculateProductUrl(e){return v.BASE_URL+"/produit/"+e.variant.product.slug+"/"+e.variant.code+"/"+e.id}findImageUrl(e){for(const r of e)if("variant"==r.type)return v.BASE_URL+"/_next/image?url=https%3A%2F%2Fcdn.greenweez.com%2Fproducts%2F"+r.path+"&w=640&q=75"}}v.SEARCH_ONLINE_URL="https://54m7x8foua-dsn.algolia.net/1/indexes/*/queries?x-algolia-agent=Algolia for JavaScript (4.14.2); Browser (lite); instantsearch.js (4.48.0); react (17.0.2); react-instantsearch (6.36.0); react-instantsearch-hooks (6.36.0); JS Helper (3.11.1)&x-algolia-api-key=52441d0a775f924291679b7c224d6782&x-algolia-application-id=54M7X8FOUA",v.BASE_URL="https://greenweez.com",v.JSON_QUERY={requests:[{indexName:"france_prod_offers_genepi_fr_FR",params:"attributesToRetrieve=%5B%22main_category%22%2C%22attributes%22%2C%22capacity%22%2C%22discount.percent%22%2C%22flags%22%2C%22ObjectID%22%2C%22name%22%2C%22options.color.available_colors%22%2C%22seller%22%2C%22shop_data.id%22%2C%22shop_data.variant.images%22%2C%22shop_data.variant.product.id%22%2C%22shop_data.variant.product.legacyId%22%2C%22shop_data.variant.product.slug%22%2C%22shop_data.variant.product.brand.name%22%2C%22shop_data.variant.code%22%2C%22shop_data.sellerCatalog.seller%22%2C%22shop_data.pricing%22%2C%22shop_data.offerData%22%2C%22shop_data.onHand%22%2C%22stats%22%5D&clickAnalytics=true&facets=%5B%5D&filters=has_parent_objectID%3D0&highlightPostTag=__%2Fais-highlight__&highlightPreTag=__ais-highlight__&hitsPerPage=20&query=QUERY_STRING&tagFilters="},{indexName:"france_prod_brands_genepi_fr_FR",params:"attributesToRetrieve=%5B%22name%22%2C%22slug%22%5D&clickAnalytics=true&facets=%5B%5D&filters=&highlightPostTag=__%2Fais-highlight__&highlightPreTag=__ais-highlight__&hitsPerPage=6&query=QUERY_STRING&tagFilters="},{indexName:"france_prod_categories_genepi_fr_FR",params:"attributesToRetrieve=%5B%22parent%22%2C%22name%22%2C%22slug%22%2C%22level%22%5D&clickAnalytics=true&facets=%5B%5D&filters=&highlightPostTag=__%2Fais-highlight__&highlightPreTag=__ais-highlight__&hitsPerPage=6&query=QUERY_STRING&tagFilters="}]};class V{getConfiguration(){return{plugin:{id:"CommercePlugin","display-name":"Commerce Plugin for anything related to products, prices, shops.",version:"1.0.0"},"schema-updates":[{id:"price-field",description:"A price of a product in a shop",changes:[{location:{parent:"#/$defs/field",id:"type"},update:{enum:[{Commerce:{enum:["Price","Shop","Shop type"]}}]},replace:!1}]}],"preview-handlers":[{location:{parent:P.DontCodeModel.APP_FIELDS,id:"type",values:[{Commerce:{enum:["Price"]}}]},class:{name:"PriceComponent",source:"commerce"}},{location:{parent:P.DontCodeModel.APP_FIELDS,id:"type",values:[{Commerce:{enum:["Shop"]}}]},class:{name:"ShopHandlerComponent",source:"commerce"}},{location:{parent:P.DontCodeModel.APP_FIELDS,id:"type",values:[{Commerce:{enum:["Shop type"]}}]},class:{name:"ShopTypeHandlerComponent",source:"commerce"}}]}}pluginInit(e){}}V.SHOP_ENTITY_NAME="Online Shop";class R extends m{constructor(e){super(e),this.onlineShopName="NewPharma"}searchProductsForNameOrId(e,r){const o=R.SEARCH_ONLINE_URL.replace("QUERY_STRING",encodeURIComponent(e)),n=this.standardHeaders();return this.requestWithProxy("GET",o,u.CHROME_ENGINE,{headers:n,withCredentials:!1,responseType:"text",observe:"body"}).then(a=>{const c=new Array;let p=a.indexOf(R.PRODUCT_START_STRING);for(;p>=0;){const i=new S;let l=a.indexOf('data-productid="',p)+16;i.productId=a.substring(l,a.indexOf('"',l+1)),l=a.indexOf('<a class="details__title',p)+24,l=a.indexOf('title="',l+1)+7,i.productName=a.substring(l,a.indexOf('"',l+1)),i.productDescription=void 0,l=a.indexOf('href="',p)+6,i.productUrl=a.substring(l,a.indexOf('"',l+1)),l=a.indexOf('<img src="',p+1)+10,i.productImageUrl=a.substring(l,a.indexOf('"',l+1)),this.extractPrice(a,p,i),this.checkScrappedProduct(e,i),c.push(i),p=a.indexOf(R.PRODUCT_START_STRING,p+1)}return c})}extractPrice(e,r,o){let n=e.indexOf('data-content_ids="['+o.productId+']"',r+1);if(-1==n&&(n=e.indexOf('data-content_ids="'+o.productId+'"',r+1)),-1!=n){let a=e.indexOf('data-currency="',n)+15;o.currencyCode=e.substring(a,e.indexOf('"',a+1)),a=e.indexOf('data-value="',n)+12,o.productPrice=parseFloat(e.substring(a,e.indexOf('"',a+1)))}}updatePrice(e,r){return null==e.productUrl?super.updatePrice(e,!0):this.requestWithProxy("GET",e.productUrl,u.CHROME_ENGINE,{headers:{Accept:"text/html"},withCredentials:!1,responseType:"text",observe:"body"}).then(o=>{const n={productId:e.productId,productName:e.productName};return this.extractPrice(o,0,n),this.checkScrappedProduct(e.productName??"",n),e.productPrice=n.productPrice,e.currencyCode=n.currencyCode,e}).catch(o=>(console.error("Error trying to access page for product "+e.productName,o),super.updatePrice(e,!0)))}}R.SEARCH_ONLINE_URL="https://www.newpharma.fr/search-results/search.html?q=QUERY_STRING",R.PRODUCT_START_STRING='<div class="product js-product-row product--desktop';class w extends m{constructor(e){super(e),this.onlineShopName="WebEcologie"}searchProductsForNameOrId(e,r){const o=w.SEARCH_ONLINE_URL.replace("QUERY_STRING",encodeURIComponent(e));return this.requestWithProxy("GET",o,u.DONT_CODE,{headers:{Accept:"text/html"},responseType:"text",observe:"body"}).then(n=>{const a=new Array;let c=n.indexOf(w.PRODUCT_START_STRING);for(;c>=0;){const p=new S;let i=n.indexOf('href="',c)+6;p.productUrl=n.substring(i,n.indexOf('"',i+1)),i=n.indexOf('title="',c)+7,p.productName=n.substring(i,n.indexOf('"',i+1)),p.productDescription=void 0,i=n.indexOf('src="',c+1)+5,p.productImageUrl=n.substring(i,n.indexOf('"',i+1));const l=n.indexOf('<a class="addToWishlist',c)+23;i=n.indexOf('rel="',l)+5,p.productId=n.substring(i,n.indexOf('"',i+1)),this.extractPrice(n,c,p),this.checkScrappedProduct(e,p),a.push(p),c=n.indexOf(w.PRODUCT_START_STRING,c+1)}return a})}extractPrice(e,r,o){let n=e.indexOf('class="price-first-part">',r)+25,a=Number.parseInt(e.substring(n,e.indexOf("<",n+1)));n=e.indexOf('class="price-last-part">',r)+24,a+=Number.parseInt(e.substring(n,e.indexOf("<",n+1)))/100,o.productPrice=a,n=e.indexOf('itemprop="priceCurrency"',r)+24,n=e.indexOf('content="',n)+9,o.currencyCode=e.substring(n,e.indexOf('"',n+1))}updatePrice(e,r){return null==e.productUrl?super.updatePrice(e,!0):this.requestWithProxy("GET",e.productUrl,u.DONT_CODE,{headers:{Accept:"text/html"},responseType:"text",observe:"body"}).then(o=>{const n={productId:e.productId,productName:e.productName};return this.extractPrice(o,0,n),this.checkScrappedProduct(e.productName??"Unknown",n),e.productPrice=n.productPrice,e.currencyCode=n.currencyCode,e}).catch(o=>(console.error("Error trying to access page for product "+e.productName,o),super.updatePrice(e,!0)))}}w.SEARCH_ONLINE_URL="https://www.webecologie.com/rechercher?search_query=QUERY_STRING",w.PRODUCT_START_STRING='<a class="product_img_link"';class b extends m{constructor(e){super(e),this.onlineShopName="Boulanger"}searchProductsForNameOrId(e,r){e=e.normalize("NFD").replace(/\p{Diacritic}/gu,"");const o=b.SEARCH_ONLINE_URL.replace("QUERY_STRING",e);return this.requestWithProxy("GET",o,u.CORSPROXY_IO,{observe:"body",responseType:"text"}).then(n=>this.analysePageResult(e,n)).catch(n=>null==n.code||"Unknown Error"===n.statusText?this.requestWithProxy("GET",o,u.WEBSCRAPING_IA,{observe:"body",responseType:"text"}).then(a=>this.analysePageResult(e,a)):n)}analysePageResult(e,r){const o=new Array;let n=r.indexOf(b.PRODUCT_START_STRING);for(;n>=0;){const a=new S;let c=r.indexOf('href="',n)+6;a.productUrl=b.BASE_URL+r.substring(c,r.indexOf('"',c+1)),c=r.indexOf('data-product-label="',n)+20,a.productName=r.substring(c,r.indexOf('"',c+1)),a.productDescription=void 0,c=r.indexOf('<img src="',n+1)+10,a.productImageUrl=r.substring(c,r.indexOf('"',c+1)),c=r.indexOf('data-product-id="',n)+17,a.productId=r.substring(c,r.indexOf('"',c+1)),this.extractPrice(r,n,a),this.checkScrappedProduct(e,a),o.push(a),n=r.indexOf(b.PRODUCT_START_STRING,n+1)}return o}extractPrice(e,r,o){const n=e.indexOf('data-analytics_product_unitprice_ati="',r)+38,a=Number.parseFloat(e.substring(n,e.indexOf('"',n+1)));o.productPrice=a,o.currencyCode="EUR"}}b.SEARCH_ONLINE_URL="https://www.boulanger.com/resultats?tr=QUERY_STRING",b.PRODUCT_START_STRING="<article",b.BASE_URL="https://www.boulanger.com";class T extends m{constructor(e){super(e),this.onlineShopName="Darty",this.httpHeaders={"x-algolia-api-key":"740b60dee22b6ca679462288f6cd9c7b","x-algolia-application-id":"Z0YPI1PLPQ"}}searchProductsForNameOrId(e,r){let o=JSON.stringify(T.JSON_QUERY);return o=o.replace("QUERY_STRING",e),o=o.replace("QUERY_STRING",e),o=JSON.parse(o),this.requestWithProxy("POST",T.SEARCH_ONLINE_URL,u.CORSPROXY_IO,{body:o,headers:this.httpHeaders,responseType:"json",observe:"body"}).then(n=>{"string"==typeof n&&(n=JSON.parse(n));const a=new Array,c=n.results;if(c.length>0){const p=c[0].hits;if(null!=p)for(const i of p){const l=new S;l.productPrice=this.extractPrice(i),l.currencyCode="EUR",l.productName=i.reference,l.productDescription=void 0,l.productId=i.codic,l.productUrl=T.BASE_URL+"/nav/codic/"+i.codic,i.pictures?.length>0&&(l.productImageUrl=T.BASE_IMAGE_URL.replace("IMAGE_URL",i.pictures[0].algoliaPict)),this.checkScrappedProduct(e,l),a.push(l)}}return a})}updatePrice(e,r){return super.updatePrice(e,!0)}extractPrice(e){if(null!=e.priceSort)return e.priceSort/100;if(null!=e.dartyExclusivePriceSort)return e.dartyExclusivePriceSort/100;let r=0;for(const o in e.prices.stores)("000000"===o||"dartyExclusive"===o&&0===r||0===r)&&(r=e.prices.stores[o]/100);return r}}T.SEARCH_ONLINE_URL="https://z0ypi1plpq-dsn.algolia.net/1/indexes/*/queries?x-algolia-agent=Algolia+for+JavaScript+%284.17.0%29%3B+Browser",T.JSON_QUERY={requests:[{indexName:"darty_prod_es6",query:"QUERY_STRING",params:"hitsPerPage=4&tagFilters=%5B%22dcom%22%5D"},{indexName:"darty_prod_es6_query_suggestions",query:"QUERY_STRING",params:"hitsPerPage=5"}]},T.BASE_URL="https://www.darty.com",T.BASE_IMAGE_URL="https://image.darty.com/darty?type=image&source=IMAGE_URL&width=120&heigth=180&quality=80";class O extends m{constructor(e){super(e),this.onlineShopName="CDiscount"}searchProductsForNameOrId(e,r){const o=O.SEARCH_ONLINE_URL.replace("QUERY_STRING",encodeURIComponent(e));return this.requestWithProxy("GET",o,u.CORSPROXY_ORG,{headers:{Accept:"text/html"},responseType:"text",observe:"body"}).then(n=>{const a=new Array;let c=n.indexOf(O.PRODUCT_START_STRING);for(c=n.indexOf(O.PRODUCT_START_STRING,c+1);c>=0;){const p=n.indexOf(O.PRODUCT_START_STRING,c+1),i=new S;let l=this.safeIndexOf(n,'href="',c,p);i.productUrl=n.substring(l,this.safeIndexOf(n,'"',l+1,p,!1)),l=this.indexOf(n,'<h2 class="prdtTit">',c,p),-1==l&&(l=this.indexOf(n,'<h2 class="prdtBILTit">',c,p)),i.productName=n.substring(l,this.safeIndexOf(n,"</h2>",l+1,p,!1)),i.productDescription=void 0,l=this.safeIndexOf(n,'src="',c+1,p),i.productImageUrl=n.substring(l,this.safeIndexOf(n,'"',l+1,p,!1)),l=this.safeIndexOf(n,'data-productid="',c,p),i.productId=n.substring(l,this.safeIndexOf(n,'"',l+1,p,!1)),this.extractPrice(n,c,p,i),this.checkScrappedProduct(e,i),a.push(i),c=n.indexOf(O.PRODUCT_START_STRING,c+1)}return a})}extractPrice(e,r,o,n){let a=this.indexOf(e,'<span class="price priceColor hideFromPro">',r,o);if(-1!=a){const c=this.safeIndexOf(e,",",a+1,o,!1),p=Number.parseInt(e.substring(a,c)),i=Number.parseInt(e.substring(c+1,this.safeIndexOf(e,"&euro;",c+1,o,!1)));n.productPrice=p+i/100}else{a=this.safeIndexOf(e,'<span class="hideFromPro priceColor price">',r,o);const c=Number.parseInt(e.substring(a,this.safeIndexOf(e,"<sup>",a+1,o,!1))),p=Number.parseInt(e.substring(this.safeIndexOf(e,"</sup>",a+1,o,!1)-2,this.safeIndexOf(e,"</sup>",a+1,o,!1)));n.productPrice=c+p/100}n.currencyCode="EUR"}}O.SEARCH_ONLINE_URL="https://www.cdiscount.com/search/10/QUERY_STRING.html",O.PRODUCT_START_STRING='<li data-sku="',O.BASE_URL="https://www.cdiscount.com";class x extends m{constructor(e){super(e),this.onlineShopName="Amazon"}searchProductsForNameOrId(e,r){const o=x.SEARCH_ONLINE_URL.replace("QUERY_STRING",encodeURIComponent(e));return this.requestWithProxy("GET",o,u.DONT_CODE,{headers:{Accept:"text/html"},responseType:"text",observe:"body"}).catch(n=>(console.error("Error getting amazon price with DontCode Proxy",n),null!=n.status&&n.status>=500?this.requestWithProxy("GET",o,u.CORSPROXY_IO,{headers:{Accept:"text/html"},responseType:"text",observe:"body"}):Promise.reject(n))).catch(n=>(console.error("Error getting amazon price with CorsProxyIO",n),null!=n.status&&n.status>=500?this.requestWithProxy("GET",o,u.WEBSCRAPING_IA,{headers:{Accept:"text/html"},responseType:"text",observe:"body"}):Promise.reject(n))).then(n=>{const a=new Array;let c=n.indexOf(x.PRODUCT_START_STRING);for(;c>=0;){const p=n.indexOf(x.PRODUCT_START_STRING,c+1),i=n.substring(c,p),l=new S,f=i.indexOf('data-component-type="s-product-image"');let d=i.indexOf('data-asin="')+11;if('"'==i.charAt(d)||-1==f){c=n.indexOf(x.PRODUCT_START_STRING,c+1);continue}l.productId=i.substring(d,i.indexOf('"',d+1)),d=i.indexOf('href="',f)+6;let h=i.substring(d,i.indexOf('"',d+1));if(h.startsWith("/sspa/click")){const Ve=h.indexOf("url=")+4;h=h.substring(Ve),h=h.replace(/%2F/g,"/")}l.productUrl=x.BASE_URL+h,d=i.indexOf('src="',f+1)+5,l.productImageUrl=i.substring(d,i.indexOf('"',d+1)),d=i.indexOf('a-text-normal">',f)+15,l.productDescription=i.substring(d,i.indexOf("<",d+1)),l.productName=null!=l.productDescription&&l.productDescription?.length>60?l.productDescription.substring(0,60):l.productDescription||null,d=i.indexOf('data-asin="')+11,l.productId=i.substring(d,i.indexOf('"',d+1)),this.extractPrice(i,f,l),this.checkScrappedProduct(e,l),a.push(l),c=i.indexOf(x.PRODUCT_START_STRING,c+1)}return a})}extractPrice(e,r,o){const n=e.indexOf('<span class="a-price-whole">',r)+28;let a=e.substring(n,e.indexOf("</span>",n+1));a=a.replace(",","."),o.productPrice=Number.parseFloat(a),o.currencyCode="EUR"}}x.SEARCH_ONLINE_URL="https://www.amazon.fr/s?k=QUERY_STRING",x.PRODUCT_START_STRING='<div data-asin="',x.BASE_URL="https://www.amazon.fr";class N extends m{constructor(){super(...arguments),this.onlineShopName="Fnac"}searchProductsForNameOrId(e,r){const o=e.split(" ");let n="";for(const c of o)n+=encodeURIComponent(c)+"+";o.length>=1&&(n=n.substring(0,n.length-1));const a=N.SEARCH_ONLINE_URL.replace("QUERY_STRING",n);return this.requestWithProxy("GET",a,u.DONT_CODE,{headers:{Accept:"text/html"},responseType:"text",observe:"body",withCredentials:!0}).then(c=>{const p=new Array;let i=c.indexOf(N.PRODUCT_START_STRING),l=c.indexOf(N.PRODUCT_START_STRING,i+1);for(;i>=0;){const f=new S;let d=this.safeIndexOf(c,'id="',i,l);f.productId=c.substring(d,c.indexOf('"',d+1));let h=this.safeIndexOf(c,'<img class="Article-itemVisualImg',i,l);d=this.indexOf(c,'data-lazyimage="',h),-1==d&&(d=this.safeIndexOf(c,'src="',h,l)),f.productImageUrl=c.substring(d,c.indexOf('"',d+1)),d=this.safeIndexOf(c,'alt="',h,l),f.productName=c.substring(d,c.indexOf('"',d+1)),f.productDescription=void 0,h=this.safeIndexOf(c,'<p class="Article-desc',i,l),d=this.safeIndexOf(c,'href="',h,l),f.productUrl=c.substring(d,c.indexOf('"',d+1)),d=c.indexOf("vendeur partenaire",i),f.marketPlace=-1!=d&&(-1==l||d<l),d=c.indexOf("En stock",i),f.outOfStock=-1==d||!(-1==l||d<l),this.extractPrice(c,i,f,l),null==f.productPrice&&(f.outOfStock=!0),this.checkScrappedProduct(e,f),p.push(f),i=c.indexOf(N.PRODUCT_START_STRING,i+1),l=c.indexOf(N.PRODUCT_START_STRING,i+1)}return p})}extractPrice(e,r,o,n){const a=this.indexOf(e,'class="userPrice">',r,n);if(-1==a)return void(o.productPrice=void 0);const c=this.indexOf(e,"<sup>",a+1,n,!1);let p=0;if(-1==c)p=Number.parseInt(e.substring(a,this.safeIndexOf(e,"&euro;",a+1,n,!1))),o.productPrice=p;else{p=Number.parseInt(e.substring(a,c));const i=Number.parseInt(e.substring(this.safeIndexOf(e,"</sup>",a+1,n,!1)-2,this.safeIndexOf(e,"</sup>",a+1,n)));o.productPrice=p+i/100}o.currencyCode="EUR"}updatePrice(e,r){return null==e.productUrl?super.updatePrice(e,!0):this.requestWithProxy("GET",e.productUrl,u.DONT_CODE,{headers:{Accept:"text/html"},responseType:"text",observe:"body"}).then(o=>{const n={productId:e.productId,productName:e.productName},a=this.safeIndexOf(o,"userPrice",0),c=this.safeIndexOf(o,'data-price="',a);return n.productPrice=Number.parseFloat(o.substring(c,this.safeIndexOf(o,'"',c+1)).replace(",",".")),n.currencyCode="EUR",this.checkScrappedProduct(e.productName??"",n),e.productPrice=n.productPrice,e.currencyCode=n.currencyCode,e}).catch(o=>(console.error("Error trying to access page for product "+e.productName,o),super.updatePrice(e,!0)))}}N.SEARCH_ONLINE_URL="https://www.fnac.com/SearchResult/ResultList.aspx?SCat=0&Search=QUERY_STRING&sft=1&sa=0",N.PRODUCT_START_STRING='<div class="clearfix Article-item',N.BASE_URL="https://www.fnac.com";class E extends m{constructor(e){super(e),this.onlineShopName="Onatera"}searchProductsForNameOrId(e,r){let o=JSON.stringify(E.JSON_QUERY);return o=o.replace(/QUERY_STRING/g,encodeURIComponent(e)),o=JSON.parse(o),this.requestWithProxy("POST",E.SEARCH_ONLINE_URL,u.CORSPROXY_IO,{body:o,responseType:"json",observe:"body"}).then(n=>{"string"==typeof n&&(n=JSON.parse(n));const a=new Array,c=n.results;if(c.length>0)for(const p of c){const i=p.hits;if(null!=i)for(const l of i)if(1==l.is_active){const f=l.name+" "+l.brand_name+" ";if(null!=l.variants)for(const d of l.variants){const h=new S;h.productPrice=d.price/100,h.outOfStock=!d.hasStock,h.currencyCode="EUR",h.productName=f+d.name,h.productDescription=d.shortDescription??d.description,h.productId=d.productVariantId.toString(),h.productUrl=E.BASE_URL+d.url,h.productImageUrl=E.IMAGE_BASE_URL+d.picture_path,this.checkScrappedProduct(e,h),a.push(h)}}}return a})}}E.SEARCH_ONLINE_URL="https://f75bb6q2sy-dsn.algolia.net/1/indexes/*/queries?x-algolia-agent=Algolia+for+JavaScript+%284.11.0%29%3B+Browser+%28lite%29%3B+instantsearch.js+%284.41.0%29%3B+Vue+%282.6.14%29%3B+Vue+InstantSearch+%284.3.3%29%3B+JS+Helper+%283.8.2%29&x-algolia-api-key=f319f4e4b15d239ba0509b3c6c4a0ecd&x-algolia-application-id=F75BB6Q2SY",E.BASE_URL="https://onatera.com",E.IMAGE_BASE_URL="https://media.onatera.com/cache/product_image_listing_DM/",E.JSON_QUERY={requests:[{indexName:"intl.product.fr.fr",params:"clickAnalytics=true&facets=%5B%5D&hitsPerPage=0&query=QUERY_STRING&tagFilters=&userToken=anonymous_09f81bae3a73d5bcb1582423816110b7"},{indexName:"intl.product.fr.fr",params:"clickAnalytics=true&facets=%5B%5D&highlightPostTag=__%2Fais-highlight__&highlightPreTag=__ais-highlight__&hitsPerPage=6&query=QUERY_STRING&tagFilters=&userToken=anonymous_09f81bae3a73d5bcb1582423816110b7"},{indexName:"intl.category.fr.fr",params:"clickAnalytics=true&facets=%5B%5D&highlightPostTag=__%2Fais-highlight__&highlightPreTag=__ais-highlight__&hitsPerPage=3&numericFilters=ref_count%20%3E%200&query=QUERY_STRING&tagFilters=&userToken=anonymous_09f81bae3a73d5bcb1582423816110b7"},{indexName:"intl.brand.fr.fr",params:"clickAnalytics=true&facets=%5B%5D&highlightPostTag=__%2Fais-highlight__&highlightPreTag=__ais-highlight__&hitsPerPage=3&numericFilters=product_count%20%3E%200&query=QUERY_STRING&tagFilters=&userToken=anonymous_09f81bae3a73d5bcb1582423816110b7"},{indexName:"intl.active.fr.fr",params:"clickAnalytics=true&facets=%5B%5D&highlightPostTag=__%2Fais-highlight__&highlightPreTag=__ais-highlight__&hitsPerPage=3&numericFilters=product_count%20%3E%200&query=QUERY_STRING&tagFilters=&userToken=anonymous_09f81bae3a73d5bcb1582423816110b7"},{indexName:"intl.content.for_recipes.fr.fr",params:"clickAnalytics=true&facetFilters=%5B%22type%3Adiy%22%5D&facets=%5B%5D&highlightPostTag=__%2Fais-highlight__&highlightPreTag=__ais-highlight__&hitsPerPage=3&query=QUERY_STRING&tagFilters=&userToken=anonymous_09f81bae3a73d5bcb1582423816110b7"}]};class G extends m{constructor(e){super(e),this.onlineShopName="Maxicoffee"}searchProductsForNameOrId(e,r){let o=JSON.stringify(G.JSON_QUERY);return o=o.replace("QUERY_STRING",e),o=JSON.parse(o),this.requestWithProxy("POST",G.SEARCH_ONLINE_URL,u.CORSPROXY_IO,{body:o,responseType:"json",observe:"body"}).then(n=>{"string"==typeof n&&(n=JSON.parse(n));const a=new Array,c=n.data.items.p;if(c.length>0)for(const p of c){const i=new S;i.productPrice=p.prcn,i.currencyCode="EUR",i.productName=p.ttl,i.productDescription=void 0,i.productId=p.id,i.productUrl=p.lnk,i.productImageUrl=p.img,i.outOfStock="in stock"===p.avl,this.checkScrappedProduct(e,i),a.push(i)}return a})}}G.SEARCH_ONLINE_URL="https://na.search.sensefuel.live/searchf/4147d2a1-7a21-4697-8a4c-0e25183f3ce9",G.JSON_QUERY={acp:{},suggest:{},key:"1678529428523-0-AskResult",parentKey:null,terms:{expression:"QUERY_STRING",inputSource:"keyboard",intentDetection:{}},trackFingerPrint:{tracks:[],environmentId:"333"},items:{from:0,size:30,bypassSpellcheck:!1},prefixQuery:{},filters:{},scopes:[],spotlights:[],sort:null,needShortcuts:!0,userIds:{id:null,previousId:null,custId:null,isAuthenticated:!1},sellerId:"France m\xe9tropolitaine",kickerContents:{size:6},contents:{from:0,size:30,playOnIntent:["nlu|content"]},references:{size:32}};class y{constructor(e,r,o){this.httpClient=e,this.modelMgr=r,this.storeMgr=o,this.listOfScrappers=new Map,this.shopTypeNames=new Array,null==this.modelMgr&&(this.modelMgr=P.dtcde.getModelManager()),null==this.storeMgr&&(this.storeMgr=P.dtcde.getStoreManager()),this.addScrapper(new F(e)),this.addScrapper(new v(e)),this.addScrapper(new R(e)),this.addScrapper(new w(e)),this.addScrapper(new E(e)),this.addScrapper(new b(e)),this.addScrapper(new T(e)),this.addScrapper(new O(e)),this.addScrapper(new N(e)),this.addScrapper(new x(e)),this.addScrapper(new G(e))}addScrapper(e){this.listOfScrappers.set(e.getOnlineShopName(),e),this.shopTypeNames.push(e.getOnlineShopName())}getListOfShopTypes(){return this.shopTypeNames}searchProducts(e,r){var o=this;return(0,D.Z)(function*(){const n=o.listOfScrappers.get(yield o.getShopTypeNameOf(r));if(null==n)throw new Error("Shop type "+r+" not found");return n.searchProductsForNameOrId(e,!1)})()}findPrice(e,r,o,n){var a=this;return(0,D.Z)(function*(){if(null==e)throw new Error("No product to get price for");const c=a.listOfScrappers.get(yield a.getShopTypeNameOf(r));if(null==c)throw new Error("Shop type "+r+" not found");null==n&&(n=a.modelMgr.findAtPosition(o,!1));let p=null,i=null;if(null!=n?.fields)for(const f of Object.values(n.fields))if("Price"===f.type){p=f,i=e[p.name];break}null==p&&(p=n,i=e);const l=a.findProductId(i);return null==l||null==i?Promise.reject("Product Id not found in "+e):null!=i?(i.lastCheckDate=new Date,c.updatePrice({productId:l,productName:i.nameInShop??null,productUrl:i.urlInShop}).then(f=>null!=f&&null!=i?(i.cost=m.toMoneyAmount(f),i.outOfStock=f.outOfStock,i.priceDate=new Date,i.inError=!1,i):null).catch(f=>{throw console.error("Cannot update price for "+i?.nameInShop+" because of ",f),null!=i&&(i.inError=!0),f})):Promise.reject("Impossible to be there...")})()}findProductId(e){return null!=e?.idInShop?e?.idInShop:null!=e?.productId?e?.productId:null!=e?.id?e?.id:null}findProductName(e){return null!=e?.nameInShop?e?.nameInShop:null!=e?.productName?e?.productName:null!=e?.name?e?.name:null}updatePriceIfPossible(e,r){var o=this;return(0,D.Z)(function*(){if(null!=e.idInShop&&null!=e.shop&&("string"==typeof e.lastCheckDate&&(e.lastCheckDate=new Date(e.lastCheckDate)),null==e.lastCheckDate||e.lastCheckDate.getTime()+y.DONT_UPDATE_UNTIL_DELAY_MS<(new Date).getTime())){const n=yield o.findPrice(e,e.shop,r);return null!=n&&(n.priceDate=new Date),n}return null})()}getShopTypeNameOf(e){const o=this.modelMgr.queryModelToSingle("$.creation.entities[?(@.name=='"+V.SHOP_ENTITY_NAME+"')]")?.pointer;return null==o?Promise.resolve(e):(0,W.firstValueFrom)(this.storeMgr.searchEntities(o,{name:"Shop",value:e,operator:P.DontCodeStoreCriteriaOperator.EQUALS})).then(n=>1!=n?.length?e:null!=n[0].Type?n[0].Type:e)}}y.DONT_UPDATE_UNTIL_DELAY_MS=6e5,y.\u0275fac=function(e){return new(e||y)(t.\u0275\u0275inject(q.HttpClient),t.\u0275\u0275inject(P.DontCodeModelManager,8),t.\u0275\u0275inject(P.DontCodeStoreManager,8))},y.\u0275prov=t.\u0275\u0275defineInjectable({token:y,factory:y.\u0275fac,providedIn:"root"});var J=_(49162),H=_(3134),X=_(84017),B=_(24504),z=_(51411),Z=_(4209),$=_(60666),K=_(82046);function ee(s,e){if(1&s){const r=t.\u0275\u0275getCurrentView();t.\u0275\u0275text(0,"Select product, or "),t.\u0275\u0275elementStart(1,"button",3),t.\u0275\u0275listener("click",function(){t.\u0275\u0275restoreView(r);const n=t.\u0275\u0275nextContext();return t.\u0275\u0275resetView(n.notFound())}),t.\u0275\u0275elementEnd()}}function te(s,e){if(1&s&&t.\u0275\u0275element(0,"img",8),2&s){const r=t.\u0275\u0275nextContext(2).$implicit;t.\u0275\u0275property("src",r.productImageUrl,t.\u0275\u0275sanitizeUrl)}}function re(s,e){if(1&s&&(t.\u0275\u0275template(0,te,1,1,"img",7),t.\u0275\u0275text(1,"\xa0 ")),2&s){const r=t.\u0275\u0275nextContext().$implicit;t.\u0275\u0275property("ngIf",null!==r.productImageUrl)}}function ne(s,e){if(1&s){const r=t.\u0275\u0275getCurrentView();t.\u0275\u0275elementStart(0,"button",9),t.\u0275\u0275listener("click",function(){t.\u0275\u0275restoreView(r);const n=t.\u0275\u0275nextContext().$implicit,a=t.\u0275\u0275nextContext();return t.\u0275\u0275resetView(a.selectionOf(n))}),t.\u0275\u0275elementEnd()}}function oe(s,e){if(1&s&&(t.\u0275\u0275elementStart(0,"div",4)(1,"p-card",5),t.\u0275\u0275template(2,re,2,1,"ng-template",1),t.\u0275\u0275elementStart(3,"p")(4,"small"),t.\u0275\u0275text(5),t.\u0275\u0275elementEnd()(),t.\u0275\u0275element(6,"p"),t.\u0275\u0275elementStart(7,"h2"),t.\u0275\u0275text(8),t.\u0275\u0275elementEnd(),t.\u0275\u0275template(9,ne,1,0,"ng-template",6),t.\u0275\u0275elementEnd()()),2&s){const r=e.$implicit,o=t.\u0275\u0275nextContext();t.\u0275\u0275advance(1),t.\u0275\u0275property("header",r.productName),t.\u0275\u0275advance(4),t.\u0275\u0275textInterpolate(r.productDescription),t.\u0275\u0275advance(3),t.\u0275\u0275textInterpolate(o.localizedAmount(r))}}class Y{constructor(e){this.ref=e,this.listOfProducts=new Array,this.selected=new t.EventEmitter}selectionOf(e){this.selected.next(e)}localizedAmount(e){return null==e.productPrice||null==e.currencyCode?e.currencyCode??"":Intl.NumberFormat(globalThis?.window?.navigator.language??"en-US",{style:"currency",currency:e.currencyCode}).format(e.productPrice)}notFound(){this.selected.next(null)}}Y.\u0275fac=function(e){return new(e||Y)(t.\u0275\u0275directiveInject(t.ChangeDetectorRef))},Y.\u0275cmp=t.\u0275\u0275defineComponent({type:Y,selectors:[["dontcode-commerce-product-selection"]],inputs:{listOfProducts:"listOfProducts"},outputs:{selected:"selected"},decls:3,vars:3,consts:[["layout","grid",3,"value","rows","paginator"],["pTemplate","header"],["pTemplate","gridItem"],["label","Not found","icon","pi pi-delete-left","pButton","",3,"click"],[1,"col-6","md:col-3","flex","align-items-stretch"],[3,"header"],["pTemplate","footer"],[3,"src",4,"ngIf"],[3,"src"],["label","Select","icon","pi pi-check","pButton","",3,"click"]],template:function(e,r){1&e&&(t.\u0275\u0275elementStart(0,"p-dataView",0),t.\u0275\u0275template(1,ee,2,0,"ng-template",1),t.\u0275\u0275template(2,oe,10,3,"ng-template",2),t.\u0275\u0275elementEnd()),2&e&&t.\u0275\u0275property("value",r.listOfProducts)("rows",4)("paginator",!0)},dependencies:[A.NgIf,H.PrimeTemplate,B.ButtonDirective,$.DataView,K.Card]});const ie=["inlineView"],ae=["fullEditView"];function se(s,e){1&s&&t.\u0275\u0275elementContainer(0)}function ce(s,e){if(1&s&&(t.\u0275\u0275elementContainerStart(0),t.\u0275\u0275elementStart(1,"a",5),t.\u0275\u0275template(2,se,1,0,"ng-container",6),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementContainerEnd()),2&s){const r=t.\u0275\u0275nextContext(2),o=t.\u0275\u0275reference(4);t.\u0275\u0275advance(1),t.\u0275\u0275propertyInterpolate("href",r.value.urlInShop,t.\u0275\u0275sanitizeUrl),t.\u0275\u0275advance(1),t.\u0275\u0275property("ngTemplateOutlet",o)}}function le(s,e){1&s&&t.\u0275\u0275elementContainer(0)}function pe(s,e){if(1&s&&(t.\u0275\u0275elementContainerStart(0),t.\u0275\u0275template(1,le,1,0,"ng-container",6),t.\u0275\u0275elementContainerEnd()),2&s){t.\u0275\u0275nextContext(2);const r=t.\u0275\u0275reference(4);t.\u0275\u0275advance(1),t.\u0275\u0275property("ngTemplateOutlet",r)}}function de(s,e){if(1&s&&(t.\u0275\u0275elementStart(0,"span",3),t.\u0275\u0275template(1,ce,3,2,"ng-container",4),t.\u0275\u0275template(2,pe,2,1,"ng-container",4),t.\u0275\u0275elementEnd()),2&s){const r=t.\u0275\u0275nextContext();let o;t.\u0275\u0275propertyInterpolate2("pTooltip","Price Date: ",null!==(o=null==r.value?null:r.value.priceDate)&&void 0!==o?o:"Unknown","<br/>Shop:",null!==(o=null==r.value?null:r.value.shop)&&void 0!==o?o:"Unknown",""),t.\u0275\u0275property("escape",!1),t.\u0275\u0275advance(1),t.\u0275\u0275property("ngIf",null==r.value?null:r.value.urlInShop),t.\u0275\u0275advance(1),t.\u0275\u0275property("ngIf",!(null!=r.value&&r.value.urlInShop))}}function ue(s,e){1&s&&t.\u0275\u0275element(0,"button",8)}function fe(s,e){1&s&&t.\u0275\u0275elementContainer(0)}function me(s,e){if(1&s&&(t.\u0275\u0275template(0,ue,1,0,"button",7),t.\u0275\u0275template(1,fe,1,0,"ng-container",6),t.\u0275\u0275text(2,"\xa0\n")),2&s){const r=t.\u0275\u0275nextContext();t.\u0275\u0275property("ngIf",null==r.value?null:r.value.inError),t.\u0275\u0275advance(1),t.\u0275\u0275property("ngTemplateOutlet",r.subFieldInlineViewTemplate("cost"))}}function he(s,e){1&s&&t.\u0275\u0275elementContainer(0)}function _e(s,e){1&s&&t.\u0275\u0275element(0,"button",8)}function ge(s,e){1&s&&t.\u0275\u0275elementContainer(0)}function Ce(s,e){1&s&&t.\u0275\u0275elementContainer(0)}function Pe(s,e){1&s&&t.\u0275\u0275elementContainer(0)}function Se(s,e){if(1&s&&(t.\u0275\u0275elementStart(0,"a",5),t.\u0275\u0275text(1,"Try in the browser"),t.\u0275\u0275elementEnd()),2&s){const r=t.\u0275\u0275nextContext(5);t.\u0275\u0275property("href",null==r.parsingError?null:r.parsingError.url,t.\u0275\u0275sanitizeUrl)}}function xe(s,e){if(1&s&&(t.\u0275\u0275text(0),t.\u0275\u0275template(1,Se,2,1,"a",22)),2&s){const r=t.\u0275\u0275nextContext(4);t.\u0275\u0275textInterpolate1("Error : ",r.errorMessage()," "),t.\u0275\u0275advance(1),t.\u0275\u0275property("ngIf",null==r.parsingError?null:r.parsingError.url)}}function ye(s,e){1&s&&(t.\u0275\u0275elementContainerStart(0),t.\u0275\u0275elementStart(1,"p-messages",20),t.\u0275\u0275template(2,xe,2,2,"ng-template",21),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementContainerEnd())}function Ie(s,e){if(1&s){const r=t.\u0275\u0275getCurrentView();t.\u0275\u0275elementContainerStart(0),t.\u0275\u0275elementStart(1,"div",23)(2,"dontcode-commerce-product-selection",24),t.\u0275\u0275listener("selected",function(n){t.\u0275\u0275restoreView(r);const a=t.\u0275\u0275nextContext(3);return t.\u0275\u0275resetView(a.selectedProduct(n))}),t.\u0275\u0275elementEnd()(),t.\u0275\u0275elementContainerEnd()}if(2&s){const r=t.\u0275\u0275nextContext(3);t.\u0275\u0275advance(1),t.\u0275\u0275property("id",r.name+"-select"),t.\u0275\u0275advance(1),t.\u0275\u0275property("listOfProducts",r.listOfSelectableProducts)}}function Te(s,e){if(1&s){const r=t.\u0275\u0275getCurrentView();t.\u0275\u0275elementContainerStart(0,10),t.\u0275\u0275elementStart(1,"div",11)(2,"div",12)(3,"span",13)(4,"input",14),t.\u0275\u0275listener("input",function(n){t.\u0275\u0275restoreView(r);const a=t.\u0275\u0275nextContext(2);return t.\u0275\u0275resetView(a.productNameChanged(n))}),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementStart(5,"label",15),t.\u0275\u0275text(6,"Product Name"),t.\u0275\u0275elementEnd()()(),t.\u0275\u0275elementStart(7,"div",12),t.\u0275\u0275template(8,he,1,0,"ng-container",6),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementStart(9,"div",12)(10,"div",16),t.\u0275\u0275template(11,_e,1,0,"button",7),t.\u0275\u0275elementStart(12,"button",17),t.\u0275\u0275listener("click",function(){t.\u0275\u0275restoreView(r);const n=t.\u0275\u0275nextContext(2);return t.\u0275\u0275resetView(n.updatePrice())}),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementStart(13,"div",18),t.\u0275\u0275text(14,"Price:\xa0 "),t.\u0275\u0275template(15,ge,1,0,"ng-container",6),t.\u0275\u0275elementEnd()()(),t.\u0275\u0275elementStart(16,"div",12),t.\u0275\u0275text(17,"Date of Price:\xa0 "),t.\u0275\u0275template(18,Ce,1,0,"ng-container",6),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementStart(19,"div",12),t.\u0275\u0275text(20,"Product Id: "),t.\u0275\u0275element(21,"input",19),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementStart(22,"div",12),t.\u0275\u0275text(23,"Product url: "),t.\u0275\u0275template(24,Pe,1,0,"ng-container",6),t.\u0275\u0275elementEnd(),t.\u0275\u0275template(25,ye,3,0,"ng-container",4),t.\u0275\u0275template(26,Ie,3,2,"ng-container",4),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementContainerEnd()}if(2&s){const r=t.\u0275\u0275nextContext(2);t.\u0275\u0275property("formGroup",r.form),t.\u0275\u0275advance(4),t.\u0275\u0275property("id",r.name+"-name"),t.\u0275\u0275advance(1),t.\u0275\u0275property("for",r.name+"-name"),t.\u0275\u0275advance(3),t.\u0275\u0275property("ngTemplateOutlet",r.subFieldFullEditTemplate("shop")),t.\u0275\u0275advance(3),t.\u0275\u0275property("ngIf",null==r.value?null:r.value.inError),t.\u0275\u0275advance(1),t.\u0275\u0275property("icon",r.updatePriceIcon)("disabled",r.cannotUpdatePrice()),t.\u0275\u0275advance(3),t.\u0275\u0275property("ngTemplateOutlet",r.subFieldFullEditTemplate("cost")),t.\u0275\u0275advance(3),t.\u0275\u0275property("ngTemplateOutlet",r.subFieldFullEditTemplate("priceDate")),t.\u0275\u0275advance(6),t.\u0275\u0275property("ngTemplateOutlet",r.subFieldFullEditTemplate("urlInShop")),t.\u0275\u0275advance(1),t.\u0275\u0275property("ngIf",r.isInError),t.\u0275\u0275advance(1),t.\u0275\u0275property("ngIf",r.productSelectionMode)}}function Oe(s,e){if(1&s&&t.\u0275\u0275template(0,Te,27,12,"ng-container",9),2&s){const r=t.\u0275\u0275nextContext();t.\u0275\u0275property("ngIf",r.form)}}class I extends g.AbstractDynamicLoaderComponent{constructor(e,r,o,n){super(e,o,n),this.priceFinder=r,this.updatePriceIcon=I.baseUpdatePriceIcons,this.parsingError=null,this.productSelectionMode=!1,this.productNameLinked=!1,this.listOfSelectableProducts=new Array,this.defineSubField("cost","Other currency"),this.defineSubField("priceDate","Date & Time"),this.defineSubField("shop","Shop"),this.defineSubField("urlInShop","Website (url)"),this.value={}}providesTemplates(e){return new g.TemplateList(this.inlineView,null,this.fullEditView)}canProvide(e){return new g.PossibleTemplateList(!0,!1,!0)}setValue(e){super.setValue(e),this.enableProductNameLookup()}createAndRegisterFormControls(){let e=new C.FormControl(null,{updateOn:"blur"});this.form.registerControl("nameInShop",e),e=new C.FormControl({value:null,disabled:!0},{updateOn:"blur"}),this.form.registerControl("idInShop",e)}cannotUpdatePrice(){return!(null!=this.value&&null!=this.value.shop&&null!=this.value.nameInShop)}updatePrice(){var e=this;return(0,D.Z)(function*(){if(e.parsingError=null,null!=e.value)try{null==e.value.idInShop?(e.updatePriceIcon=I.baseUpdatePriceIcons+" pi-spin",null!=e.value.nameInShop&&null!=e.value.shop&&(yield e.priceFinder.searchProducts(e.value.nameInShop,e.value.shop).then(r=>{null!=r&&(e.listOfSelectableProducts=r,e.productSelectionMode=!0,e.ref.markForCheck(),e.ref.detectChanges())}).catch(r=>{e.parsingError=e.translateToError(r),e.ref.markForCheck(),e.ref.detectChanges()}))):null!=e.value.shop&&(yield e.priceFinder.findPrice(e.value,e.value.shop,e.parentPosition??"").then(r=>{null!=r&&(e.value.inError=!1,e.setSubFieldValue("cost",r.cost),e.setSubFieldValue("priceDate",new Date))}).catch(r=>{e.value.inError=!0,e.parsingError=e.translateToError(r),e.ref.markForCheck(),e.ref.detectChanges()}))}finally{e.updatePriceIcon=I.baseUpdatePriceIcons,e.ref.markForCheck(),e.ref.detectChanges()}})()}selectedProduct(e){this.productSelectionMode=!1,null!=e?(this.value.idInShop=e.productId,this.hydrateValueToForm(),this.setSubFieldValue("cost",m.toMoneyAmount(e)),this.setSubFieldValue("priceDate",new Date),this.setSubFieldValue("urlInShop",e.productUrl),this.value.cost=this.getSubFieldValue("cost"),this.value.priceDate=this.getSubFieldValue("priceDate"),this.value.urlInShop=this.getSubFieldValue("urlInShop")):this.clearProduct()}applyComponentToSubField(e,r,o){const n=super.applyComponentToSubField(e,r,o);if("shop"==o){const a=e.selectEventSourceFor(g.DynamicEventType.VALUE_CHANGE);null!=a&&this.subscriptions.add(a.eventSource.subscribe({next:c=>{this.clearProduct()}}))}return n}clearProduct(){this.productSelectionMode=!1,this.parsingError=null,this.value&&(delete this.value.inError,delete this.value.cost),this.setSubFieldValue("cost",void 0),this.value&&delete this.value.priceDate,this.setSubFieldValue("priceDate",void 0),this.value&&delete this.value.urlInShop,this.setSubFieldValue("urlInShop",void 0),this.value&&delete this.value.idInShop,this.form.get("idInShop")?.setValue(null,{emitEvent:!1})}productNameChanged(e){this.clearProduct()}enableProductNameLookup(){if(null==this.value?.nameInShop&&null!=this.parentForm&&!this.productNameLinked){const e=this.guessProductParentComponent();null!=e&&(this.productNameLinked=!0,this.subscriptions.add(e.valueChanges.subscribe(r=>{const o=this.form.get("nameInShop");(null==o.value||""==o.value||r.startsWith(o.value))&&(null==this.value&&(this.value={}),this.value.nameInShop=r,o.setValue(r,{emitEvent:!1,emitModelToViewChange:!0}))})))}}guessProductParentComponent(){if(null!=this.parentForm){const e=P.DontCodeModelManager.guessNamePropertyOfObject(this.parentForm.controls);if(null!=e)return this.parentForm.controls[e]}return null}translateToError(e){const r={};return"string"==typeof e?(r.message=e,r):(null!=e.status&&(r.status=e.status),null!=e.statusText?r.message=e.statusText:null!=e.message&&(r.message=e.message),null!=e.url&&(r.url=e.url),null!=e.error&&(r.content=e.error),null==r.message&&(r.message=e.toString()),r)}performAction(e){var r=this;return(0,D.Z)(function*(){e.actionType==P.ActionType.EXTRACT&&(yield r.priceFinder.updatePriceIfPossible(r.value,r.parentPosition??"").then(o=>{null!=o&&(r.value.inError=!1,r.setSubFieldValue("cost",o.cost),r.setSubFieldValue("priceDate",new Date))}).catch(o=>{r.value.inError=!0,r.parsingError=r.translateToError(o),r.ref.markForCheck(),r.ref.detectChanges()}))})()}isInError(){return null!=this.parsingError}errorMessage(){if(null==this.parsingError)return"";{let e=this.parsingError.status?this.parsingError.status+":":"";return e+=this.parsingError.message,e}}}I.baseUpdatePriceIcons="pi pi-refresh",I.\u0275fac=function(e){return new(e||I)(t.\u0275\u0275directiveInject(g.ComponentLoaderService),t.\u0275\u0275directiveInject(y),t.\u0275\u0275directiveInject(t.Injector),t.\u0275\u0275directiveInject(t.ChangeDetectorRef))},I.\u0275cmp=t.\u0275\u0275defineComponent({type:I,selectors:[["dontcode-commerce-price"]],viewQuery:function(e,r){if(1&e&&(t.\u0275\u0275viewQuery(ie,7),t.\u0275\u0275viewQuery(ae,7)),2&e){let o;t.\u0275\u0275queryRefresh(o=t.\u0275\u0275loadQuery())&&(r.inlineView=o.first),t.\u0275\u0275queryRefresh(o=t.\u0275\u0275loadQuery())&&(r.fullEditView=o.first)}},features:[t.\u0275\u0275InheritDefinitionFeature],decls:7,vars:0,consts:[["inlineView",""],["priceView",""],["fullEditView",""],[3,"pTooltip","escape"],[4,"ngIf"],["target","_blank",3,"href"],[4,"ngTemplateOutlet"],["pButton","","type","button","class","p-button-rounded p-button-outlined p-button-danger","icon","pi pi-exclamation-triangle","pTooltip","Error reading this product price",4,"ngIf"],["pButton","","type","button","icon","pi pi-exclamation-triangle","pTooltip","Error reading this product price",1,"p-button-rounded","p-button-outlined","p-button-danger"],[3,"formGroup",4,"ngIf"],[3,"formGroup"],[1,"formgrid","grid"],[1,"field","col-12","md:col-6"],[1,"p-float-label"],["type","text","pInputText","","formControlName","nameInShop",1,"w-full",3,"id","input"],[3,"for"],[1,"flex","align-items-center"],["name","FetchPrice","pButton","","pRipple","","type","button",1,"flex","flex-initial","align-items-center","p-button-rounded","p-button-text",3,"icon","disabled","click"],[1,"flex","align-items-center","flex-1",2,"margin-top","0.5rem"],["type","text","pInputText","","formControlName","idInShop",1,"w-full"],["severity","error"],["pTemplate",""],["target","_blank",3,"href",4,"ngIf"],[1,"field","col-12",3,"id"],[3,"listOfProducts","selected"]],template:function(e,r){1&e&&(t.\u0275\u0275element(0,"dtcde-dynamic"),t.\u0275\u0275template(1,de,3,5,"ng-template",null,0,t.\u0275\u0275templateRefExtractor),t.\u0275\u0275template(3,me,3,2,"ng-template",null,1,t.\u0275\u0275templateRefExtractor),t.\u0275\u0275template(5,Oe,1,1,"ng-template",null,2,t.\u0275\u0275templateRefExtractor))},dependencies:[A.NgIf,A.NgTemplateOutlet,g.DynamicInsertPoint,C.DefaultValueAccessor,C.NgControlStatus,C.NgControlStatusGroup,C.FormGroupDirective,C.FormControlName,J.InputText,H.PrimeTemplate,X.Ripple,B.ButtonDirective,z.Tooltip,Z.Messages,Y]});class k extends g.PluginBaseComponent{constructor(e,r,o){super(e,r,o)}providesTemplates(e){throw new Error("Method not implemented.")}canProvide(e){throw new Error("Method not implemented.")}handleChange(e){}}k.\u0275fac=function(e){return new(e||k)(t.\u0275\u0275directiveInject(g.ComponentLoaderService),t.\u0275\u0275directiveInject(t.Injector),t.\u0275\u0275directiveInject(t.ChangeDetectorRef))},k.\u0275cmp=t.\u0275\u0275defineComponent({type:k,selectors:[["dontcode-commerce-price-compare"]],features:[t.\u0275\u0275InheritDefinitionFeature],decls:2,vars:0,template:function(e,r){1&e&&(t.\u0275\u0275elementStart(0,"h1"),t.\u0275\u0275text(1,"Hello from PriceCompareComponent !"),t.\u0275\u0275elementEnd())}});var Ne=_(36520),Q=_(46674);function Ee(s,e){if(1&s&&t.\u0275\u0275text(0),2&s){const r=t.\u0275\u0275nextContext();t.\u0275\u0275textInterpolate(r.value)}}function ve(s,e){if(1&s&&(t.\u0275\u0275elementStart(0,"div"),t.\u0275\u0275text(1),t.\u0275\u0275elementEnd()),2&s){const r=t.\u0275\u0275nextContext(4);t.\u0275\u0275advance(1),t.\u0275\u0275textInterpolate1(" ",r.value," ")}}function be(s,e){if(1&s&&t.\u0275\u0275template(0,ve,2,1,"div",7),2&s){const r=t.\u0275\u0275nextContext(3);t.\u0275\u0275property("ngIf",r.value)}}function Re(s,e){1&s&&t.\u0275\u0275text(0),2&s&&t.\u0275\u0275textInterpolate1(" ",e.$implicit," ")}function we(s,e){if(1&s){const r=t.\u0275\u0275getCurrentView();t.\u0275\u0275elementContainerStart(0,3),t.\u0275\u0275elementStart(1,"p-dropdown",4),t.\u0275\u0275listener("onChange",function(n){t.\u0275\u0275restoreView(r);const a=t.\u0275\u0275nextContext(2);return t.\u0275\u0275resetView(a.valueChanged(n))}),t.\u0275\u0275template(2,be,1,1,"ng-template",5),t.\u0275\u0275template(3,Re,1,1,"ng-template",6),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementContainerEnd()}if(2&s){const r=t.\u0275\u0275nextContext(2);t.\u0275\u0275property("formGroup",r.form),t.\u0275\u0275advance(1),t.\u0275\u0275property("options",r.options)("formControlName",r.name)("filter",!0)("showClear",!0)("lazy",!0)}}function Ue(s,e){if(1&s&&t.\u0275\u0275template(0,we,4,6,"ng-container",2),2&s){const r=t.\u0275\u0275nextContext();t.\u0275\u0275property("ngIf",r.form)}}class L extends g.AbstractReferenceComponent{constructor(e,r,o){super(e,r),this.ref=o}ngOnInit(){this.setTargetEntitiesWithName(V.SHOP_ENTITY_NAME,"Shop").then(e=>{e&&(this.ref.markForCheck(),this.ref.detectChanges())}).catch(e=>{console.error("Cannot set list of shops",e)})}setValue(e){if(null==e){const r=this.getForm(),o=r?.parent;if(null!=o&&!Array.isArray(o.controls))for(const n in o.controls)if(o.controls[n]===r){e=n;break}}super.setValue(e)}}L.\u0275fac=function(e){return new(e||L)(t.\u0275\u0275directiveInject(P.DontCodeModelManager,8),t.\u0275\u0275directiveInject(P.DontCodeStoreManager,8),t.\u0275\u0275directiveInject(t.ChangeDetectorRef))},L.\u0275cmp=t.\u0275\u0275defineComponent({type:L,selectors:[["dontcode-commerce-shop"]],features:[t.\u0275\u0275InheritDefinitionFeature],decls:4,vars:0,consts:[["inlineView",""],["fullEditView",""],[3,"formGroup",4,"ngIf"],[3,"formGroup"],["placeholder","Select a shop",3,"options","formControlName","filter","showClear","lazy","onChange"],["pTemplate","selectedItem"],["pTemplate","item"],[4,"ngIf"]],template:function(e,r){1&e&&(t.\u0275\u0275template(0,Ee,1,1,"ng-template",null,0,t.\u0275\u0275templateRefExtractor),t.\u0275\u0275template(2,Ue,1,1,"ng-template",null,1,t.\u0275\u0275templateRefExtractor))},dependencies:[A.NgIf,C.NgControlStatus,C.NgControlStatusGroup,C.FormGroupDirective,C.FormControlName,Q.Dropdown,H.PrimeTemplate]});var Ae=_(91682);const De=["inlineView"],Fe=["fullEditView"];function Ge(s,e){if(1&s&&t.\u0275\u0275text(0),2&s){const r=t.\u0275\u0275nextContext();t.\u0275\u0275textInterpolate(r.displayableValue())}}function ke(s,e){if(1&s){const r=t.\u0275\u0275getCurrentView();t.\u0275\u0275elementContainerStart(0,3),t.\u0275\u0275elementStart(1,"span",4)(2,"p-dropdown",5),t.\u0275\u0275listener("onChange",function(n){t.\u0275\u0275restoreView(r);const a=t.\u0275\u0275nextContext(2);return t.\u0275\u0275resetView(a.valueChanged(n))}),t.\u0275\u0275elementEnd()(),t.\u0275\u0275elementContainerEnd()}if(2&s){const r=t.\u0275\u0275nextContext(2);t.\u0275\u0275property("formGroup",r.form),t.\u0275\u0275advance(2),t.\u0275\u0275property("options",r.shopTypes)("formControlName",r.name)}}function Le(s,e){if(1&s&&t.\u0275\u0275template(0,ke,3,3,"ng-container",2),2&s){const r=t.\u0275\u0275nextContext();t.\u0275\u0275property("ngIf",r.form)}}class M extends g.AbstractDynamicComponent{constructor(e){super(),this.priceFinder=e,this.shopTypes=new Array,this.valueChange=new t.EventEmitter,this.shopTypes=this.priceFinder.getListOfShopTypes()}createAndRegisterFormControls(){this.form.registerControl(this.name,new C.FormControl(null,{updateOn:"change"}))}providesTemplates(e){return new g.TemplateList(this.inlineView,null,this.fullEditView)}canProvide(e){return new g.PossibleTemplateList(!0,!1,!0)}displayableValue(){return g.AbstractDynamicComponent.toBeautifyString(this.value)??""}listEventSources(){const e=super.listEventSources();return e.push(new g.BaseDynamicEventSource("Value",g.DynamicEventType.VALUE_CHANGE,this.valueChange.asObservable())),e}valueChanged(e){this.valueChange.emit(new g.BaseDynamicEvent("Value",g.DynamicEventType.VALUE_CHANGE,e.value))}}M.\u0275fac=function(e){return new(e||M)(t.\u0275\u0275directiveInject(y))},M.\u0275cmp=t.\u0275\u0275defineComponent({type:M,selectors:[["dontcode-commerce-shop-type"]],viewQuery:function(e,r){if(1&e&&(t.\u0275\u0275viewQuery(De,7),t.\u0275\u0275viewQuery(Fe,7)),2&e){let o;t.\u0275\u0275queryRefresh(o=t.\u0275\u0275loadQuery())&&(r.inlineView=o.first),t.\u0275\u0275queryRefresh(o=t.\u0275\u0275loadQuery())&&(r.fullEditView=o.first)}},outputs:{valueChange:"valueChange"},features:[t.\u0275\u0275InheritDefinitionFeature],decls:4,vars:0,consts:[["inlineView",""],["fullEditView",""],[3,"formGroup",4,"ngIf"],[3,"formGroup"],[1,"p-float-label"],["name","shop","placeholder","Please select a Shop",1,"w-full",3,"options","formControlName","onChange"]],template:function(e,r){1&e&&(t.\u0275\u0275template(0,Ge,1,1,"ng-template",null,0,t.\u0275\u0275templateRefExtractor),t.\u0275\u0275template(2,Le,1,1,"ng-template",null,1,t.\u0275\u0275templateRefExtractor))},dependencies:[A.NgIf,C.NgControlStatus,C.NgControlStatusGroup,C.FormGroupDirective,C.FormControlName,Q.Dropdown]});var Me=_(7297);class Ye extends m{constructor(e){super(e)}searchProductsForNameOrId(e,r){return Promise.reject("Not implemented")}callUrlWithProxy(e,r){var o=this;return(0,D.Z)(function*(){const n=r;return yield o.requestWithProxy("GET",e,n,{observe:"response",responseType:"text"})})()}}class U{constructor(){console.log("Commerce Plugin registering"),P.dtcde.registerPlugin(new V)}exposedPreviewHandlers(){return new Map([["PriceComponent",I],["PriceCompareComponent",k],["ShopHandlerComponent",L],["ShopTypeHandlerComponent",M]])}}U.\u0275fac=function(e){return new(e||U)},U.\u0275mod=t.\u0275\u0275defineNgModule({type:U,id:"dontcode-plugin/commerce"}),U.\u0275inj=t.\u0275\u0275defineInjector({imports:[A.CommonModule,g.PluginCommonModule.forRoot(),Ae.BasicModule,Ne.FieldsModule,C.ReactiveFormsModule,J.InputTextModule,C.FormsModule,Q.DropdownModule,X.RippleModule,B.ButtonModule,$.DataViewModule,K.CardModule,z.TooltipModule,Me.MessageModule,Z.MessagesModule]}),t.\u0275\u0275registerNgModuleType(U,"dontcode-plugin/commerce")}}]);