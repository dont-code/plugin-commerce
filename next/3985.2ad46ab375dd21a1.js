(self.webpackChunkcommerce_tester=self.webpackChunkcommerce_tester||[]).push([[3985],{3985:(ee,B,_)=>{_.r(B),_.d(B,{CommerceModule:()=>F,PriceCompareComponent:()=>M,PriceComponent:()=>L,ShopHandlerComponent:()=>Y,ShopTypeHandlerComponent:()=>H});var b=_(57863),C=_(17401),g=_(27022),S=_(67138),G=_(16602),U=_(92256);class x{constructor(){this.productName=null,this.outOfStock=!1}}class m{static toMoneyAmount(e){const r=new S.MoneyAmount;return r.amount=e.productPrice,r.currencyCode=e.currencyCode,r}constructor(e){this.http=e,this.onlineShopName="Unknown"}getOnlineShopName(){return this.onlineShopName}getShopTypeName(){return this.onlineShopName}requestWithProxy(e,r,o,n){return(0,U.firstValueFrom)(this.http.request(e,this.encodeUrlForCors(r,o),this.updateOptionsForCors(e,r,o,n)))}encodeUrlForCors(e,r){let o=e;switch(r){case f.CORSPROXY_IO:o=m.CORS_PROXY_URL+encodeURIComponent(e);break;case f.CHROME_ENGINE:case f.DONT_CODE:o=m.CORS_DONTCODE_PROXY_URL;break;case f.WEBSCRAPING_IA:o=m.WEBSCRAPING_PROXY_URL}return o}updateOptionsForCors(e,r,o,n){switch(o){case f.CORSPROXY_IO:n.withCredentials=!1;break;case f.CHROME_ENGINE:case f.DONT_CODE:this.addToHttpParams(n,{url:r}),o===f.CHROME_ENGINE&&this.addToHttpParams(n,{engine:"chrome"});break;case f.WEBSCRAPING_IA:this.addToHttpParams(n,{proxy:"datacenter",js:!1,api_key:m.WEBSCRAPING_PROXY_API_KEY,url:r})}return n}updatePrice(e,r){let o=e.productId;return null==r&&(r=!1),(r||null==o)&&(o=e.productName??void 0,r=!0),null==o?Promise.reject("You must define a product with a name or id "):this.searchProductsForNameOrId(o,!r).then(n=>{for(const s of n)if(s.productId==e.productId)return s;return null}).then(n=>null!=n||r||null==e.productName?n??Promise.reject("Product "+o+" not found in shoptype "+this.onlineShopName):this.searchProductsForNameOrId(e.productName,!1).then(s=>{for(const i of s)if(i.productId==e.productId)return i;return Promise.reject("Product "+o+" not found in shoptype "+this.onlineShopName)}))}standardHeaders(){return new G.HttpHeaders({})}checkScrappedProduct(e,r){if(null==r.productId||0==r.productId.length)throw new Error("Incorrect productId scrapped by shop "+this.getOnlineShopName()+" for product search"+e);if(null==r.productName||0==r.productName.length)throw new Error("Incorrect productName scrapped by shop "+this.getOnlineShopName()+" for product search"+e);if((null==r.productPrice||isNaN(r.productPrice))&&1!=r.outOfStock)throw new Error("Incorrect productPrice scrapped by shop "+this.getOnlineShopName()+" for product search"+e)}checkStringPosition(e,r){if(-1==e||-1!=r&&e>r)throw new Error("Error decoding product for Scrapper "+this.getOnlineShopName())}indexOf(e,r,o,n,s=!0){const i=e.indexOf(r,o);return-1==i?i:null!=n&&-1!=n&&i>n?-1:s?i+r.length:i}safeIndexOf(e,r,o,n,s=!0){const i=e.indexOf(r,o);if(-1==i)throw new Error("Cannot find "+r+" for "+this.getOnlineShopName());if(null!=n&&-1!=n&&i>n)throw new Error("The product content does not contains "+r+" for "+this.getOnlineShopName());return s?i+r.length:i}addToHttpParams(e,r){e.params=null==e.params?r:null!=e.params.appendAll?e.params.appendAll(r):{...e.params,...r}}}m.CORS_PROXY_URL="https://corsproxy.io/?",m.WEBSCRAPING_PROXY_URL="https://api.webscraping.ai/html",m.WEBSCRAPING_PROXY_API_KEY="f4fe0d0b-bfa9-49bd-a3f7-404be7bcad85",m.CORS_DONTCODE_PROXY_URL="https://shared.collin.best/proxy/debug";var f=(()=>{return(c=f||(f={})).CORSPROXY_IO="CORSPROXY.IO",c.WEBSCRAPING_IA="WEBSCRAPING.IA",c.DONT_CODE="DONT-CODE.PROXY",c.CHROME_ENGINE="DONT-CODE.CHROME",f;var c})(),t=_(30549),y=_(15861);class R extends m{constructor(e){super(e),this.onlineShopName="EasyParapharmacie"}searchProductsForNameOrId(e,r){let o=JSON.stringify(R.JSON_QUERY);return o=o.replace("QUERY_STRING",encodeURIComponent(e)),o=JSON.parse(o),this.requestWithProxy("POST",R.SEARCH_ONLINE_URL,f.CORSPROXY_IO,{body:o,responseType:"json",observe:"body"}).then(n=>{"string"==typeof n&&(n=JSON.parse(n));const s=new Array,i=n.results;if(i.length>0){const d=i[0].hits;if(null!=d)for(const a of d){const l=new x;l.productPrice=a.price.EUR.default,l.currencyCode="EUR",l.productName=a.name,l.productDescription=a.short_description??a.description,l.productId=a.ean_code?.toString(),null==l.productId&&(console.warn("Product "+l.productName+" searched by "+e+" for Shop "+this.getOnlineShopName()+" has no ean_code, getting objectId instead"),l.productId=a.objectID),l.productUrl=a.url,l.productImageUrl=a.image_url,this.checkScrappedProduct(e,l),s.push(l)}}return s})}}R.SEARCH_ONLINE_URL="https://jhu6zvksfy-dsn.algolia.net/1/indexes/*/queries?x-algolia-agent=Algolia%20for%20JavaScript%20(3.35.1)%3B%20Browser%3B%20instantsearch.js%20(4.15.0)%3B%20Magento2%20integration%20(3.6.0)%3B%20JS%20Helper%20(3.4.4)&x-algolia-application-id=JHU6ZVKSFY&x-algolia-api-key=ODk4Y2JiMjAyYWIxNjI1NGJmYmQzNDQyYjBkMGViMDE4N2ZmYmMwZTUwYWFjNTJhNTlkMDBlNWFmYzAxZmJiYXRhZ0ZpbHRlcnM9",R.JSON_QUERY={requests:[{indexName:"prod_magento2_fr_products",params:"highlightPreTag=__ais-highlight__&highlightPostTag=__%2Fais-highlight__&ruleContexts=%5B%22magento_filters%22%5D&hitsPerPage=24&query=QUERY_STRING&page=0&maxValuesPerFacet=20&facets=%5B%22filter_age_baby%22%2C%22filter_baby_teats_shape%22%2C%22filter_feminine_care%22%2C%22filter_foot%22%2C%22filter_gynaecology%22%2C%22filter_hair_color%22%2C%22filter_hair_needs%22%2C%22filter_hair_type%22%2C%22filter_level_of_spf%22%2C%22filter_mosquito_repellents%22%2C%22filter_part_of_body%22%2C%22filter_product_size%22%2C%22filter_texture%22%2C%22filter_type_of_hygiene%22%2C%22filter_type_of_milk%22%2C%22filter_type_of_shaving%22%2C%22filter_type_of_toothbrushes%22%2C%22filter_type_of_toothpastes%22%2C%22filter_veterinary%22%2C%22filter_wash%22%2C%22price.EUR.default%22%2C%22filter_virtual_category%22%2C%22manufacturer%22%2C%22product_rating%22%2C%22categories.level0%22%5D&tagFilters=&numericFilters=%5B%22visibility_search%3D1%22%5D"}]};class v extends m{constructor(e){super(e),this.onlineShopName="GreenWeez"}searchProductsForNameOrId(e,r){let o=JSON.stringify(v.JSON_QUERY);return o=o.replace("QUERY_STRING",encodeURIComponent(e)),o=o.replace("QUERY_STRING",encodeURIComponent(e)),o=o.replace("QUERY_STRING",encodeURIComponent(e)),o=JSON.parse(o),this.requestWithProxy("POST",v.SEARCH_ONLINE_URL,f.CORSPROXY_IO,{body:o,responseType:"json",observe:"body"}).then(n=>{"string"==typeof n&&(n=JSON.parse(n));const s=new Array,i=n.results;if(i.length>0){const d=i[0].hits;if(null!=d)for(const a of d){const l=new x;l.productPrice=a.shop_data.pricing.priceIncludedVat/100,l.currencyCode="EUR",l.productName=a.name,l.productDescription=void 0,l.productId=a.shop_data.variant.code,l.productUrl=this.calculateProductUrl(a.shop_data),l.productImageUrl=this.findImageUrl(a.shop_data.variant.images),l.marketPlace=!0===a.flags.marketPlace,this.checkScrappedProduct(e,l),s.push(l)}}return s})}calculateProductUrl(e){return v.BASE_URL+"/produit/"+e.variant.product.slug+"/"+e.variant.code+"/"+e.id}findImageUrl(e){for(const r of e)if("variant"==r.type)return v.BASE_URL+"/_next/image?url=https%3A%2F%2Fcdn.greenweez.com%2Fproducts%2F"+r.path+"&w=640&q=75"}}v.SEARCH_ONLINE_URL="https://54m7x8foua-dsn.algolia.net/1/indexes/*/queries?x-algolia-agent=Algolia for JavaScript (4.14.2); Browser (lite); instantsearch.js (4.48.0); react (17.0.2); react-instantsearch (6.36.0); react-instantsearch-hooks (6.36.0); JS Helper (3.11.1)&x-algolia-api-key=52441d0a775f924291679b7c224d6782&x-algolia-application-id=54M7X8FOUA",v.BASE_URL="https://greenweez.com",v.JSON_QUERY={requests:[{indexName:"france_prod_offers_genepi_fr_FR",params:"attributesToRetrieve=%5B%22main_category%22%2C%22attributes%22%2C%22capacity%22%2C%22discount.percent%22%2C%22flags%22%2C%22ObjectID%22%2C%22name%22%2C%22options.color.available_colors%22%2C%22seller%22%2C%22shop_data.id%22%2C%22shop_data.variant.images%22%2C%22shop_data.variant.product.id%22%2C%22shop_data.variant.product.legacyId%22%2C%22shop_data.variant.product.slug%22%2C%22shop_data.variant.product.brand.name%22%2C%22shop_data.variant.code%22%2C%22shop_data.sellerCatalog.seller%22%2C%22shop_data.pricing%22%2C%22shop_data.offerData%22%2C%22shop_data.onHand%22%2C%22stats%22%5D&clickAnalytics=true&facets=%5B%5D&filters=has_parent_objectID%3D0&highlightPostTag=__%2Fais-highlight__&highlightPreTag=__ais-highlight__&hitsPerPage=20&query=QUERY_STRING&tagFilters="},{indexName:"france_prod_brands_genepi_fr_FR",params:"attributesToRetrieve=%5B%22name%22%2C%22slug%22%5D&clickAnalytics=true&facets=%5B%5D&filters=&highlightPostTag=__%2Fais-highlight__&highlightPreTag=__ais-highlight__&hitsPerPage=6&query=QUERY_STRING&tagFilters="},{indexName:"france_prod_categories_genepi_fr_FR",params:"attributesToRetrieve=%5B%22parent%22%2C%22name%22%2C%22slug%22%2C%22level%22%5D&clickAnalytics=true&facets=%5B%5D&filters=&highlightPostTag=__%2Fais-highlight__&highlightPreTag=__ais-highlight__&hitsPerPage=6&query=QUERY_STRING&tagFilters="}]};class Q{getConfiguration(){return{plugin:{id:"CommercePlugin","display-name":"Commerce Plugin for anything related to products, prices, shops.",version:"1.0.0"},"schema-updates":[{id:"price-field",description:"A price of a product in a shop",changes:[{location:{parent:"#/$defs/field",id:"type"},update:{enum:[{Commerce:{enum:["Price","Shop","Shop type"]}}]},replace:!1}]}],"preview-handlers":[{location:{parent:S.DontCodeModel.APP_FIELDS,id:"type",values:[{Commerce:{enum:["Price"]}}]},class:{name:"PriceComponent",source:"commerce"}},{location:{parent:S.DontCodeModel.APP_FIELDS,id:"type",values:[{Commerce:{enum:["Shop"]}}]},class:{name:"ShopHandlerComponent",source:"commerce"}},{location:{parent:S.DontCodeModel.APP_FIELDS,id:"type",values:[{Commerce:{enum:["Shop type"]}}]},class:{name:"ShopTypeHandlerComponent",source:"commerce"}}]}}pluginInit(e){}}Q.SHOP_ENTITY_NAME="Online Shop";class A extends m{constructor(e){super(e),this.onlineShopName="NewPharma"}searchProductsForNameOrId(e,r){const o=A.SEARCH_ONLINE_URL.replace("QUERY_STRING",encodeURIComponent(e)),n=this.standardHeaders();return this.requestWithProxy("GET",o,f.CHROME_ENGINE,{headers:n,withCredentials:!1,responseType:"text",observe:"body"}).then(s=>{const i=new Array;let d=s.indexOf(A.PRODUCT_START_STRING);for(;d>=0;){const a=new x;let l=s.indexOf('data-productid="',d)+16;a.productId=s.substring(l,s.indexOf('"',l+1)),l=s.indexOf('<a class="details__title',d)+24,l=s.indexOf('title="',l+1)+7,a.productName=s.substring(l,s.indexOf('"',l+1)),a.productDescription=void 0,l=s.indexOf('href="',d)+6,a.productUrl=s.substring(l,s.indexOf('"',l+1)),l=s.indexOf('<img src="',d+1)+10,a.productImageUrl=s.substring(l,s.indexOf('"',l+1)),this.extractPrice(s,d,a),this.checkScrappedProduct(e,a),i.push(a),d=s.indexOf(A.PRODUCT_START_STRING,d+1)}return i})}extractPrice(e,r,o){let n=e.indexOf('data-content_ids="['+o.productId+']"',r+1);if(-1==n&&(n=e.indexOf('data-content_ids="'+o.productId+'"',r+1)),-1!=n){let s=e.indexOf('data-currency="',n)+15;o.currencyCode=e.substring(s,e.indexOf('"',s+1)),s=e.indexOf('data-value="',n)+12,o.productPrice=parseFloat(e.substring(s,e.indexOf('"',s+1)))}}updatePrice(e,r){return null==e.productUrl?super.updatePrice(e,!0):this.requestWithProxy("GET",e.productUrl,f.CHROME_ENGINE,{headers:{Accept:"text/html"},withCredentials:!1,responseType:"text",observe:"body"}).then(o=>{const n={productId:e.productId,productName:e.productName};return this.extractPrice(o,0,n),this.checkScrappedProduct(e.productName??"",n),e.productPrice=n.productPrice,e.currencyCode=n.currencyCode,e}).catch(o=>(console.error("Error trying to access page for product "+e.productName,o),super.updatePrice(e,!0)))}}A.SEARCH_ONLINE_URL="https://www.newpharma.fr/search-results/search.html?q=QUERY_STRING",A.PRODUCT_START_STRING='<div class="product js-product-row product--desktop';class D extends m{constructor(e){super(e),this.onlineShopName="WebEcologie"}searchProductsForNameOrId(e,r){const o=D.SEARCH_ONLINE_URL.replace("QUERY_STRING",encodeURIComponent(e));return this.requestWithProxy("GET",o,f.CORSPROXY_IO,{headers:{Accept:"text/html"},responseType:"text",observe:"body"}).then(n=>{const s=new Array;let i=n.indexOf(D.PRODUCT_START_STRING);for(;i>=0;){const d=new x;let a=n.indexOf('href="',i)+6;d.productUrl=n.substring(a,n.indexOf('"',a+1)),a=n.indexOf('title="',i)+7,d.productName=n.substring(a,n.indexOf('"',a+1)),d.productDescription=void 0,a=n.indexOf('src="',i+1)+5,d.productImageUrl=n.substring(a,n.indexOf('"',a+1));const l=n.indexOf('<a class="addToWishlist',i)+23;a=n.indexOf('rel="',l)+5,d.productId=n.substring(a,n.indexOf('"',a+1)),this.extractPrice(n,i,d),this.checkScrappedProduct(e,d),s.push(d),i=n.indexOf(D.PRODUCT_START_STRING,i+1)}return s})}extractPrice(e,r,o){let n=e.indexOf('class="price-first-part">',r)+25,s=Number.parseInt(e.substring(n,e.indexOf("<",n+1)));n=e.indexOf('class="price-last-part">',r)+24,s+=Number.parseInt(e.substring(n,e.indexOf("<",n+1)))/100,o.productPrice=s,n=e.indexOf('itemprop="priceCurrency"',r)+24,n=e.indexOf('content="',n)+9,o.currencyCode=e.substring(n,e.indexOf('"',n+1))}updatePrice(e,r){return null==e.productUrl?super.updatePrice(e,!0):this.requestWithProxy("GET",e.productUrl,f.CORSPROXY_IO,{headers:{Accept:"text/html"},responseType:"text",observe:"body"}).then(o=>{const n={productId:e.productId,productName:e.productName};return this.extractPrice(o,0,n),this.checkScrappedProduct(e.productName??"Unknown",n),e.productPrice=n.productPrice,e.currencyCode=n.currencyCode,e}).catch(o=>(console.error("Error trying to access page for product "+e.productName,o),super.updatePrice(e,!0)))}}D.SEARCH_ONLINE_URL="https://www.webecologie.com/rechercher?search_query=QUERY_STRING",D.PRODUCT_START_STRING='<a class="product_img_link"';class w extends m{constructor(e){super(e),this.onlineShopName="Boulanger"}searchProductsForNameOrId(e,r){e=e.normalize("NFD").replace(/\p{Diacritic}/gu,"");const o=w.SEARCH_ONLINE_URL.replace("QUERY_STRING",e);return this.requestWithProxy("GET",o,f.CORSPROXY_IO,{observe:"body",responseType:"text"}).then(n=>this.analysePageResult(e,n)).catch(n=>null==n.code||"Unknown Error"===n.statusText?this.requestWithProxy("GET",o,f.WEBSCRAPING_IA,{observe:"body",responseType:"text"}).then(s=>this.analysePageResult(e,s)):n)}analysePageResult(e,r){const o=new Array;let n=r.indexOf(w.PRODUCT_START_STRING);for(;n>=0;){const s=new x;let i=r.indexOf('href="',n)+6;s.productUrl=w.BASE_URL+r.substring(i,r.indexOf('"',i+1)),i=r.indexOf('data-product-label="',n)+20,s.productName=r.substring(i,r.indexOf('"',i+1)),s.productDescription=void 0,i=r.indexOf('<img src="',n+1)+10,s.productImageUrl=r.substring(i,r.indexOf('"',i+1)),i=r.indexOf('data-product-id="',n)+17,s.productId=r.substring(i,r.indexOf('"',i+1)),this.extractPrice(r,n,s),this.checkScrappedProduct(e,s),o.push(s),n=r.indexOf(w.PRODUCT_START_STRING,n+1)}return o}extractPrice(e,r,o){const n=e.indexOf('data-analytics_product_unitprice_ati="',r)+38,s=Number.parseFloat(e.substring(n,e.indexOf('"',n+1)));o.productPrice=s,o.currencyCode="EUR"}}w.SEARCH_ONLINE_URL="https://www.boulanger.com/resultats?tr=QUERY_STRING",w.PRODUCT_START_STRING="<article",w.BASE_URL="https://www.boulanger.com";class I extends m{constructor(e){super(e),this.onlineShopName="Darty",this.httpHeaders={"x-algolia-api-key":"740b60dee22b6ca679462288f6cd9c7b","x-algolia-application-id":"Z0YPI1PLPQ"}}searchProductsForNameOrId(e,r){let o=JSON.stringify(I.JSON_QUERY);return o=o.replace("QUERY_STRING",e),o=o.replace("QUERY_STRING",e),o=JSON.parse(o),this.requestWithProxy("POST",I.SEARCH_ONLINE_URL,f.CORSPROXY_IO,{body:o,headers:this.httpHeaders,responseType:"json",observe:"body"}).then(n=>{"string"==typeof n&&(n=JSON.parse(n));const s=new Array,i=n.results;if(i.length>0){const d=i[0].hits;if(null!=d)for(const a of d){const l=new x;l.productPrice=this.extractPrice(a),l.currencyCode="EUR",l.productName=a.reference,l.productDescription=void 0,l.productId=a.codic,l.productUrl=I.BASE_URL+"/nav/codic/"+a.codic,a.pictures?.length>0&&(l.productImageUrl=I.BASE_IMAGE_URL.replace("IMAGE_URL",a.pictures[0].algoliaPict)),this.checkScrappedProduct(e,l),s.push(l)}}return s})}updatePrice(e,r){return super.updatePrice(e,!0)}extractPrice(e){if(null!=e.priceSort)return e.priceSort/100;if(null!=e.dartyExclusivePriceSort)return e.dartyExclusivePriceSort/100;let r=0;for(const o in e.prices.stores)("000000"===o||"dartyExclusive"===o&&0===r||0===r)&&(r=e.prices.stores[o]/100);return r}}I.SEARCH_ONLINE_URL="https://z0ypi1plpq-dsn.algolia.net/1/indexes/*/queries?x-algolia-agent=Algolia+for+JavaScript+%284.17.0%29%3B+Browser",I.JSON_QUERY={requests:[{indexName:"darty_prod_es6",query:"QUERY_STRING",params:"hitsPerPage=4&tagFilters=%5B%22dcom%22%5D"},{indexName:"darty_prod_es6_query_suggestions",query:"QUERY_STRING",params:"hitsPerPage=5"}]},I.BASE_URL="https://www.darty.com",I.BASE_IMAGE_URL="https://image.darty.com/darty?type=image&source=IMAGE_URL&width=120&heigth=180&quality=80";class T extends m{constructor(e){super(e),this.onlineShopName="CDiscount"}searchProductsForNameOrId(e,r){const o=e.split(" ");let n="";for(const i of o)n+=encodeURIComponent(i)+"+";o.length>=1&&(n=n.substring(0,n.length-1));const s=T.SEARCH_ONLINE_URL.replace("QUERY_STRING",n);return this.requestWithProxy("GET",s,f.CORSPROXY_IO,{headers:{Accept:"text/html"},responseType:"text",observe:"body"}).then(i=>{const d=new Array;let a=i.indexOf(T.PRODUCT_START_STRING);for(a=i.indexOf(T.PRODUCT_START_STRING,a+1);a>=0;){const l=i.indexOf(T.PRODUCT_START_STRING,a+1),u=new x;let p=this.safeIndexOf(i,'href="',a,l);u.productUrl=i.substring(p,this.safeIndexOf(i,'"',p+1,l,!1)),p=this.indexOf(i,'<h2 class="prdtTit">',a,l),-1==p&&(p=this.indexOf(i,'<h2 class="prdtBILTit">',a,l)),u.productName=i.substring(p,this.safeIndexOf(i,"</h2>",p+1,l,!1)),u.productDescription=void 0,p=this.safeIndexOf(i,'src="',a+1,l),u.productImageUrl=i.substring(p,this.safeIndexOf(i,'"',p+1,l,!1)),p=this.safeIndexOf(i,'data-productid="',a,l),u.productId=i.substring(p,this.safeIndexOf(i,'"',p+1,l,!1)),this.extractPrice(i,a,l,u),this.checkScrappedProduct(e,u),d.push(u),a=i.indexOf(T.PRODUCT_START_STRING,a+1)}return d})}extractPrice(e,r,o,n){let s=this.indexOf(e,'<span class="price priceColor hideFromPro">',r,o);if(-1!=s){const i=this.safeIndexOf(e,",",s+1,o,!1),d=Number.parseInt(e.substring(s,i)),a=Number.parseInt(e.substring(i+1,this.safeIndexOf(e,"&euro;",i+1,o,!1)));n.productPrice=d+a/100}else{s=this.safeIndexOf(e,'<span class="hideFromPro priceColor price">',r,o);const i=Number.parseInt(e.substring(s,this.safeIndexOf(e,"<sup>",s+1,o,!1))),d=Number.parseInt(e.substring(this.safeIndexOf(e,"</sup>",s+1,o,!1)-2,this.safeIndexOf(e,"</sup>",s+1,o,!1)));n.productPrice=i+d/100}n.currencyCode="EUR"}}T.SEARCH_ONLINE_URL="https://www.cdiscount.com/search/10/QUERY_STRING.html",T.PRODUCT_START_STRING='<li data-sku="',T.BASE_URL="https://www.cdiscount.com";class P extends m{constructor(e){super(e),this.onlineShopName="Amazon"}searchProductsForNameOrId(e,r){const o=P.SEARCH_ONLINE_URL.replace("QUERY_STRING",encodeURIComponent(e));return this.requestWithProxy("GET",o,f.DONT_CODE,{headers:{Accept:"text/html"},responseType:"text",observe:"body"}).catch(n=>(console.error("Error getting amazon price with DontCode Proxy",n),null!=n.status&&n.status>=500?this.requestWithProxy("GET",o,f.CORSPROXY_IO,{headers:{Accept:"text/html"},responseType:"text",observe:"body"}):Promise.reject(n))).catch(n=>(console.error("Error getting amazon price with CorsProxyIO",n),null!=n.status&&n.status>=500?this.requestWithProxy("GET",o,f.WEBSCRAPING_IA,{headers:{Accept:"text/html"},responseType:"text",observe:"body"}):Promise.reject(n))).then(n=>{const s=new Array;let i=n.indexOf(P.PRODUCT_START_STRING);for(;i>=0;){const d=n.indexOf(P.PRODUCT_START_STRING,i+1),a=n.substring(i,d),l=new x,u=a.indexOf('data-component-type="s-product-image"');let p=a.indexOf('data-asin="')+11;if('"'==a.charAt(p)||-1==u){i=n.indexOf(P.PRODUCT_START_STRING,i+1);continue}l.productId=a.substring(p,a.indexOf('"',p+1)),p=a.indexOf('href="',u)+6;let h=a.substring(p,a.indexOf('"',p+1));if(h.startsWith("/sspa/click")){const He=h.indexOf("url=")+4;h=h.substring(He),h=h.replace(/%2F/g,"/")}l.productUrl=P.BASE_URL+h,p=a.indexOf('src="',u+1)+5,l.productImageUrl=a.substring(p,a.indexOf('"',p+1)),p=a.indexOf('a-text-normal">',u)+15,l.productDescription=a.substring(p,a.indexOf("<",p+1)),l.productName=null!=l.productDescription&&l.productDescription?.length>60?l.productDescription.substring(0,60):l.productDescription||null,p=a.indexOf('data-asin="')+11,l.productId=a.substring(p,a.indexOf('"',p+1)),this.extractPrice(a,u,l),this.checkScrappedProduct(e,l),s.push(l),i=a.indexOf(P.PRODUCT_START_STRING,i+1)}return s})}extractPrice(e,r,o){const n=e.indexOf('<span class="a-price-whole">',r)+28;let s=e.substring(n,e.indexOf("</span>",n+1));s=s.replace(",","."),o.productPrice=Number.parseFloat(s),o.currencyCode="EUR"}}P.SEARCH_ONLINE_URL="https://www.amazon.fr/s?k=QUERY_STRING",P.PRODUCT_START_STRING='<div data-asin="',P.BASE_URL="https://www.amazon.fr";class O extends m{constructor(){super(...arguments),this.onlineShopName="Fnac"}searchProductsForNameOrId(e,r){const o=e.split(" ");let n="";for(const i of o)n+=encodeURIComponent(i)+"+";o.length>=1&&(n=n.substring(0,n.length-1));const s=O.SEARCH_ONLINE_URL.replace("QUERY_STRING",n);return this.requestWithProxy("GET",s,f.DONT_CODE,{headers:{Accept:"text/html"},responseType:"text",observe:"body",withCredentials:!0}).then(i=>{const d=new Array;let a=i.indexOf(O.PRODUCT_START_STRING),l=i.indexOf(O.PRODUCT_START_STRING,a+1);for(;a>=0;){const u=new x;let p=this.safeIndexOf(i,'id="',a,l);u.productId=i.substring(p,i.indexOf('"',p+1));let h=this.safeIndexOf(i,'<img class="Article-itemVisualImg',a,l);p=this.indexOf(i,'data-lazyimage="',h),-1==p&&(p=this.safeIndexOf(i,'src="',h,l)),u.productImageUrl=i.substring(p,i.indexOf('"',p+1)),p=this.safeIndexOf(i,'alt="',h,l),u.productName=i.substring(p,i.indexOf('"',p+1)),u.productDescription=void 0,h=this.safeIndexOf(i,'<p class="Article-desc',a,l),p=this.safeIndexOf(i,'href="',h,l),u.productUrl=i.substring(p,i.indexOf('"',p+1)),p=i.indexOf("vendeur partenaire",a),u.marketPlace=-1!=p&&(-1==l||p<l),p=i.indexOf("En stock",a),u.outOfStock=-1==p||!(-1==l||p<l),this.extractPrice(i,a,u,l),null==u.productPrice&&(u.outOfStock=!0),this.checkScrappedProduct(e,u),d.push(u),a=i.indexOf(O.PRODUCT_START_STRING,a+1),l=i.indexOf(O.PRODUCT_START_STRING,a+1)}return d})}extractPrice(e,r,o,n){const s=this.indexOf(e,'class="userPrice">',r,n);if(-1==s)return void(o.productPrice=void 0);const i=this.indexOf(e,"<sup>",s+1,n,!1);let d=0;if(-1==i)d=Number.parseInt(e.substring(s,this.safeIndexOf(e,"&euro;",s+1,n,!1))),o.productPrice=d;else{d=Number.parseInt(e.substring(s,i));const a=Number.parseInt(e.substring(this.safeIndexOf(e,"</sup>",s+1,n,!1)-2,this.safeIndexOf(e,"</sup>",s+1,n)));o.productPrice=d+a/100}o.currencyCode="EUR"}updatePrice(e,r){return null==e.productUrl?super.updatePrice(e,!0):this.requestWithProxy("GET",e.productUrl,f.DONT_CODE,{headers:{Accept:"text/html"},responseType:"text",observe:"body"}).then(o=>{const n={productId:e.productId,productName:e.productName},s=this.safeIndexOf(o,"userPrice",0),i=this.safeIndexOf(o,'data-price="',s);return n.productPrice=Number.parseFloat(o.substring(i,this.safeIndexOf(o,'"',i+1)).replace(",",".")),n.currencyCode="EUR",this.checkScrappedProduct(e.productName??"",n),e.productPrice=n.productPrice,e.currencyCode=n.currencyCode,e}).catch(o=>(console.error("Error trying to access page for product "+e.productName,o),super.updatePrice(e,!0)))}}O.SEARCH_ONLINE_URL="https://www.fnac.com/SearchResult/ResultList.aspx?SCat=0&Search=QUERY_STRING&sft=1&sa=0",O.PRODUCT_START_STRING='<div class="clearfix Article-item',O.BASE_URL="https://www.fnac.com";class N extends m{constructor(e){super(e),this.onlineShopName="Onatera"}searchProductsForNameOrId(e,r){let o=JSON.stringify(N.JSON_QUERY);return o=o.replace(/QUERY_STRING/g,encodeURIComponent(e)),o=JSON.parse(o),this.requestWithProxy("POST",N.SEARCH_ONLINE_URL,f.CORSPROXY_IO,{body:o,responseType:"json",observe:"body"}).then(n=>{"string"==typeof n&&(n=JSON.parse(n));const s=new Array,i=n.results;if(i.length>0)for(const d of i){const a=d.hits;if(null!=a)for(const l of a)if(1==l.is_active){const u=l.name+" "+l.brand_name+" ";if(null!=l.variants)for(const p of l.variants){const h=new x;h.productPrice=p.price/100,h.outOfStock=!p.hasStock,h.currencyCode="EUR",h.productName=u+p.name,h.productDescription=p.shortDescription??p.description,h.productId=p.productVariantId.toString(),h.productUrl=N.BASE_URL+p.url,h.productImageUrl=N.IMAGE_BASE_URL+p.picture_path,this.checkScrappedProduct(e,h),s.push(h)}}}return s})}}N.SEARCH_ONLINE_URL="https://f75bb6q2sy-dsn.algolia.net/1/indexes/*/queries?x-algolia-agent=Algolia+for+JavaScript+%284.11.0%29%3B+Browser+%28lite%29%3B+instantsearch.js+%284.41.0%29%3B+Vue+%282.6.14%29%3B+Vue+InstantSearch+%284.3.3%29%3B+JS+Helper+%283.8.2%29&x-algolia-api-key=f319f4e4b15d239ba0509b3c6c4a0ecd&x-algolia-application-id=F75BB6Q2SY",N.BASE_URL="https://onatera.com",N.IMAGE_BASE_URL="https://media.onatera.com/cache/product_image_listing_DM/",N.JSON_QUERY={requests:[{indexName:"intl.product.fr.fr",params:"clickAnalytics=true&facets=%5B%5D&hitsPerPage=0&query=QUERY_STRING&tagFilters=&userToken=anonymous_09f81bae3a73d5bcb1582423816110b7"},{indexName:"intl.product.fr.fr",params:"clickAnalytics=true&facets=%5B%5D&highlightPostTag=__%2Fais-highlight__&highlightPreTag=__ais-highlight__&hitsPerPage=6&query=QUERY_STRING&tagFilters=&userToken=anonymous_09f81bae3a73d5bcb1582423816110b7"},{indexName:"intl.category.fr.fr",params:"clickAnalytics=true&facets=%5B%5D&highlightPostTag=__%2Fais-highlight__&highlightPreTag=__ais-highlight__&hitsPerPage=3&numericFilters=ref_count%20%3E%200&query=QUERY_STRING&tagFilters=&userToken=anonymous_09f81bae3a73d5bcb1582423816110b7"},{indexName:"intl.brand.fr.fr",params:"clickAnalytics=true&facets=%5B%5D&highlightPostTag=__%2Fais-highlight__&highlightPreTag=__ais-highlight__&hitsPerPage=3&numericFilters=product_count%20%3E%200&query=QUERY_STRING&tagFilters=&userToken=anonymous_09f81bae3a73d5bcb1582423816110b7"},{indexName:"intl.active.fr.fr",params:"clickAnalytics=true&facets=%5B%5D&highlightPostTag=__%2Fais-highlight__&highlightPreTag=__ais-highlight__&hitsPerPage=3&numericFilters=product_count%20%3E%200&query=QUERY_STRING&tagFilters=&userToken=anonymous_09f81bae3a73d5bcb1582423816110b7"},{indexName:"intl.content.for_recipes.fr.fr",params:"clickAnalytics=true&facetFilters=%5B%22type%3Adiy%22%5D&facets=%5B%5D&highlightPostTag=__%2Fais-highlight__&highlightPreTag=__ais-highlight__&hitsPerPage=3&query=QUERY_STRING&tagFilters=&userToken=anonymous_09f81bae3a73d5bcb1582423816110b7"}]};class k extends m{constructor(e){super(e),this.onlineShopName="Maxicoffee"}searchProductsForNameOrId(e,r){let o=JSON.stringify(k.JSON_QUERY);return o=o.replace("QUERY_STRING",e),o=JSON.parse(o),this.requestWithProxy("POST",k.SEARCH_ONLINE_URL,f.CORSPROXY_IO,{body:o,responseType:"json",observe:"body"}).then(n=>{"string"==typeof n&&(n=JSON.parse(n));const s=new Array,i=n.data.items.p;if(i.length>0)for(const d of i){const a=new x;a.productPrice=d.prcn,a.currencyCode="EUR",a.productName=d.ttl,a.productDescription=void 0,a.productId=d.id,a.productUrl=d.lnk,a.productImageUrl=d.img,a.outOfStock="in stock"===d.avl,this.checkScrappedProduct(e,a),s.push(a)}return s})}}k.SEARCH_ONLINE_URL="https://na.search.sensefuel.live/searchf/4147d2a1-7a21-4697-8a4c-0e25183f3ce9",k.JSON_QUERY={acp:{},suggest:{},key:"1678529428523-0-AskResult",parentKey:null,terms:{expression:"QUERY_STRING",inputSource:"keyboard",intentDetection:{}},trackFingerPrint:{tracks:[],environmentId:"333"},items:{from:0,size:30,bypassSpellcheck:!1},prefixQuery:{},filters:{},scopes:[],spotlights:[],sort:null,needShortcuts:!0,userIds:{id:null,previousId:null,custId:null,isAuthenticated:!1},sellerId:"France m\xe9tropolitaine",kickerContents:{size:6},contents:{from:0,size:30,playOnIntent:["nlu|content"]},references:{size:32}};class E{constructor(e,r,o){this.httpClient=e,this.modelMgr=r,this.storeMgr=o,this.listOfScrappers=new Map,this.shopTypeNames=new Array,null==this.modelMgr&&(this.modelMgr=S.dtcde.getModelManager()),null==this.storeMgr&&(this.storeMgr=S.dtcde.getStoreManager()),this.addScrapper(new R(e)),this.addScrapper(new v(e)),this.addScrapper(new A(e)),this.addScrapper(new D(e)),this.addScrapper(new N(e)),this.addScrapper(new w(e)),this.addScrapper(new I(e)),this.addScrapper(new T(e)),this.addScrapper(new O(e)),this.addScrapper(new P(e)),this.addScrapper(new k(e))}addScrapper(e){this.listOfScrappers.set(e.getOnlineShopName(),e),this.shopTypeNames.push(e.getOnlineShopName())}getListOfShopTypes(){return this.shopTypeNames}searchProducts(e,r){var o=this;return(0,y.Z)(function*(){const n=o.listOfScrappers.get(yield o.getShopTypeNameOf(r));if(null==n)throw new Error("Shop type "+r+" not found");return n.searchProductsForNameOrId(e,!1)})()}findPrice(e,r,o,n){var s=this;return(0,y.Z)(function*(){if(null==e)throw new Error("No product to get price for");const i=s.listOfScrappers.get(yield s.getShopTypeNameOf(r));if(null==i)throw new Error("Shop type "+r+" not found");null==n&&(n=s.modelMgr.findAtPosition(o,!1));let d=null,a=null;if(null!=n?.fields)for(const u of Object.values(n.fields))if("Price"===u.type){d=u,a=e[d.name];break}null==d&&(d=n,a=e);const l=s.findProductId(a);return null==l||null==a?Promise.reject("Product Id not found in "+e):null!=a?(a.lastCheckDate=new Date,i.updatePrice({productId:l,productName:a.nameInShop??null,productUrl:a.urlInShop}).then(u=>null!=u&&null!=a?(a.cost=m.toMoneyAmount(u),a.outOfStock=u.outOfStock,a.inError=!1,a):null).catch(u=>{throw console.error("Cannot update price for "+a?.nameInShop+" because of "+u.toString()),u})):Promise.reject("Impossible to be there...")})()}findProductId(e){return null!=e?.idInShop?e?.idInShop:null!=e?.productId?e?.productId:null!=e?.id?e?.id:null}findProductName(e){return null!=e?.nameInShop?e?.nameInShop:null!=e?.productName?e?.productName:null!=e?.name?e?.name:null}updatePriceIfPossible(e,r){var o=this;return(0,y.Z)(function*(){if(null!=e.idInShop&&null!=e.shop&&("string"==typeof e.lastCheckDate&&(e.lastCheckDate=new Date(e.lastCheckDate)),null==e.lastCheckDate||e.lastCheckDate.getTime()+E.DONT_UPDATE_UNTIL_DELAY_MS<(new Date).getTime())){const n=yield o.findPrice(e,e.shop,r);return null!=n&&(n.priceDate=new Date),n}return null})()}getShopTypeNameOf(e){const o=this.modelMgr.queryModelToSingle("$.creation.entities[?(@.name=='"+Q.SHOP_ENTITY_NAME+"')]").pointer;return null==o?Promise.resolve(e):(0,U.firstValueFrom)(this.storeMgr.searchEntities(o,{name:"Shop",value:e,operator:S.DontCodeStoreCriteriaOperator.EQUALS})).then(n=>1!=n?.length?e:null!=n[0].Type?n[0].Type:e)}}E.DONT_UPDATE_UNTIL_DELAY_MS=36e5,E.\u0275fac=function(e){return new(e||E)(t.\u0275\u0275inject(G.HttpClient),t.\u0275\u0275inject(S.DontCodeModelManager,8),t.\u0275\u0275inject(S.DontCodeStoreManager,8))},E.\u0275prov=t.\u0275\u0275defineInjectable({token:E,factory:E.\u0275fac,providedIn:"root"});var W=_(49162),j=_(3134),X=_(84017),q=_(24504),z=_(51411),Z=_(4209),$=_(60666),K=_(82046);function te(c,e){if(1&c){const r=t.\u0275\u0275getCurrentView();t.\u0275\u0275text(0,"Select product, or "),t.\u0275\u0275elementStart(1,"button",3),t.\u0275\u0275listener("click",function(){t.\u0275\u0275restoreView(r);const n=t.\u0275\u0275nextContext();return t.\u0275\u0275resetView(n.notFound())}),t.\u0275\u0275elementEnd()}}function re(c,e){if(1&c&&t.\u0275\u0275element(0,"img",8),2&c){const r=t.\u0275\u0275nextContext(2).$implicit;t.\u0275\u0275property("src",r.productImageUrl,t.\u0275\u0275sanitizeUrl)}}function ne(c,e){if(1&c&&(t.\u0275\u0275template(0,re,1,1,"img",7),t.\u0275\u0275text(1,"\xa0 ")),2&c){const r=t.\u0275\u0275nextContext().$implicit;t.\u0275\u0275property("ngIf",null!==r.productImageUrl)}}function oe(c,e){if(1&c){const r=t.\u0275\u0275getCurrentView();t.\u0275\u0275elementStart(0,"button",9),t.\u0275\u0275listener("click",function(){t.\u0275\u0275restoreView(r);const n=t.\u0275\u0275nextContext().$implicit,s=t.\u0275\u0275nextContext();return t.\u0275\u0275resetView(s.selectionOf(n))}),t.\u0275\u0275elementEnd()}}function ie(c,e){if(1&c&&(t.\u0275\u0275elementStart(0,"div",4)(1,"p-card",5),t.\u0275\u0275template(2,ne,2,1,"ng-template",1),t.\u0275\u0275elementStart(3,"p")(4,"small"),t.\u0275\u0275text(5),t.\u0275\u0275elementEnd()(),t.\u0275\u0275element(6,"p"),t.\u0275\u0275elementStart(7,"h2"),t.\u0275\u0275text(8),t.\u0275\u0275elementEnd(),t.\u0275\u0275template(9,oe,1,0,"ng-template",6),t.\u0275\u0275elementEnd()()),2&c){const r=e.$implicit,o=t.\u0275\u0275nextContext();t.\u0275\u0275advance(1),t.\u0275\u0275property("header",r.productName),t.\u0275\u0275advance(4),t.\u0275\u0275textInterpolate(r.productDescription),t.\u0275\u0275advance(3),t.\u0275\u0275textInterpolate(o.localizedAmount(r))}}class V{constructor(e){this.ref=e,this.listOfProducts=new Array,this.selected=new t.EventEmitter}selectionOf(e){this.selected.next(e)}localizedAmount(e){return null==e.productPrice||null==e.currencyCode?e.currencyCode??"":Intl.NumberFormat(globalThis?.window?.navigator.language??"en-US",{style:"currency",currency:e.currencyCode}).format(e.productPrice)}notFound(){this.selected.next(null)}}V.\u0275fac=function(e){return new(e||V)(t.\u0275\u0275directiveInject(t.ChangeDetectorRef))},V.\u0275cmp=t.\u0275\u0275defineComponent({type:V,selectors:[["dontcode-commerce-product-selection"]],inputs:{listOfProducts:"listOfProducts"},outputs:{selected:"selected"},decls:3,vars:3,consts:[["layout","grid",3,"value","rows","paginator"],["pTemplate","header"],["pTemplate","gridItem"],["label","Not found","icon","pi pi-delete-left","pButton","",3,"click"],[1,"col-6","md:col-3","flex","align-items-stretch"],[3,"header"],["pTemplate","footer"],[3,"src",4,"ngIf"],[3,"src"],["label","Select","icon","pi pi-check","pButton","",3,"click"]],template:function(e,r){1&e&&(t.\u0275\u0275elementStart(0,"p-dataView",0),t.\u0275\u0275template(1,te,2,0,"ng-template",1),t.\u0275\u0275template(2,ie,10,3,"ng-template",2),t.\u0275\u0275elementEnd()),2&e&&t.\u0275\u0275property("value",r.listOfProducts)("rows",4)("paginator",!0)},dependencies:[b.NgIf,j.PrimeTemplate,q.ButtonDirective,$.DataView,K.Card]});const ae=["inlineView"],se=["fullEditView"];function ce(c,e){1&c&&t.\u0275\u0275elementContainer(0)}function le(c,e){if(1&c&&(t.\u0275\u0275elementContainerStart(0),t.\u0275\u0275elementStart(1,"a",5),t.\u0275\u0275template(2,ce,1,0,"ng-container",6),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementContainerEnd()),2&c){const r=t.\u0275\u0275nextContext(2),o=t.\u0275\u0275reference(4);t.\u0275\u0275advance(1),t.\u0275\u0275propertyInterpolate("href",r.value.urlInShop,t.\u0275\u0275sanitizeUrl),t.\u0275\u0275advance(1),t.\u0275\u0275property("ngTemplateOutlet",o)}}function pe(c,e){1&c&&t.\u0275\u0275elementContainer(0)}function de(c,e){if(1&c&&(t.\u0275\u0275elementContainerStart(0),t.\u0275\u0275template(1,pe,1,0,"ng-container",6),t.\u0275\u0275elementContainerEnd()),2&c){t.\u0275\u0275nextContext(2);const r=t.\u0275\u0275reference(4);t.\u0275\u0275advance(1),t.\u0275\u0275property("ngTemplateOutlet",r)}}function ue(c,e){if(1&c&&(t.\u0275\u0275elementStart(0,"span",3),t.\u0275\u0275template(1,le,3,2,"ng-container",4),t.\u0275\u0275template(2,de,2,1,"ng-container",4),t.\u0275\u0275elementEnd()),2&c){const r=t.\u0275\u0275nextContext();let o;t.\u0275\u0275propertyInterpolate2("pTooltip","Price Date: ",null!==(o=null==r.value?null:r.value.priceDate)&&void 0!==o?o:"Unknown","<br/>Shop:",null!==(o=null==r.value?null:r.value.shop)&&void 0!==o?o:"Unknown",""),t.\u0275\u0275property("escape",!1),t.\u0275\u0275advance(1),t.\u0275\u0275property("ngIf",null==r.value?null:r.value.urlInShop),t.\u0275\u0275advance(1),t.\u0275\u0275property("ngIf",!(null!=r.value&&r.value.urlInShop))}}function fe(c,e){1&c&&t.\u0275\u0275element(0,"button",8)}function me(c,e){1&c&&t.\u0275\u0275elementContainer(0)}function _e(c,e){if(1&c&&(t.\u0275\u0275template(0,fe,1,0,"button",7),t.\u0275\u0275template(1,me,1,0,"ng-container",6),t.\u0275\u0275text(2,"\xa0\n")),2&c){const r=t.\u0275\u0275nextContext();t.\u0275\u0275property("ngIf",null==r.value?null:r.value.inError),t.\u0275\u0275advance(1),t.\u0275\u0275property("ngTemplateOutlet",r.subFieldInlineViewTemplate("cost"))}}function he(c,e){1&c&&t.\u0275\u0275elementContainer(0)}function ge(c,e){1&c&&t.\u0275\u0275element(0,"button",8)}function Ce(c,e){1&c&&t.\u0275\u0275elementContainer(0)}function Se(c,e){1&c&&t.\u0275\u0275elementContainer(0)}function xe(c,e){1&c&&t.\u0275\u0275elementContainer(0)}function Pe(c,e){if(1&c&&(t.\u0275\u0275elementStart(0,"a",5),t.\u0275\u0275text(1,"Try in the browser"),t.\u0275\u0275elementEnd()),2&c){const r=t.\u0275\u0275nextContext(5);t.\u0275\u0275property("href",r.parsingError.url,t.\u0275\u0275sanitizeUrl)}}function ye(c,e){if(1&c&&(t.\u0275\u0275text(0),t.\u0275\u0275template(1,Pe,2,1,"a",22)),2&c){const r=t.\u0275\u0275nextContext(4);let o;t.\u0275\u0275textInterpolate1("Error : ",null!==(o=r.parsingError.status)&&void 0!==o?o:":"+r.parsingError.message,"\xa0 "),t.\u0275\u0275advance(1),t.\u0275\u0275property("ngIf",r.parsingError.url)}}function Ie(c,e){1&c&&(t.\u0275\u0275elementContainerStart(0),t.\u0275\u0275elementStart(1,"p-messages",20),t.\u0275\u0275template(2,ye,2,2,"ng-template",21),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementContainerEnd())}function Te(c,e){if(1&c){const r=t.\u0275\u0275getCurrentView();t.\u0275\u0275elementContainerStart(0),t.\u0275\u0275elementStart(1,"div",23)(2,"dontcode-commerce-product-selection",24),t.\u0275\u0275listener("selected",function(n){t.\u0275\u0275restoreView(r);const s=t.\u0275\u0275nextContext(3);return t.\u0275\u0275resetView(s.selectedProduct(n))}),t.\u0275\u0275elementEnd()(),t.\u0275\u0275elementContainerEnd()}if(2&c){const r=t.\u0275\u0275nextContext(3);t.\u0275\u0275advance(1),t.\u0275\u0275property("id",r.name+"-select"),t.\u0275\u0275advance(1),t.\u0275\u0275property("listOfProducts",r.listOfSelectableProducts)}}function Oe(c,e){if(1&c){const r=t.\u0275\u0275getCurrentView();t.\u0275\u0275elementContainerStart(0,10),t.\u0275\u0275elementStart(1,"div",11)(2,"div",12)(3,"span",13)(4,"input",14),t.\u0275\u0275listener("input",function(n){t.\u0275\u0275restoreView(r);const s=t.\u0275\u0275nextContext(2);return t.\u0275\u0275resetView(s.productNameChanged(n))}),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementStart(5,"label",15),t.\u0275\u0275text(6,"Product Name"),t.\u0275\u0275elementEnd()()(),t.\u0275\u0275elementStart(7,"div",12),t.\u0275\u0275template(8,he,1,0,"ng-container",6),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementStart(9,"div",12)(10,"div",16),t.\u0275\u0275template(11,ge,1,0,"button",7),t.\u0275\u0275elementStart(12,"button",17),t.\u0275\u0275listener("click",function(){t.\u0275\u0275restoreView(r);const n=t.\u0275\u0275nextContext(2);return t.\u0275\u0275resetView(n.updatePrice())}),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementStart(13,"div",18),t.\u0275\u0275text(14,"Price:\xa0 "),t.\u0275\u0275template(15,Ce,1,0,"ng-container",6),t.\u0275\u0275elementEnd()()(),t.\u0275\u0275elementStart(16,"div",12),t.\u0275\u0275text(17,"Date of Price:\xa0 "),t.\u0275\u0275template(18,Se,1,0,"ng-container",6),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementStart(19,"div",12),t.\u0275\u0275text(20,"Product Id: "),t.\u0275\u0275element(21,"input",19),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementStart(22,"div",12),t.\u0275\u0275text(23,"Product url: "),t.\u0275\u0275template(24,xe,1,0,"ng-container",6),t.\u0275\u0275elementEnd(),t.\u0275\u0275template(25,Ie,3,0,"ng-container",4),t.\u0275\u0275template(26,Te,3,2,"ng-container",4),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementContainerEnd()}if(2&c){const r=t.\u0275\u0275nextContext(2);t.\u0275\u0275property("formGroup",r.form),t.\u0275\u0275advance(4),t.\u0275\u0275property("id",r.name+"-name"),t.\u0275\u0275advance(1),t.\u0275\u0275property("for",r.name+"-name"),t.\u0275\u0275advance(3),t.\u0275\u0275property("ngTemplateOutlet",r.subFieldFullEditTemplate("shop")),t.\u0275\u0275advance(3),t.\u0275\u0275property("ngIf",null==r.value?null:r.value.inError),t.\u0275\u0275advance(1),t.\u0275\u0275property("disabled",r.cannotUpdatePrice()),t.\u0275\u0275advance(3),t.\u0275\u0275property("ngTemplateOutlet",r.subFieldFullEditTemplate("cost")),t.\u0275\u0275advance(3),t.\u0275\u0275property("ngTemplateOutlet",r.subFieldFullEditTemplate("priceDate")),t.\u0275\u0275advance(6),t.\u0275\u0275property("ngTemplateOutlet",r.subFieldFullEditTemplate("urlInShop")),t.\u0275\u0275advance(1),t.\u0275\u0275property("ngIf",r.parsingError),t.\u0275\u0275advance(1),t.\u0275\u0275property("ngIf",r.productSelectionMode)}}function Ne(c,e){if(1&c&&t.\u0275\u0275template(0,Oe,27,11,"ng-container",9),2&c){const r=t.\u0275\u0275nextContext();t.\u0275\u0275property("ngIf",r.form)}}class L extends C.AbstractDynamicLoaderComponent{constructor(e,r,o,n){super(e,o,n),this.priceFinder=r,this.parsingError=null,this.productSelectionMode=!1,this.productNameLinked=!1,this.listOfSelectableProducts=new Array,this.defineSubField("cost","Other currency"),this.defineSubField("priceDate","Date & Time"),this.defineSubField("shop","Shop"),this.defineSubField("urlInShop","Website (url)"),this.value={}}providesTemplates(e){return new C.TemplateList(this.inlineView,null,this.fullEditView)}canProvide(e){return new C.PossibleTemplateList(!0,!1,!0)}setValue(e){super.setValue(e),null!=e&&this.priceFinder.updatePriceIfPossible(e,this.parentPosition??"").then(()=>{this.parsingError=null}).catch(()=>{e.inError=!0}),this.enableProductNameLookup()}createAndRegisterFormControls(){let e=new g.FormControl(null,{updateOn:"blur"});this.form.registerControl("nameInShop",e),e=new g.FormControl({value:null,disabled:!0},{updateOn:"blur"}),this.form.registerControl("idInShop",e)}cannotUpdatePrice(){return!(null!=this.value&&null!=this.value.shop&&null!=this.value.nameInShop)}updatePrice(){this.parsingError=null,null!=this.value&&(null==this.value.idInShop?null!=this.value.nameInShop&&null!=this.value.shop&&this.priceFinder.searchProducts(this.value.nameInShop,this.value.shop).then(e=>{null!=e&&(this.listOfSelectableProducts=e,this.productSelectionMode=!0,this.ref.markForCheck(),this.ref.detectChanges())}).catch(e=>{this.parsingError=this.translateToError(e),this.ref.markForCheck(),this.ref.detectChanges()}):null!=this.value.shop&&this.priceFinder.findPrice(this.value,this.value.shop,this.parentPosition??"").then(e=>{null!=e&&(this.value.inError=!1,this.setSubFieldValue("cost",e.cost),this.setSubFieldValue("priceDate",new Date))}).catch(e=>{this.value.inError=!0,this.parsingError=this.translateToError(e),this.ref.markForCheck(),this.ref.detectChanges()}))}selectedProduct(e){this.productSelectionMode=!1,null!=e?(this.value.idInShop=e.productId,this.hydrateValueToForm(),this.setSubFieldValue("cost",m.toMoneyAmount(e)),this.setSubFieldValue("priceDate",new Date),this.setSubFieldValue("urlInShop",e.productUrl),this.value.cost=this.getSubFieldValue("cost"),this.value.priceDate=this.getSubFieldValue("priceDate"),this.value.urlInShop=this.getSubFieldValue("urlInShop")):this.clearProduct()}applyComponentToSubField(e,r,o){const n=super.applyComponentToSubField(e,r,o);if("shop"==o){const s=e.selectEventSourceFor(C.DynamicEventType.VALUE_CHANGE);null!=s&&this.subscriptions.add(s.eventSource.subscribe({next:i=>{this.clearProduct()}}))}return n}clearProduct(){this.productSelectionMode=!1,this.parsingError=null,delete this.value.cost,this.setSubFieldValue("cost",void 0),delete this.value.priceDate,this.setSubFieldValue("priceDate",void 0),delete this.value.urlInShop,this.setSubFieldValue("urlInShop",void 0),delete this.value.idInShop,this.form.get("idInShop")?.setValue(null,{emitEvent:!1})}productNameChanged(e){this.clearProduct()}enableProductNameLookup(){if(null==this.value?.nameInShop&&null!=this.parentForm&&!this.productNameLinked){const e=this.guessProductParentComponent();null!=e&&(this.productNameLinked=!0,this.subscriptions.add(e.valueChanges.subscribe(r=>{const o=this.form.get("nameInShop");(null==o.value||""==o.value||r.startsWith(o.value))&&(null==this.value&&(this.value={}),this.value.nameInShop=r,o.setValue(r,{emitEvent:!1,emitModelToViewChange:!0}))})))}}guessProductParentComponent(){if(null!=this.parentForm){const e=S.DontCodeModelManager.guessNamePropertyOfObject(this.parentForm.controls);if(null!=e)return this.parentForm.controls[e]}return null}translateToError(e){const r={};return"string"==typeof e?(r.message=e,r):(null!=e.status&&(r.status=e.status),null!=e.statusText?r.message=e.statusText:null!=e.message&&(r.message=e.message),null!=e.url&&(r.url=e.url),null!=e.error&&(r.content=e.error),null==r.message&&(r.message=e.toString()),r)}}L.\u0275fac=function(e){return new(e||L)(t.\u0275\u0275directiveInject(C.ComponentLoaderService),t.\u0275\u0275directiveInject(E),t.\u0275\u0275directiveInject(t.Injector),t.\u0275\u0275directiveInject(t.ChangeDetectorRef))},L.\u0275cmp=t.\u0275\u0275defineComponent({type:L,selectors:[["dontcode-commerce-price"]],viewQuery:function(e,r){if(1&e&&(t.\u0275\u0275viewQuery(ae,7),t.\u0275\u0275viewQuery(se,7)),2&e){let o;t.\u0275\u0275queryRefresh(o=t.\u0275\u0275loadQuery())&&(r.inlineView=o.first),t.\u0275\u0275queryRefresh(o=t.\u0275\u0275loadQuery())&&(r.fullEditView=o.first)}},features:[t.\u0275\u0275InheritDefinitionFeature],decls:7,vars:0,consts:[["inlineView",""],["priceView",""],["fullEditView",""],[3,"pTooltip","escape"],[4,"ngIf"],["target","_blank",3,"href"],[4,"ngTemplateOutlet"],["pButton","","type","button","class","p-button-rounded p-button-outlined p-button-danger","icon","pi pi-exclamation-triangle","pTooltip","Error reading this product price",4,"ngIf"],["pButton","","type","button","icon","pi pi-exclamation-triangle","pTooltip","Error reading this product price",1,"p-button-rounded","p-button-outlined","p-button-danger"],[3,"formGroup",4,"ngIf"],[3,"formGroup"],[1,"formgrid","grid"],[1,"field","col-12","md:col-6"],[1,"p-float-label"],["type","text","pInputText","","formControlName","nameInShop",1,"w-full",3,"id","input"],[3,"for"],[1,"flex","align-items-center"],["name","FetchPrice","pButton","","pRipple","","type","button","icon","pi pi-sync",1,"flex","flex-initial","align-items-center","p-button-rounded","p-button-text",3,"disabled","click"],[1,"flex","align-items-center","flex-1",2,"margin-top","0.5rem"],["type","text","pInputText","","formControlName","idInShop",1,"w-full"],["severity","error"],["pTemplate",""],["target","_blank",3,"href",4,"ngIf"],[1,"field","col-12",3,"id"],[3,"listOfProducts","selected"]],template:function(e,r){1&e&&(t.\u0275\u0275element(0,"dtcde-dynamic"),t.\u0275\u0275template(1,ue,3,5,"ng-template",null,0,t.\u0275\u0275templateRefExtractor),t.\u0275\u0275template(3,_e,3,2,"ng-template",null,1,t.\u0275\u0275templateRefExtractor),t.\u0275\u0275template(5,Ne,1,1,"ng-template",null,2,t.\u0275\u0275templateRefExtractor))},dependencies:[b.NgIf,b.NgTemplateOutlet,C.DynamicInsertPoint,g.DefaultValueAccessor,g.NgControlStatus,g.NgControlStatusGroup,g.FormGroupDirective,g.FormControlName,W.InputText,j.PrimeTemplate,X.Ripple,q.ButtonDirective,z.Tooltip,Z.Messages,V]});class M extends C.PluginBaseComponent{constructor(e,r,o){super(e,r,o)}providesTemplates(e){throw new Error("Method not implemented.")}canProvide(e){throw new Error("Method not implemented.")}handleChange(e){}}M.\u0275fac=function(e){return new(e||M)(t.\u0275\u0275directiveInject(C.ComponentLoaderService),t.\u0275\u0275directiveInject(t.Injector),t.\u0275\u0275directiveInject(t.ChangeDetectorRef))},M.\u0275cmp=t.\u0275\u0275defineComponent({type:M,selectors:[["dontcode-commerce-price-compare"]],features:[t.\u0275\u0275InheritDefinitionFeature],decls:2,vars:0,template:function(e,r){1&e&&(t.\u0275\u0275elementStart(0,"h1"),t.\u0275\u0275text(1,"Hello from PriceCompareComponent !"),t.\u0275\u0275elementEnd())}});var Ee=_(36520),J=_(46674);function be(c,e){if(1&c&&t.\u0275\u0275text(0),2&c){const r=t.\u0275\u0275nextContext();t.\u0275\u0275textInterpolate(r.value)}}function ve(c,e){if(1&c&&(t.\u0275\u0275elementStart(0,"div"),t.\u0275\u0275text(1),t.\u0275\u0275elementEnd()),2&c){const r=t.\u0275\u0275nextContext(4);t.\u0275\u0275advance(1),t.\u0275\u0275textInterpolate1(" ",r.value," ")}}function we(c,e){if(1&c&&t.\u0275\u0275template(0,ve,2,1,"div",7),2&c){const r=t.\u0275\u0275nextContext(3);t.\u0275\u0275property("ngIf",r.value)}}function Re(c,e){1&c&&t.\u0275\u0275text(0),2&c&&t.\u0275\u0275textInterpolate1(" ",e.$implicit," ")}function Ue(c,e){if(1&c){const r=t.\u0275\u0275getCurrentView();t.\u0275\u0275elementContainerStart(0,3),t.\u0275\u0275elementStart(1,"p-dropdown",4),t.\u0275\u0275listener("onChange",function(n){t.\u0275\u0275restoreView(r);const s=t.\u0275\u0275nextContext(2);return t.\u0275\u0275resetView(s.valueChanged(n))}),t.\u0275\u0275template(2,we,1,1,"ng-template",5),t.\u0275\u0275template(3,Re,1,1,"ng-template",6),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementContainerEnd()}if(2&c){const r=t.\u0275\u0275nextContext(2);t.\u0275\u0275property("formGroup",r.form),t.\u0275\u0275advance(1),t.\u0275\u0275property("options",r.options)("formControlName",r.name)("filter",!0)("showClear",!0)("lazy",!0)}}function Ae(c,e){if(1&c&&t.\u0275\u0275template(0,Ue,4,6,"ng-container",2),2&c){const r=t.\u0275\u0275nextContext();t.\u0275\u0275property("ngIf",r.form)}}class Y extends C.AbstractReferenceComponent{constructor(e,r){super(e,r)}ngOnInit(){this.setTargetEntitiesWithName(Q.SHOP_ENTITY_NAME,"Shop")}setValue(e){if(null==e){const r=this.getForm(),o=r?.parent;if(null!=o&&!Array.isArray(o.controls))for(const n in o.controls)if(o.controls[n]===r){e=n;break}}super.setValue(e)}}Y.\u0275fac=function(e){return new(e||Y)(t.\u0275\u0275directiveInject(S.DontCodeModelManager,8),t.\u0275\u0275directiveInject(S.DontCodeStoreManager,8))},Y.\u0275cmp=t.\u0275\u0275defineComponent({type:Y,selectors:[["dontcode-commerce-shop"]],features:[t.\u0275\u0275InheritDefinitionFeature],decls:4,vars:0,consts:[["inlineView",""],["fullEditView",""],[3,"formGroup",4,"ngIf"],[3,"formGroup"],["placeholder","Select a shop",3,"options","formControlName","filter","showClear","lazy","onChange"],["pTemplate","selectedItem"],["pTemplate","item"],[4,"ngIf"]],template:function(e,r){1&e&&(t.\u0275\u0275template(0,be,1,1,"ng-template",null,0,t.\u0275\u0275templateRefExtractor),t.\u0275\u0275template(2,Ae,1,1,"ng-template",null,1,t.\u0275\u0275templateRefExtractor))},dependencies:[b.NgIf,g.NgControlStatus,g.NgControlStatusGroup,g.FormGroupDirective,g.FormControlName,J.Dropdown,j.PrimeTemplate]});var De=_(91682);const Fe=["inlineView"],Ge=["fullEditView"];function ke(c,e){if(1&c&&t.\u0275\u0275text(0),2&c){const r=t.\u0275\u0275nextContext();t.\u0275\u0275textInterpolate(r.displayableValue())}}function Le(c,e){if(1&c){const r=t.\u0275\u0275getCurrentView();t.\u0275\u0275elementContainerStart(0,3),t.\u0275\u0275elementStart(1,"span",4)(2,"p-dropdown",5),t.\u0275\u0275listener("onChange",function(n){t.\u0275\u0275restoreView(r);const s=t.\u0275\u0275nextContext(2);return t.\u0275\u0275resetView(s.valueChanged(n))}),t.\u0275\u0275elementEnd()(),t.\u0275\u0275elementContainerEnd()}if(2&c){const r=t.\u0275\u0275nextContext(2);t.\u0275\u0275property("formGroup",r.form),t.\u0275\u0275advance(2),t.\u0275\u0275property("options",r.shopTypes)("formControlName",r.name)}}function Me(c,e){if(1&c&&t.\u0275\u0275template(0,Le,3,3,"ng-container",2),2&c){const r=t.\u0275\u0275nextContext();t.\u0275\u0275property("ngIf",r.form)}}class H extends C.AbstractDynamicComponent{constructor(e){super(),this.priceFinder=e,this.shopTypes=new Array,this.valueChange=new t.EventEmitter,this.shopTypes=this.priceFinder.getListOfShopTypes()}createAndRegisterFormControls(){this.form.registerControl(this.name,new g.FormControl(null,{updateOn:"change"}))}providesTemplates(e){return new C.TemplateList(this.inlineView,null,this.fullEditView)}canProvide(e){return new C.PossibleTemplateList(!0,!1,!0)}displayableValue(){return C.AbstractDynamicComponent.toBeautifyString(this.value)??""}listEventSources(){const e=super.listEventSources();return e.push(new C.BaseDynamicEventSource("Value",C.DynamicEventType.VALUE_CHANGE,this.valueChange.asObservable())),e}valueChanged(e){this.valueChange.emit(new C.BaseDynamicEvent("Value",C.DynamicEventType.VALUE_CHANGE,e.value))}}H.\u0275fac=function(e){return new(e||H)(t.\u0275\u0275directiveInject(E))},H.\u0275cmp=t.\u0275\u0275defineComponent({type:H,selectors:[["dontcode-commerce-shop-type"]],viewQuery:function(e,r){if(1&e&&(t.\u0275\u0275viewQuery(Fe,7),t.\u0275\u0275viewQuery(Ge,7)),2&e){let o;t.\u0275\u0275queryRefresh(o=t.\u0275\u0275loadQuery())&&(r.inlineView=o.first),t.\u0275\u0275queryRefresh(o=t.\u0275\u0275loadQuery())&&(r.fullEditView=o.first)}},outputs:{valueChange:"valueChange"},features:[t.\u0275\u0275InheritDefinitionFeature],decls:4,vars:0,consts:[["inlineView",""],["fullEditView",""],[3,"formGroup",4,"ngIf"],[3,"formGroup"],[1,"p-float-label"],["name","shop","placeholder","Please select a Shop",1,"w-full",3,"options","formControlName","onChange"]],template:function(e,r){1&e&&(t.\u0275\u0275template(0,ke,1,1,"ng-template",null,0,t.\u0275\u0275templateRefExtractor),t.\u0275\u0275template(2,Me,1,1,"ng-template",null,1,t.\u0275\u0275templateRefExtractor))},dependencies:[b.NgIf,g.NgControlStatus,g.NgControlStatusGroup,g.FormGroupDirective,g.FormControlName,J.Dropdown]});var Ye=_(7297);class F{constructor(){console.log("Commerce Plugin registering"),S.dtcde.registerPlugin(new Q)}exposedPreviewHandlers(){return new Map([["PriceComponent",L],["PriceCompareComponent",M],["ShopHandlerComponent",Y],["ShopTypeHandlerComponent",H]])}}F.\u0275fac=function(e){return new(e||F)},F.\u0275mod=t.\u0275\u0275defineNgModule({type:F,id:"dontcode-plugin/commerce"}),F.\u0275inj=t.\u0275\u0275defineInjector({imports:[b.CommonModule,C.PluginCommonModule.forRoot(),De.BasicModule,Ee.FieldsModule,g.ReactiveFormsModule,W.InputTextModule,g.FormsModule,J.DropdownModule,X.RippleModule,q.ButtonModule,$.DataViewModule,K.CardModule,z.TooltipModule,Ye.MessageModule,Z.MessagesModule]}),t.\u0275\u0275registerNgModuleType(F,"dontcode-plugin/commerce")},15861:(ee,B,_)=>{function b(g,S,G,U,x,m,f){try{var t=g[m](f),y=t.value}catch(R){return void G(R)}t.done?S(y):Promise.resolve(y).then(U,x)}function C(g){return function(){var S=this,G=arguments;return new Promise(function(U,x){var m=g.apply(S,G);function f(y){b(m,U,x,f,t,"next",y)}function t(y){b(m,U,x,f,t,"throw",y)}f(void 0)})}}_.d(B,{Z:()=>C})}}]);